<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>E-Rapor Guru - SMP ALBANNA</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üìù</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* BASE STYLES */
        body { font-family: 'Montserrat', sans-serif; background-color: #f3f4f6; }
        
        /* UI HELPERS */
        .fade-enter-active, .fade-leave-active { transition: opacity 0.3s ease; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
        .input-abcd:focus { ring: 2px solid #3b82f6; transform: scale(1.005); }
        .sticky-col { position: sticky; left: 0; z-index: 10; background-color: #f8fafc; border-right: 2px solid #e2e8f0; }
        .sticky-col-2 { position: sticky; left: 40px; z-index: 10; background-color: #f8fafc; border-right: 2px solid #e2e8f0; }

        /* EXCEL GRID STYLES */
        .excel-table th, .excel-table td { border: 1px solid #e2e8f0; }
        .excel-input { width: 100%; height: 100%; padding: 4px; border: none; outline: none; text-align: center; background: transparent; font-family: monospace; font-weight: bold; font-size: 11px; }
        .excel-input.text-left { text-align: left; padding-left: 8px; }
        .excel-input:focus { background: #eff6ff; box-shadow: inset 0 0 0 2px #3b82f6; }
        .input-error { background-color: #fee2e2 !important; color: #dc2626 !important; }

        /* Headers Colors */
        .header-lm { background-color: #f1f5f9; border-left: 2px solid #94a3b8; }
        .header-asas { background-color: #fff7ed; border-left: 2px solid #ea580c; }
        .header-avg { background-color: #ecfdf5; border-left: 2px solid #059669; }
        .header-rapor { background-color: #eff6ff; border-left: 2px solid #2563eb; color: #1e40af; }
        .header-ekskul-1 { background-color: #fff7ed; border-left: 2px solid #ea580c; color: #9a3412; }
        .header-ekskul-2 { background-color: #f0fdf4; border-left: 2px solid #16a34a; color: #166534; }
        .header-ekskul-3 { background-color: #eff6ff; border-left: 2px solid #2563eb; color: #1e40af; }
        .input-readonly { background-color: #f3f4f6; color: #4b5563; cursor: not-allowed; }

        /* --- LHBTS PRINT STYLES (STRICT) --- */
        @media print {
            @page { size: A4 landscape; margin: 10mm; }
            body * { visibility: hidden; }
            .print-area, .print-area * { visibility: visible; }
            .print-area { position: absolute; left: 0; top: 0; width: 100%; }
            .no-print { display: none !important; }
            * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
        }

        .lhbts-container {
            font-family: 'Roboto', sans-serif;
            font-size: 11pt;
            color: black;
            background: white;
            width: max-content; 
            min-width: 100%;
        }

        .lhbts-table { border-collapse: collapse; table-layout: fixed; }
        .lhbts-table td, .lhbts-table th { border: 1px solid black; padding: 2px; vertical-align: middle; overflow: hidden; word-wrap: break-word; }

        .bg-blue-excel { background-color: #C9DAF8 !important; }
        .bt-double { border-top: 3px double black !important; }
        .bb-double { border-bottom: 3px double black !important; }
        .no-border { border: none !important; }
        .text-center { text-align: center; }
        .text-left { text-align: left; }
        .font-bold { font-weight: bold; }
        .title-text { font-size: 18pt; font-weight: bold; }
        .nowrap-cell { white-space: nowrap !important; overflow: visible !important; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">

    <div id="app" class="flex h-screen overflow-hidden">
        
        <!-- SIDEBAR -->
        <div class="w-64 bg-slate-900 text-white flex flex-col h-full shadow-2xl z-20 shrink-0 no-print">
            <div class="p-6 text-center border-b border-slate-700 bg-slate-800">
                <h1 class="font-bold text-xl tracking-wider">E-RAPOR</h1>
                <p class="text-xs text-slate-400 mt-1">GURU & WALI KELAS</p>
            </div>
            
            <nav class="flex-1 p-4 space-y-2 overflow-y-auto">
                <div class="text-[10px] font-bold text-slate-500 uppercase mb-1 ml-2 tracking-wider">Guru Mapel</div>
                <button @click="currentTab='identitas'" :class="['w-full text-left px-4 py-3 rounded transition flex items-center gap-3', currentTab==='identitas'?'bg-blue-600 shadow-lg':'hover:bg-slate-800 text-slate-400']"><i class="fas fa-id-card w-5"></i> Identitas</button>
                <button @click="switchToTP" :class="['w-full text-left px-4 py-3 rounded transition flex items-center gap-3', currentTab==='tp'?'bg-blue-600 shadow-lg':'hover:bg-slate-800 text-slate-400']"><i class="fas fa-bullseye w-5"></i> Penyusunan TP</button>
                <button @click="switchToNilai" :class="['w-full text-left px-4 py-3 rounded transition flex items-center gap-3', currentTab==='nilai'?'bg-blue-600 shadow-lg':'hover:bg-slate-800 text-slate-400']"><i class="fas fa-edit w-5"></i> Input Nilai</button>
                
                <div class="border-t border-slate-700 my-2"></div>
                <div class="text-[10px] font-bold text-slate-500 uppercase mb-1 ml-2 tracking-wider">Wali Kelas</div>
                <button @click="switchToEkskul" :class="['w-full text-left px-4 py-3 rounded transition flex items-center gap-3', currentTab==='ekskul'?'bg-orange-600 shadow-lg':'hover:bg-slate-800 text-slate-400']"><i class="fas fa-futbol w-5"></i> Ekskul</button>
                <button @click="switchToKewalasan" :class="['w-full text-left px-4 py-3 rounded transition flex items-center gap-3', currentTab==='kewalasan'?'bg-teal-600 shadow-lg':'hover:bg-slate-800 text-slate-400']"><i class="fas fa-user-graduate w-5"></i> Kewalasan</button>
                <button @click="switchToKaih" :class="['w-full text-left px-4 py-3 rounded transition flex items-center gap-3', currentTab==='kaih'?'bg-cyan-600 shadow-lg':'hover:bg-slate-800 text-slate-400']"><i class="fas fa-star w-5"></i> 7 KAIH</button>
                
                <div class="border-t border-slate-700 my-2"></div>
                <button @click="currentTab='monitoring'" :class="['w-full text-left px-4 py-3 rounded transition flex items-center gap-3', currentTab==='monitoring'?'bg-indigo-600 shadow-lg':'hover:bg-slate-800 text-slate-400']"><i class="fas fa-chart-line w-5"></i> Monitoring</button>
                <button @click="switchToRekap" :class="['w-full text-left px-4 py-3 rounded transition flex items-center gap-3', currentTab==='rekap'?'bg-emerald-600 shadow-lg':'hover:bg-slate-800 text-slate-400']"><i class="fas fa-trophy w-5"></i> Rekapitulasi</button>
                <button @click="switchToRekapAkhir" :class="['w-full text-left px-4 py-3 rounded transition flex items-center gap-3', currentTab==='rekap_akhir'?'bg-purple-600 shadow-lg':'hover:bg-slate-800 text-slate-400']"><i class="fas fa-file-invoice w-5"></i> Rekap Akhir</button>
                
                <div class="border-t border-slate-700 my-2"></div>
                <button @click="switchToLHBTS" :class="['w-full text-left px-4 py-3 rounded transition flex items-center gap-3', currentTab==='lhbts'?'bg-blue-800 shadow-lg text-white':'hover:bg-slate-800 text-slate-400']">
                    <i class="fas fa-print w-5"></i> Cetak LHBTS
                </button>
            </nav>
            <div class="p-4 border-t border-slate-800"><a href="index.html" class="w-full text-center text-xs text-gray-400 hover:text-white font-bold flex items-center justify-center gap-2 p-2 hover:bg-slate-800 rounded transition"><i class="fas fa-home"></i> KEMBALI KE MENU</a></div>
        </div>

        <!-- MAIN CONTENT -->
        <div class="flex-1 flex flex-col h-full overflow-hidden bg-gray-50 relative">
            
            <!-- TOP BAR (NO PRINT) -->
            <div class="bg-white p-4 shadow-sm border-b flex justify-between items-center px-8 z-10 no-print">
                <div><h2 class="text-2xl font-bold text-slate-800 uppercase">{{ getPageTitle() }}</h2><p class="text-xs text-gray-500">{{ getPageSubtitle() }}</p></div>
                <button v-if="['identitas','tp','nilai','ekskul','kewalasan','kaih'].includes(currentTab)" @click="handleSaveButton" class="bg-green-600 text-white px-6 py-2 rounded-lg font-bold shadow hover:bg-green-700 transition flex items-center gap-2"><i class="fas fa-save"></i> SIMPAN PROGRES</button>
                <button v-if="currentTab === 'lhbts' && selectedClass" onclick="window.print()" class="bg-blue-600 text-white px-6 py-2 rounded-lg font-bold shadow hover:bg-blue-700 transition flex items-center gap-2"><i class="fas fa-print"></i> CETAK LHBTS</button>
                <button v-if="currentTab === 'rekap'" @click="exportRekapExcel" class="bg-emerald-600 text-white px-6 py-2 rounded-lg font-bold shadow hover:bg-emerald-700 transition flex items-center gap-2"><i class="fas fa-file-excel"></i> UNDUH EXCEL</button>
            </div>

            <!-- SCROLLABLE AREA -->
            <div class="flex-1 overflow-y-auto p-8 pb-32">
                
                <!-- 1. IDENTITAS -->
                <transition name="fade">
                    <div v-if="currentTab === 'identitas'" class="no-print">
                         <div class="bg-white p-8 rounded-xl shadow-lg border border-indigo-100 max-w-3xl mx-auto mt-10">
                            <h3 class="text-xl font-bold text-slate-800 text-center mb-6">Lengkapi Data Awal</h3>
                            <div class="space-y-4">
                                <select v-model="identitas.mapel" class="w-full p-3 border rounded"><option value="" disabled>-- Pilih Mapel --</option><option v-for="m in mapelList" :value="m">{{ m }}</option></select>
                                <select v-model="identitas.jenjang" class="w-full p-3 border rounded"><option value="" disabled>-- Pilih Jenjang --</option><option value="7">7</option><option value="8">8</option><option value="9">9</option></select>
                                <input v-model="identitas.guru" class="w-full p-3 border rounded" placeholder="Nama Guru">
                                <button @click="switchToTP" class="w-full bg-indigo-600 text-white py-3 rounded font-bold">MULAI</button>
                            </div>
                        </div>
                    </div>
                </transition>

                <!-- 2. PENYUSUNAN TP -->
                <transition name="fade">
                    <div v-if="currentTab === 'tp'" class="no-print">
                        <div class="mb-6 flex items-center gap-2 bg-indigo-50 px-4 py-2 rounded-lg border border-indigo-200 w-fit"><span class="font-bold text-indigo-900 text-sm">{{ identitas.mapel }}</span><span class="text-gray-400">|</span><span class="font-bold text-indigo-900 text-sm">Jenjang {{ identitas.jenjang }}</span></div>
                        <div v-for="(lm, lmIndex) in lingkupMateri" :key="lm.id" class="mb-8 bg-white rounded-xl shadow border border-slate-200 overflow-hidden">
                            <div class="bg-slate-100 p-4 border-b flex items-center gap-4 cursor-pointer" @click="lm.isOpen = !lm.isOpen"><div class="bg-indigo-600 text-white w-8 h-8 flex items-center justify-center rounded-full font-bold text-sm">{{ lmIndex + 1 }}</div><div class="flex-1" @click.stop><input v-model="lm.judul" class="w-full p-2 bg-transparent border-b-2 border-slate-300 focus:border-indigo-600 outline-none font-bold" :placeholder="'Lingkup Materi ' + (lmIndex + 1)"></div><i :class="['fas text-slate-400', lm.isOpen ? 'fa-chevron-up' : 'fa-chevron-down']"></i></div>
                            <div v-show="lm.isOpen" class="p-6 space-y-6 bg-slate-50/30">
                                <div v-for="(tp, tpIndex) in lm.tujuan" :key="tpIndex" class="relative group border-b border-slate-100 pb-4">
                                    <h4 class="font-bold text-xs text-slate-500 mb-2">TP {{ lmIndex + 1 }}.{{ tpIndex + 1 }}</h4>
                                    <div class="grid grid-cols-1 md:grid-cols-12 gap-2 mb-2"><div class="md:col-span-1"><input v-model="tp.a" readonly class="w-full p-2 border rounded bg-gray-100 text-center text-xs font-bold"></div><div class="md:col-span-5"><textarea v-model="tp.b" rows="1" class="input-abcd w-full p-2 border rounded text-xs" placeholder="Behavior"></textarea></div><div class="md:col-span-3"><textarea v-model="tp.c" rows="1" class="input-abcd w-full p-2 border rounded text-xs" placeholder="Condition"></textarea></div><div class="md:col-span-3"><textarea v-model="tp.d" rows="1" class="input-abcd w-full p-2 border rounded text-xs" placeholder="Degree"></textarea></div></div>
                                    <div class="bg-indigo-50 p-2 rounded border border-indigo-100 flex items-center gap-2"><i class="fas fa-magic text-indigo-400 text-xs"></i><p class="text-xs text-indigo-900 italic font-medium">"{{ generateSentence(tp) }}"</p></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </transition>

                <!-- 3. INPUT NILAI -->
                <transition name="fade">
                    <div v-if="currentTab === 'nilai'" class="no-print">
                        <div class="bg-white p-4 rounded-xl shadow border mb-6 flex flex-col md:flex-row justify-between items-center gap-4"><div class="w-full md:w-1/3"><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Pilih Kelas</label><select v-model="selectedClass" @change="fetchStudentsAndScores" class="w-full p-2 border-2 border-blue-200 rounded font-bold text-blue-900"><option value="" disabled>-- Pilih Kelas --</option><option v-for="c in filteredClasses" :value="c">{{ c }}</option></select></div><div class="text-right text-xs text-gray-500"><p><strong>Mapel:</strong> {{ identitas.mapel }}</p><p class="text-green-600 font-bold" v-if="lastSavedGrade">Tersimpan: {{ lastSavedGrade }}</p></div></div>
                        <div class="bg-white rounded-xl shadow border overflow-hidden relative">
                            <div v-if="!selectedClass" class="p-10 text-center text-gray-400"><i class="fas fa-arrow-up fa-2x mb-2"></i><br>Pilih kelas dulu.</div>
                            <div v-else class="overflow-x-auto"><table class="w-full text-left border-collapse excel-table text-sm"><thead><tr class="bg-slate-800 text-white"><th class="p-3 w-10 text-center sticky-col bg-slate-800" rowspan="2">No</th><th class="p-3 w-64 sticky-col-2 bg-slate-800 left-10" rowspan="2">Nama Siswa</th><template v-for="lm in activeLMs" :key="lm.id"><th :colspan="lm.tpCount + 2" class="p-2 text-center text-xs font-bold header-lm text-slate-800">{{ lm.judul || 'LM ' + lm.id }}</th></template><th colspan="2" class="p-2 text-center text-xs font-bold header-asas text-orange-800">ASAS</th><th colspan="3" class="p-2 text-center text-xs font-bold header-avg text-green-800">RATA-RATA</th><th rowspan="2" class="p-2 text-center text-xs font-bold header-rapor">Nilai Akhir (Rapor)</th></tr><tr class="bg-slate-100 text-slate-600"><template v-for="lm in activeLMs" :key="lm.id"><template v-for="(tp, idx) in lm.tujuan" :key="lm.id + '_' + idx"><th class="p-2 text-center text-[10px] w-16 border-l" :title="generateSentence(tp)">TP {{ lm.id }}.{{ idx+1 }}</th></template><th class="p-2 text-center text-[10px] w-14 bg-blue-50 font-bold border-l-2">LM Tes</th><th class="p-2 text-center text-[10px] w-14 bg-blue-50 font-bold">LM Non</th></template><th class="p-2 text-center text-[10px] w-16 bg-orange-50 font-bold">Tes</th><th class="p-2 text-center text-[10px] w-16 bg-orange-50 font-bold">Non</th><th class="p-2 text-center text-[10px] w-12 bg-green-50 font-bold">TP</th><th class="p-2 text-center text-[10px] w-12 bg-green-50 font-bold">LM</th><th class="p-2 text-center text-[10px] w-12 bg-green-50 font-bold">ASAS</th></tr></thead><tbody class="bg-white"><tr v-for="(s, sIdx) in studentList" :key="s.id" class="hover:bg-blue-50"><td class="text-center bg-gray-50 text-gray-500 select-none sticky-col left-0">{{ sIdx + 1 }}</td><td class="px-3 py-2 font-bold text-gray-700 select-none whitespace-nowrap sticky-col-2 bg-white left-10">{{ s.nama }}</td><template v-for="lm in activeLMs" :key="lm.id"><template v-for="(tp, idx) in lm.tujuan" :key="lm.id + '_' + idx"><td class="p-0"><input type="text" :class="['excel-input', getValidationClass(getGrade(s.id, `tp_${lm.id}_${idx+1}` ))]" :value="getGrade(s.id, `tp_${lm.id}_${idx+1}` )" @input="updateGrade(s.id, `tp_${lm.id}_${idx+1}`, $event.target.value)" @paste="handleGridPaste($event, sIdx, `tp_${lm.id}_${idx+1}`)"></td></template><td class="p-0 bg-blue-50/20 border-l-2"><input type="text" :class="['excel-input font-bold text-blue-700', getValidationClass(getGrade(s.id, `lm_${lm.id}_tes`))]" :value="getGrade(s.id, `lm_${lm.id}_tes`)" @input="updateGrade(s.id, `lm_${lm.id}_tes`, $event.target.value)"></td><td class="p-0 bg-blue-50/20"><input type="text" :class="['excel-input font-bold text-blue-700', getValidationClass(getGrade(s.id, `lm_${lm.id}_nontes`))]" :value="getGrade(s.id, `lm_${lm.id}_nontes`)" @input="updateGrade(s.id, `lm_${lm.id}_nontes`, $event.target.value)"></td></template><td class="p-0 bg-orange-50/30 border-l-2"><input type="text" class="excel-input font-bold text-orange-700 bg-orange-100 cursor-not-allowed" :value="s.asasTesScore" readonly></td><td class="p-0 bg-orange-50/30"><input type="text" :class="['excel-input font-bold text-orange-700', getValidationClass(getGrade(s.id, 'asas_nontes'))]" :value="getGrade(s.id, 'asas_nontes')" @input="updateGrade(s.id, 'asas_nontes', $event.target.value)"></td><td class="p-0 bg-green-50/30 text-center font-bold text-green-800 border-l-2">{{ calculateRataTP(s.id) }}</td><td class="p-0 bg-green-50/30 text-center font-bold text-green-800">{{ calculateRataLM(s.id) }}</td><td class="p-0 bg-green-50/30 text-center font-bold text-green-800">{{ calculateRataASAS(s.id, s.asasTesScore) }}</td><td class="p-0 bg-blue-100 text-center font-extrabold text-blue-900 border-l-2">{{ calculateNilaiRapor(s.id, s.asasTesScore) }}</td></tr></tbody></table></div>
                        </div>
                    </div>
                </transition>

                <!-- 4. INPUT EKSTRAKURIKULER -->
                <transition name="fade">
                    <div v-if="currentTab === 'ekskul'" class="no-print">
                        <div class="bg-white p-4 rounded-xl shadow border mb-6 flex flex-col md:flex-row justify-between items-center gap-4"><div class="w-full md:w-1/3"><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Pilih Kelas (Wali Kelas)</label><select v-model="selectedClass" @change="fetchStudents" class="w-full p-2 border-2 border-orange-200 rounded font-bold text-orange-900"><option value="" disabled>-- Pilih Kelas --</option><option v-for="c in filteredClasses" :value="c">{{ c }}</option></select></div><div class="text-right text-xs text-gray-500"><p><strong>Jenjang:</strong> Kelas {{ identitas.jenjang }}</p><p class="text-orange-600 italic">Khusus Wali Kelas</p></div></div><div class="bg-white rounded-xl shadow border overflow-hidden relative"><div v-if="!selectedClass" class="p-10 text-center text-gray-400"><i class="fas fa-chalkboard-teacher fa-2x mb-2"></i><br>Pilih kelas perwalian Anda.</div><div v-else class="overflow-x-auto"><table class="w-full text-left border-collapse excel-table text-sm"><thead><tr class="bg-orange-800 text-white"><th class="p-3 w-10 text-center sticky-col bg-orange-800" rowspan="2">No</th><th class="p-3 w-64 sticky-col-2 bg-orange-800" rowspan="2">Nama Siswa</th><th colspan="2" class="p-2 text-center text-xs font-bold header-ekskul-1">EKSKUL 1 (WAJIB)</th><th colspan="2" class="p-2 text-center text-xs font-bold header-ekskul-2">EKSKUL 2 (OPSIONAL)</th><th colspan="2" class="p-2 text-center text-xs font-bold header-ekskul-3">EKSKUL 3 (OPSIONAL)</th></tr><tr class="text-slate-600 bg-slate-100"><th class="p-2 w-48 text-center text-xs border-l">Nama Kegiatan</th><th class="p-2 w-48 text-center text-xs">Deskripsi / Predikat</th><th class="p-2 w-48 text-center text-xs border-l">Nama Kegiatan</th><th class="p-2 w-48 text-center text-xs">Deskripsi / Predikat</th><th class="p-2 w-48 text-center text-xs border-l">Nama Kegiatan</th><th class="p-2 w-48 text-center text-xs">Deskripsi / Predikat</th></tr></thead><tbody class="bg-white"><tr v-for="(s, sIdx) in studentList" :key="s.id" class="hover:bg-orange-50"><td class="text-center bg-gray-50 text-gray-500 select-none sticky-col left-0">{{ sIdx + 1 }}</td><td class="px-3 py-2 font-bold text-gray-700 select-none whitespace-nowrap sticky-col-2 bg-white left-10">{{ s.nama }}</td><td class="p-0 border-l bg-orange-50/50"><input type="text" class="excel-input text-left font-bold text-orange-900 bg-transparent cursor-not-allowed" value="PRAMUKA" readonly></td><td class="p-0 bg-orange-50/50"><input type="text" class="excel-input text-left" v-model="getEkskulData(s.id).ek1_desc" @input="updateEkskul(s.id, 'ek1_desc', $event.target.value)" @paste="handleGridPaste($event, sIdx, 'ek1_desc', true)" placeholder="Sangat Baik..."></td><td class="p-0 border-l"><input type="text" class="excel-input text-left" v-model="getEkskulData(s.id).ek2_nama" @input="updateEkskul(s.id, 'ek2_nama', $event.target.value)" @paste="handleGridPaste($event, sIdx, 'ek2_nama', true)" placeholder="Nama Ekskul"></td><td class="p-0"><input type="text" class="excel-input text-left" v-model="getEkskulData(s.id).ek2_desc" @input="updateEkskul(s.id, 'ek2_desc', $event.target.value)" @paste="handleGridPaste($event, sIdx, 'ek2_desc', true)" placeholder="Predikat..."></td><td class="p-0 border-l"><input type="text" class="excel-input text-left" v-model="getEkskulData(s.id).ek3_nama" @input="updateEkskul(s.id, 'ek3_nama', $event.target.value)" @paste="handleGridPaste($event, sIdx, 'ek3_nama', true)" placeholder="Nama Ekskul"></td><td class="p-0"><input type="text" class="excel-input text-left" v-model="getEkskulData(s.id).ek3_desc" @input="updateEkskul(s.id, 'ek3_desc', $event.target.value)" @paste="handleGridPaste($event, sIdx, 'ek3_desc', true)" placeholder="Predikat..."></td></tr></tbody></table></div></div>
                    </div>
                </transition>

                <!-- 5. KEWALASAN (SAME) -->
                <transition name="fade">
                    <div v-if="currentTab === 'kewalasan'" class="no-print">
                        <div class="bg-white p-6 rounded-xl shadow border mb-6"><h3 class="font-bold text-teal-800 text-lg mb-4 flex items-center gap-2"><i class="fas fa-list-ol"></i> Konfigurasi Aspek Nilai Karakter</h3><div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4"><div><label class="text-[10px] font-bold text-gray-500 uppercase">Aspek 1</label><input v-model="kewalasanConfig.a1" class="w-full p-2 border rounded text-sm bg-teal-50" placeholder="Religius"></div><div><label class="text-[10px] font-bold text-gray-500 uppercase">Aspek 2</label><input v-model="kewalasanConfig.a2" class="w-full p-2 border rounded text-sm bg-teal-50" placeholder="Mandiri"></div><div><label class="text-[10px] font-bold text-gray-500 uppercase">Aspek 3</label><input v-model="kewalasanConfig.a3" class="w-full p-2 border rounded text-sm bg-teal-50" placeholder="Gotong Royong"></div><div><label class="text-[10px] font-bold text-gray-500 uppercase">Aspek 4</label><input v-model="kewalasanConfig.a4" class="w-full p-2 border rounded text-sm bg-teal-50" placeholder="Bernalar Kritis"></div></div><div class="flex items-end gap-4 border-t pt-4"><div class="w-full md:w-1/3"><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Pilih Kelas</label><select v-model="selectedClass" @change="fetchStudents" class="w-full p-2 border-2 border-teal-200 rounded font-bold text-teal-900"><option value="" disabled>-- Pilih Kelas --</option><option v-for="c in filteredClasses" :value="c">{{ c }}</option></select></div><div class="text-right flex-1 text-xs text-gray-400 italic">Nilai > 90 = Sangat Baik, <= 90 = Baik.</div></div></div>
                        <div class="bg-white rounded-xl shadow border overflow-hidden relative"><div v-if="!selectedClass" class="p-10 text-center text-gray-400"><i class="fas fa-chalkboard-teacher fa-2x mb-2"></i><br>Pilih kelas perwalian Anda.</div><div v-else class="overflow-x-auto"><table class="w-full text-left border-collapse excel-table text-sm"><thead><tr class="bg-teal-800 text-white"><th class="p-3 w-10 text-center" rowspan="2">No</th><th class="p-3 w-64" rowspan="2">Nama Siswa</th><th colspan="3" class="p-2 text-center text-xs bg-yellow-600 font-bold border-l">Kehadiran</th><th colspan="4" class="p-2 text-center text-xs bg-teal-700 font-bold border-l">Rapor Karakter (Skor 0-100)</th><th class="p-3 w-96 text-center bg-gray-800" rowspan="2">Catatan Wali Kelas (Otomatis)</th></tr><tr class="text-teal-100 bg-teal-900"><th class="p-1 text-center w-10 bg-yellow-700 border-l text-white">S</th><th class="p-1 text-center w-10 bg-yellow-700 text-white">I</th><th class="p-1 text-center w-10 bg-yellow-700 text-white">A</th><th class="p-1 text-center w-24 border-l font-normal text-[10px]">{{ kewalasanConfig.a1 || 'Aspek 1' }}</th><th class="p-1 text-center w-24 font-normal text-[10px]">{{ kewalasanConfig.a2 || 'Aspek 2' }}</th><th class="p-1 text-center w-24 font-normal text-[10px]">{{ kewalasanConfig.a3 || 'Aspek 3' }}</th><th class="p-1 text-center w-24 font-normal text-[10px]">{{ kewalasanConfig.a4 || 'Aspek 4' }}</th></tr></thead><tbody class="bg-white"><tr v-for="(s, sIdx) in studentList" :key="s.id" class="hover:bg-teal-50"><td class="text-center bg-gray-50 text-gray-500 select-none">{{ sIdx + 1 }}</td><td class="px-3 py-2 font-bold text-gray-700 whitespace-nowrap">{{ s.nama }}</td><td class="p-0 border-l bg-yellow-50"><input type="number" class="excel-input text-yellow-800" v-model="getKewalasan(s.id).s" @input="updateKewalasan(s.id, 's', $event.target.value)" placeholder="0"></td><td class="p-0 bg-yellow-50"><input type="number" class="excel-input text-yellow-800" v-model="getKewalasan(s.id).i" @input="updateKewalasan(s.id, 'i', $event.target.value)" placeholder="0"></td><td class="p-0 bg-yellow-50"><input type="number" class="excel-input text-yellow-800" v-model="getKewalasan(s.id).a" @input="updateKewalasan(s.id, 'a', $event.target.value)" placeholder="0"></td><td class="p-0 border-l"><input type="number" class="excel-input" v-model="getKewalasan(s.id).c1" @input="updateKewalasan(s.id, 'c1', $event.target.value)"></td><td class="p-0"><input type="number" class="excel-input" v-model="getKewalasan(s.id).c2" @input="updateKewalasan(s.id, 'c2', $event.target.value)"></td><td class="p-0"><input type="number" class="excel-input" v-model="getKewalasan(s.id).c3" @input="updateKewalasan(s.id, 'c3', $event.target.value)"></td><td class="p-0"><input type="number" class="excel-input" v-model="getKewalasan(s.id).c4" @input="updateKewalasan(s.id, 'c4', $event.target.value)"></td><td class="p-2 border-l bg-gray-50 text-xs italic text-gray-600"><textarea readonly rows="2" class="w-full bg-transparent border-none outline-none resize-none" :value="generateWaliNotes(s.id, s.nama)"></textarea></td></tr></tbody></table></div></div>
                    </div>
                </transition>

                <!-- 6. MENU 7 KAIH (SAME) -->
                <transition name="fade">
                    <div v-if="currentTab === 'kaih'" class="no-print">
                        <div class="bg-white p-6 rounded-xl shadow border mb-6"><h3 class="font-bold text-cyan-800 text-lg mb-4 flex items-center gap-2"><i class="fas fa-star"></i> Input 7 Kebiasaan Anak Indonesia Hebat (KAIH)</h3><div class="flex items-end gap-4 border-t pt-4"><div class="w-full md:w-1/3"><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Pilih Kelas</label><select v-model="selectedClass" @change="fetchStudents" class="w-full p-2 border-2 border-cyan-200 rounded font-bold text-cyan-900"><option value="" disabled>-- Pilih Kelas --</option><option v-for="c in filteredClasses" :value="c">{{ c }}</option></select></div><div class="text-right flex-1 text-xs text-gray-400 italic">Isi nilai (0-100) per indikator. Deskripsi otomatis.</div></div></div><div class="bg-white rounded-xl shadow border overflow-hidden relative"><div v-if="!selectedClass" class="p-10 text-center text-gray-400"><i class="fas fa-chalkboard-teacher fa-2x mb-2"></i><br>Pilih kelas perwalian Anda.</div><div v-else class="overflow-x-auto"><table class="w-full text-left border-collapse excel-table text-sm"><thead><tr class="bg-cyan-800 text-white"><th class="p-3 w-10 text-center sticky-col bg-cyan-800" rowspan="2">No</th><th class="p-3 w-64 sticky-col-2 bg-cyan-800" rowspan="2">Nama Siswa</th><template v-for="aspect in kaihConfig" :key="aspect.id"><th :colspan="aspect.count" class="p-1 text-center font-normal text-[10px] border-l border-cyan-600">{{ aspect.name }}</th></template><th class="p-3 w-96 text-center bg-gray-800 sticky-right" rowspan="2">Deskripsi 7 KAIH (Otomatis)</th></tr><tr class="bg-cyan-900 text-cyan-100"><template v-for="aspect in kaihConfig" :key="aspect.id + '_sub'"><th v-for="n in aspect.count" :key="aspect.id + '_' + n" class="p-1 text-center w-8 text-[9px] border-l border-cyan-700">{{ n }}</th></template></tr></thead><tbody class="bg-white"><tr v-for="(s, sIdx) in studentList" :key="s.id" class="hover:bg-cyan-50"><td class="text-center bg-gray-50 text-gray-500 select-none sticky-col left-0">{{ sIdx + 1 }}</td><td class="px-3 py-2 font-bold text-gray-700 whitespace-nowrap sticky-col-2 bg-white left-10">{{ s.nama }}</td><template v-for="aspect in kaihConfig" :key="aspect.id"><td v-for="n in aspect.count" :key="aspect.id + '_' + n" class="p-0 border-l border-gray-100"><input type="number" class="excel-input" v-model="getKaih(s.id)[`${aspect.id}_${n}`]" @input="updateKaih(s.id, `${aspect.id}_${n}`, $event.target.value)" @paste="handleGridPaste($event, sIdx, `${aspect.id}_${n}`, false, true)" placeholder="0"></td></template><td class="p-2 border-l bg-gray-50 text-xs italic text-gray-600 sticky-right"><textarea readonly rows="3" class="w-full bg-transparent border-none outline-none resize-none" :value="generateKaihNotes(s.id, s.nama)"></textarea></td></tr></tbody></table></div></div>
                    </div>
                </transition>

                <!-- 7. MONITORING (SAME) -->
                <transition name="fade">
                    <div v-if="currentTab === 'monitoring'" class="no-print">
                        <div class="bg-white p-6 rounded-xl shadow border">
                            <h2 class="text-xl font-bold text-slate-800 mb-4">Monitoring Input Nilai</h2>
                            <div v-for="(classes, jenjang) in classesMap" :key="jenjang" class="mb-6"><h3 class="font-bold text-blue-900 border-b pb-2 mb-3">JENJANG KELAS {{ jenjang }}</h3><div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4"><div v-for="cls in classes" :key="cls" class="bg-gray-50 border p-3 rounded text-center"><div class="font-bold text-lg text-slate-700">{{ cls }}</div><div class="text-xs text-gray-500 mt-2 space-y-1"><div v-for="m in mapelList" :key="m" class="flex justify-between"><span>{{ m.substring(0,3) }}</span><i :class="hasData(cls, m) ? 'fas fa-check-circle text-green-500' : 'fas fa-circle text-gray-200'"></i></div><div class="border-t border-gray-200 my-2 pt-1 font-bold text-[10px] text-slate-400">WALI KELAS</div><div class="flex justify-between"><span>EKSKUL</span><i :class="hasData(cls, 'EKSKUL') ? 'fas fa-check-circle text-green-500' : 'fas fa-circle text-gray-200'"></i></div><div class="flex justify-between"><span>KEWALASAN</span><i :class="hasData(cls, 'KEWALASAN') ? 'fas fa-check-circle text-green-500' : 'fas fa-circle text-gray-200'"></i></div><div class="flex justify-between"><span>7 KAIH</span><i :class="hasData(cls, 'KAIH') ? 'fas fa-check-circle text-green-500' : 'fas fa-circle text-gray-200'"></i></div></div></div></div></div>
                        </div>
                    </div>
                </transition>
                
                <!-- 8. REKAPITULASI (SAME) -->
                <transition name="fade">
                    <div v-if="currentTab === 'rekap'" class="no-print">
                        <div class="bg-white p-4 rounded-xl shadow border mb-6 flex flex-col md:flex-row justify-between items-center gap-4"><div class="w-full md:w-1/3 flex gap-2"><div class="w-1/2"><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Jenjang</label><select v-model="rekapJenjang" class="w-full p-2 border rounded font-bold text-emerald-900"><option value="7">Kelas 7</option><option value="8">Kelas 8</option><option value="9">Kelas 9</option></select></div><div class="w-1/2"><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Kelas</label><select v-model="selectedClass" @change="fetchStudentsForRekap" class="w-full p-2 border-2 border-emerald-200 rounded font-bold text-emerald-900"><option value="" disabled>-- Pilih --</option><option v-for="c in classesMap[rekapJenjang]" :value="c">{{ c }}</option></select></div></div><div class="text-right text-xs text-gray-500 italic">Data diambil dari Input Nilai masing-masing Guru.</div></div><div class="bg-white rounded-xl shadow border overflow-hidden relative"><div v-if="!selectedClass" class="p-10 text-center text-gray-400">Pilih kelas untuk melihat rekapitulasi.</div><div v-else class="overflow-x-auto"><table class="w-full text-left border-collapse excel-table text-xs"><thead class="bg-emerald-800 text-white"><tr><th class="p-3 w-10 text-center sticky-col bg-emerald-800" rowspan="2">No</th><th class="p-3 w-48 sticky-col-2 bg-emerald-800" rowspan="2">Nama Siswa</th><template v-for="m in mapelList" :key="m"><th :colspan="getMapelColSpan(m)" class="p-2 text-center border-l-4 border-emerald-400 bg-emerald-900">{{ m }}</th></template><th class="p-3 text-center bg-emerald-950 sticky-right w-16" rowspan="2">TOTAL SKOR</th><th class="p-3 text-center bg-emerald-950 sticky-right w-16" rowspan="2">RATA-RATA</th><th class="p-3 text-center bg-yellow-600 text-black sticky-right w-10 font-extrabold" rowspan="2">RANK</th></tr><tr class="bg-emerald-700 text-emerald-50"><template v-for="m in mapelList" :key="m + '_sub'"><template v-for="col in getMapelColumns(m)" :key="col.id"><th class="p-1 text-center w-8 border-l border-emerald-600" :title="col.title">{{ col.label }}</th></template><th class="p-1 text-center w-10 bg-emerald-600 font-bold border-l">R.TP</th><th class="p-1 text-center w-10 bg-emerald-600 font-bold">R.LM</th><th class="p-1 text-center w-10 bg-emerald-600 font-bold">R.ASAS</th><th class="p-1 text-center w-12 bg-yellow-400 text-black font-extrabold border-l-2">AKHIR</th></template></tr></thead><tbody class="bg-white"><tr v-for="(row, idx) in rekapData" :key="row.id" class="hover:bg-emerald-50"><td class="text-center font-bold sticky-col bg-white">{{ idx + 1 }}</td><td class="px-3 py-2 font-bold text-gray-700 whitespace-nowrap sticky-col-2 bg-white left-10">{{ row.nama }}</td><template v-for="m in mapelList" :key="m"><template v-for="col in getMapelColumns(m)" :key="col.id"><td class="text-center border-l text-gray-500">{{ row.grades[m]?.details?.[col.id] || '-' }}</td></template><td class="text-center font-bold text-emerald-700 bg-emerald-50 border-l">{{ row.grades[m]?.rTP || '-' }}</td><td class="text-center font-bold text-emerald-700 bg-emerald-50">{{ row.grades[m]?.rLM || '-' }}</td><td class="text-center font-bold text-emerald-700 bg-emerald-50">{{ row.grades[m]?.rASAS || '-' }}</td><td class="text-center font-extrabold text-blue-900 bg-blue-100 border-l-2 border-blue-200">{{ row.grades[m]?.final || '-' }}</td></template><td class="text-center font-extrabold text-white bg-emerald-900 sticky-right">{{ row.total }}</td><td class="text-center font-bold text-white bg-emerald-800 sticky-right">{{ row.average }}</td><td class="text-center font-extrabold text-black bg-yellow-400 sticky-right border-l-2 border-yellow-600">{{ row.rank }}</td></tr></tbody></table></div></div>
                    </div>
                </transition>

                <!-- 9. REKAP AKHIR (SAME) -->
                <transition name="fade">
                    <div v-if="currentTab === 'rekap_akhir'" class="no-print">
                        <div class="bg-white p-4 rounded-xl shadow border mb-6 flex flex-col md:flex-row justify-between items-center gap-4"><div class="w-full md:w-1/3 flex gap-2"><div class="w-1/2"><label class="block text-xs font-bold text-purple-500 uppercase mb-1">Jenjang</label><select v-model="rekapJenjang" class="w-full p-2 border rounded font-bold text-purple-900"><option value="7">Kelas 7</option><option value="8">Kelas 8</option><option value="9">Kelas 9</option></select></div><div class="w-1/2"><label class="block text-xs font-bold text-purple-500 uppercase mb-1">Kelas</label><select v-model="selectedClass" @change="fetchStudentsForRekap" class="w-full p-2 border-2 border-purple-200 rounded font-bold text-purple-900"><option value="" disabled>-- Pilih --</option><option v-for="c in classesMap[rekapJenjang]" :value="c">{{ c }}</option></select></div></div><div class="text-right text-xs text-gray-500">Preview Rapor Lengkap</div></div><div class="bg-white rounded-xl shadow border overflow-hidden relative"><div v-if="!selectedClass" class="p-10 text-center text-gray-400">Pilih kelas untuk melihat Rapor Akhir.</div><div v-else class="overflow-x-auto"><table class="w-full text-left border-collapse excel-table text-xs"><thead class="bg-purple-800 text-white"><tr><th class="p-3 w-10 text-center sticky-col bg-purple-800" rowspan="2">No</th><th class="p-3 w-48 sticky-col-2 bg-purple-800" rowspan="2">Nama Siswa</th><template v-for="m in mapelList" :key="m"><th colspan="3" class="p-2 text-center border-l-4 border-purple-500 bg-purple-900">{{ m }}</th></template></tr><tr class="bg-purple-700 text-purple-100"><template v-for="m in mapelList" :key="m + '_desc'"><th class="p-2 text-center w-12 font-bold bg-purple-600 border-l">NILAI</th><th class="p-2 text-center min-w-[350px]">Deskripsi 1 (Kuat)</th><th class="p-2 text-center min-w-[350px]">Deskripsi 2 (Lemah)</th></template></tr></thead><tbody class="bg-white"><tr v-for="(row, idx) in rekapAkhirTableData" :key="row.id" class="hover:bg-purple-50"><td class="text-center font-bold sticky-col bg-white">{{ idx + 1 }}</td><td class="px-3 py-2 font-bold text-gray-700 whitespace-nowrap sticky-col-2 bg-white left-10">{{ row.nama }}</td><template v-for="m in mapelList" :key="m"><td class="text-center font-extrabold text-lg text-purple-800 bg-purple-50 border-l">{{ row.data[m].nilai || '-' }}</td><td class="p-2 border text-[11px] text-green-700 align-top whitespace-normal leading-relaxed">{{ row.data[m].desc1 }}</td><td class="p-2 border text-[11px] text-orange-700 align-top whitespace-normal leading-relaxed">{{ row.data[m].desc2 }}</td></template></tr></tbody></table></div></div>
                    </div>
                </transition>

                <!-- 10. TAB LHBTS (RAPOR TENGAH SEMESTER) -->
                <transition name="fade">
                    <div v-if="currentTab === 'lhbts'" class="print-area">
                        
                        <!-- Filter (No Print) -->
                        <div class="bg-white p-4 rounded-xl shadow border mb-6 flex gap-4 items-center no-print">
                            <div class="w-1/3"><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Pilih Kelas</label><select v-model="selectedClass" @change="fetchStudentsForLHBTS" class="w-full p-2 border-2 border-blue-200 rounded font-bold text-blue-900"><option value="" disabled>-- Pilih Kelas --</option><option v-for="c in kelasList" :value="c">{{ c }}</option></select></div>
                            <div class="w-1/3" v-if="studentList.length > 0"><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Pilih Siswa</label><select v-model="selectedStudentId" class="w-full p-2 border-2 border-blue-200 rounded font-bold text-blue-900"><option value="" disabled>-- Pilih Siswa --</option><option v-for="s in studentList" :value="s.id">{{ s.nama }}</option></select></div>
                        </div>

                        <!-- TEMPLATE LHBTS -->
                        <div v-if="selectedStudentData" class="lhbts-container overflow-x-auto">
                            <table class="lhbts-table">
                                <!-- DEFINISI KOLOM (A-AF) - WIDTH PRESISI PIXEL -->
                                <colgroup>
                                    <col style="width: 100px"> <!-- A -->
                                    <col style="width: 50px">  <!-- B -->
                                    <col style="width: 300px"> <!-- C -->
                                    
                                    <col style="width: 49px">  <!-- D -->
                                    <col span="9" style="width: 49px"> 
                                    <col style="width: 49px">  <!-- N -->
                                    <col span="9" style="width: 49px"> 
                                    
                                    <col style="width: 63px">  <!-- X -->
                                    
                                    <col style="width: 69px">  <!-- Y -->
                                    <col style="width: 69px">  <!-- Z -->
                                    <col style="width: 69px">  <!-- AA -->
                                    <col style="width: 69px">  <!-- AB -->
                                    <col style="width: 69px">  <!-- AC -->
                                    
                                    <col style="width: 63px">  <!-- AD -->
                                    <col style="width: 63px">  <!-- AE -->
                                    <col style="width: 914px"> <!-- AF -->
                                </colgroup>

                                <!-- HEADER JUDUL -->
                                <tr style="height: 14.5pt;"><td colspan="32" class="no-border"></td></tr> <!-- Spacer for removed No Urut box -->
                                <tr style="height: 23pt;"><td colspan="32" class="text-center text-18pt-bold no-border">LAPORAN HASIL BELAJAR TENGAH SEMESTER</td></tr>
                                <tr style="height: 23pt;"><td colspan="32" class="text-center text-18pt-bold no-border bb-double">SEKOLAH MENENGAH PERTAMA (SMP) ALBANNA DENPASAR</td></tr>
                                <tr style="height: 7.5pt;"><td colspan="32" class="no-border"></td></tr>

                                <!-- IDENTITAS -->
                                <tr style="height: 16.5pt;"><td class="no-border"></td><td colspan="2" class="no-border text-left">Nama Peserta Didik</td><td colspan="10" class="no-border text-left nowrap-cell">: {{ selectedStudentData.nama }}</td><td colspan="12" class="no-border"></td><td colspan="2" class="no-border text-left">Kelas</td><td colspan="5" class="no-border text-left nowrap-cell">: {{ selectedClass }}</td></tr>
                                <tr style="height: 16.5pt;"><td class="no-border"></td><td colspan="2" class="no-border text-left">NIS/NISN</td><td colspan="10" class="no-border text-left nowrap-cell">: {{ selectedStudentData.nis || '-' }}</td><td colspan="12" class="no-border"></td><td colspan="2" class="no-border text-left">Fase</td><td colspan="5" class="no-border text-left nowrap-cell">: D</td></tr>
                                <tr style="height: 16.5pt;"><td class="no-border"></td><td colspan="2" class="no-border text-left">Nama Sekolah</td><td colspan="10" class="no-border text-left nowrap-cell">: SMP ALBANNA</td><td colspan="12" class="no-border"></td><td colspan="2" class="no-border text-left">Semester</td><td colspan="5" class="no-border text-left nowrap-cell">: Ganjil</td></tr>
                                <tr style="height: 16.5pt;"><td class="no-border"></td><td colspan="2" class="no-border text-left">Alamat Sekolah</td><td colspan="10" class="no-border text-left nowrap-cell">: Jl. Tukad Yeh Ho III No. 16</td><td colspan="12" class="no-border"></td><td colspan="2" class="no-border text-left">Tahun Ajaran</td><td colspan="5" class="no-border text-left nowrap-cell">: 2025/2026</td></tr>
                                <tr style="height: 7.5pt;"><td colspan="32" class="no-border"></td></tr>

                                <!-- HEADER TABEL NILAI -->
                                <tr style="height: 21pt;" class="bg-blue-excel font-bold text-center"><td rowspan="4">NO</td><td colspan="2" rowspan="4">MATA PELAJARAN</td><td colspan="27">NILAI</td><td rowspan="4">NA</td><td rowspan="4">DESKRIPSI</td></tr>
                                <tr style="height: 21pt;" class="bg-blue-excel font-bold text-center"><td colspan="20">RATA-RATA&nbsp;&nbsp;ASESMEN FORMATIF</td><td rowspan="3">HA</td><td colspan="5" rowspan="2">SUMATIF LINGKUP MATERI</td><td rowspan="3">HA</td></tr>
                                <tr style="height: 21pt;" class="bg-blue-excel font-bold text-center"><td colspan="5">Lingkup Materi 1</td><td colspan="5">Lingkup Materi 2</td><td colspan="5">LingkupMateri 3</td><td colspan="5">LingkupMateri 4</td></tr>
                                <tr style="height: 21pt;" class="bg-blue-excel font-bold text-center bb-double"><td>1</td><td>2</td><td>3</td><td>4</td><td>5</td><td>1</td><td>2</td><td>3</td><td>4</td><td>5</td><td>1</td><td>2</td><td>3</td><td>4</td><td>5</td><td>1</td><td>2</td><td>3</td><td>4</td><td>5</td><td>1</td><td>2</td><td>3</td><td>4</td><td>5</td></tr>

                                <!-- ISI DATA MAPEL -->
                                <template v-for="(section, sIdx) in lhbtsSections" :key="sIdx">
                                    <tr style="height: 16.5pt;" class="bg-blue-excel"><td class="text-center bt-double"></td><td colspan="31" class="text-left font-bold bt-double">{{ section.label }}</td></tr>
                                    <tr v-for="row in section.rows" :key="row.mapel" style="height: 30pt;">
                                        <td class="text-center">{{ row.no }}</td><td colspan="2" class="text-left" style="white-space: normal;">{{ row.mapel }}</td>
                                        <td v-for="i in 20" :key="'f'+i" class="text-center">{{ getGradeLHBTS(selectedStudentData.id, row.mapel, 'f', i) }}</td>
                                        <td class="text-center bg-gray-50 font-bold"></td>
                                        <td v-for="i in 5" :key="'s'+i" class="text-center text-xs">{{ getGradeLHBTS(selectedStudentData.id, row.mapel, 's', i) }}</td>
                                        <td class="text-center bg-gray-50 font-bold"></td>
                                        <td class="text-center font-bold bg-blue-50">{{ getGradeLHBTS(selectedStudentData.id, row.mapel, 'na', 0) }}</td>
                                        <td class="text-left align-top p-1 text-[9px]" style="white-space: normal;">{{ getGradeLHBTS(selectedStudentData.id, row.mapel, 'desc', 0) }}</td>
                                    </tr>
                                </template>

                                <!-- TOTALS -->
                                <tr style="height: 15.75pt;"><td colspan="3" class="text-center font-bold bg-blue-excel">JUMLAH NILAI</td><td colspan="27" style="background-color:#eee;"></td><td class="text-center font-bold bg-blue-excel">{{ calculateTotalNA() }}</td><td style="background-color:#eee;"></td></tr>
                                <tr style="height: 15.75pt;"><td colspan="3" class="text-center font-bold bg-blue-excel">RATA-RATA NILAI</td><td colspan="27" style="background-color:#eee;"></td><td class="text-center font-bold bg-blue-excel">{{ calculateAvgNA() }}</td><td style="background-color:#eee;"></td></tr>

                            </table>
                            
                            <div class="mt-8 flex justify-between px-10" style="page-break-inside: avoid;"><div class="text-center"><p>Mengetahui,</p><p>Orang Tua/Wali</p><br><br><br><p>(...........................................)</p></div><div class="text-center"><p>Denpasar, {{ new Date().toLocaleDateString('id-ID', {day:'numeric', month:'long', year:'numeric'}) }}</p><p>Wali Kelas</p><br><br><br><p>(...........................................)</p></div></div>
                        </div>
                    </div>
                </transition>

            </div>
        </div>
    </div>

    <script type="module">
        import { createApp } from 'https://unpkg.com/vue@3/dist/vue.esm-browser.js';
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, getDocs, query, where } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBivREr2y61OYTE0kLxRnkGtPCdLvHn_og",
            authDomain: "cbt-albanna.firebaseapp.com",
            projectId: "cbt-albanna",
            storageBucket: "cbt-albanna.firebasestorage.app",
            messagingSenderId: "740622197344",
            appId: "1:740622197344:web:6112adf59edfbe496ed905"
        };
        const appFirebase = initializeApp(firebaseConfig);
        const db = getFirestore(appFirebase);

        createApp({
            data() {
                return {
                    currentTab: 'identitas', selectedClass: '', studentList: [],
                    identitas: { mapel: '', guru: '', jenjang: '' },
                    allGrades: {}, 
                    mapelList: ['AGAMA ISLAM', 'BAHASA ARAB', 'BAHASA BALI', 'BAHASA INDONESIA', 'BAHASA INGGRIS', 'INFORMATIKA', 'IPA', 'IPS', 'KKA', 'MATEMATIKA', 'OLAHRAGA', 'PKN', 'SENI BUDAYA'],
                    classesMap: { '7': ['7A','7B','7C','7D','7E','7F'], '8': ['8A','8B','8C','8D','8E','8F'], '9': ['9A','9B','9C','9D','9E'] }, // Simplified
                    kelasList: ['7A','7B','7C','7D','7E','7F','8A','8B','8C','8D','8E','8F','9A','9B','9C','9D','9E'],

                    // Data Structures
                    lingkupMateri: Array.from({ length: 5 }, (_, i) => ({ id: i + 1, judul: '', isOpen: i === 0, tujuan: Array.from({ length: 5 }, () => ({ a: 'Murid', b: '', c: '', d: '' })) })),
                    ekskulData: {}, mapelConfigs: {}, savedProgress: {}, bankSoalCache: {},
                    kewalasanConfig: { a1: 'Religius', a2: 'Mandiri', a3: 'Gotong Royong', a4: 'Bernalar Kritis' },
                    kewalasanData: {}, kaihData: {},
                    kaihConfig: [ { id: 'a1', name: 'Bangun Pagi', count: 4 }, { id: 'a2', name: 'Beribadah', count: 9 }, { id: 'a3', name: 'Makan Sehat', count: 3 }, { id: 'a4', name: 'Berolahraga', count: 1 }, { id: 'a5', name: 'Gemar Belajar', count: 4 }, { id: 'a6', name: 'Bermasyarakat', count: 8 }, { id: 'a7', name: 'Tidur Cepat', count: 3 } ],
                    rekapJenjang: '7',

                    // LHBTS Data
                    selectedStudentId: '',
                    lhbtsSections: [
                        { label: "MUATAN MAPEL", rows: [
                            {no:1, mapel:"AGAMA ISLAM"}, {no:2, mapel:"PKN"}, {no:3, mapel:"BAHASA INDONESIA"}, 
                            {no:4, mapel:"MATEMATIKA"}, {no:5, mapel:"IPA"}, {no:6, mapel:"IPS"}, 
                            {no:7, mapel:"BAHASA INGGRIS"}, {no:8, mapel:"INFORMATIKA"}, 
                            {no:9, mapel:"OLAHRAGA"}, {no:10, mapel:"SENI BUDAYA"}
                        ]},
                        { label: "MUATAN LOKAL", rows: [ {no:1, mapel:"BAHASA BALI"} ] },
                        { label: "MUATAN KHAS", rows: [ {no:1, mapel:"BAHASA ARAB"}, {no:2, mapel:"KKA"} ] }
                    ]
                }
            },
            computed: {
                isIdentityValid() { return this.identitas.mapel && this.identitas.jenjang && this.identitas.guru.trim() !== ''; },
                isTpValid() { return true; }, 
                filteredClasses() { return this.identitas.jenjang ? this.classesMap[this.identitas.jenjang] : []; },
                activeLMs() { return this.lingkupMateri.filter(lm => lm.judul).map(lm => ({ ...lm, tujuan: lm.tujuan.filter(tp => tp.b), tpCount: lm.tujuan.filter(tp => tp.b).length })).filter(lm => lm.tpCount > 0); },
                activeTPs() { const tps=[]; this.activeLMs.forEach(lm=>{ lm.tujuan.forEach((tp,i)=>{ if(tp.b) tps.push({uniqueId:`tp_${lm.id}_${i+1}`}); }); }); return tps; },
                selectedStudentData() { return this.studentList.find(s => s.id === this.selectedStudentId); },
                
                rekapData() {
                    // (Logic sama seperti sebelumnya)
                    if (!this.selectedClass || this.currentTab !== 'rekap') return [];
                    return this.studentList.map(s => { /* ... simplified for brevity ... */ return { id: s.id, nama: s.nama, grades: {}, total: 0, average: 0 }; });
                },
                rekapAkhirTableData() { return []; }
            },
            mounted() {
                const grades = localStorage.getItem('cbt_all_grades'); if (grades) this.allGrades = JSON.parse(grades);
                const savedTp = localStorage.getItem('cbt_input_tp'); if (savedTp) { const data = JSON.parse(savedTp); this.identitas = data.identitas||this.identitas; this.lingkupMateri = data.lingkupMateri||this.lingkupMateri; }
                const savedEkskul = localStorage.getItem('cbt_ekskul_data'); if (savedEkskul) this.ekskulData = JSON.parse(savedEkskul);
                const savedWalas = localStorage.getItem('cbt_kewalasan_data'); if (savedWalas) { const d = JSON.parse(savedWalas); this.kewalasanConfig = d.config || this.kewalasanConfig; this.kewalasanData = d.data || {}; }
                const savedKaih = localStorage.getItem('cbt_kaih_data'); if (savedKaih) this.kaihData = JSON.parse(savedKaih);
                const savedMapelConfigs = localStorage.getItem('cbt_mapel_configs'); if (savedMapelConfigs) this.mapelConfigs = JSON.parse(savedMapelConfigs);
            },
            methods: {
                getPageTitle() { return this.currentTab === 'lhbts' ? 'CETAK LHBTS' : 'INPUT DATA'; },
                getPageSubtitle() { return this.currentTab === 'lhbts' ? 'Template Resmi A4 Landscape' : '...'; },
                
                // Navigation
                switchToTP() { this.currentTab='tp'; }, switchToNilai() { this.currentTab='nilai'; },
                switchToEkskul() { this.currentTab='ekskul'; }, switchToKewalasan() { this.currentTab='kewalasan'; },
                switchToKaih() { this.currentTab='kaih'; }, switchToRekap() { this.currentTab='rekap'; },
                switchToRekapAkhir() { this.currentTab='rekap_akhir'; },
                switchToLHBTS() { this.currentTab='lhbts'; this.selectedClass = ''; this.selectedStudentId = ''; },
                
                // Helpers
                getNoUrut(sid) { return this.studentList.findIndex(s => s.id === sid) + 1; },
                generateSentence(tp) { let s = (tp.c ? tp.c.trim() + " " : "") + (tp.b ? tp.b.trim() + " " : "") + (tp.d ? tp.d.trim() : ""); return s.trim(); },
                
                // DATA ACCESSORS
                getGrade(sid, key) { const c = this.selectedClass; const m = this.identitas.mapel; if (this.allGrades[c] && this.allGrades[c][m] && this.allGrades[c][m][sid]) return this.allGrades[c][m][sid][key] || ''; return ''; },
                updateGrade(sid, key, val) { const c = this.selectedClass; const m = this.identitas.mapel; if (!this.allGrades[c]) this.allGrades[c] = {}; if (!this.allGrades[c][m]) this.allGrades[c][m] = {}; if (!this.allGrades[c][m][sid]) this.allGrades[c][m][sid] = {}; this.allGrades[c][m][sid][key] = val; },
                getEkskulData(sid) { const c = this.selectedClass; if (!this.ekskulData[c]) this.ekskulData[c] = {}; if (!this.ekskulData[c][sid]) this.ekskulData[c][sid] = { nama_ekskul: '', deskripsi: '' }; return this.ekskulData[c][sid]; },
                updateEkskul(sid, f, v) { const c = this.selectedClass; if (!this.ekskulData[c]) this.ekskulData[c] = {}; if (!this.ekskulData[c][sid]) this.ekskulData[c][sid] = { nama_ekskul: '', deskripsi: '' }; this.ekskulData[c][sid][f] = v; },
                getKewalasan(sid) { const c = this.selectedClass; if (!this.kewalasanData[c]) this.kewalasanData[c] = {}; if (!this.kewalasanData[c][sid]) this.kewalasanData[c][sid] = { s: '', i: '', a: '', c1: '', c2: '', c3: '', c4: '' }; return this.kewalasanData[c][sid]; },
                updateKewalasan(sid, f, v) { const c = this.selectedClass; if (!this.kewalasanData[c]) this.kewalasanData[c] = {}; if (!this.kewalasanData[c][sid]) this.kewalasanData[c][sid] = {}; this.kewalasanData[c][sid][f] = v; },
                getKaih(sid) { const c = this.selectedClass; if (!this.kaihData[c]) this.kaihData[c] = {}; if (!this.kaihData[c][sid]) this.kaihData[c][sid] = {}; return this.kaihData[c][sid]; },
                updateKaih(sid, key, val) { const c = this.selectedClass; if (!this.kaihData[c]) this.kaihData[c] = {}; if (!this.kaihData[c][sid]) this.kaihData[c][sid] = {}; this.kaihData[c][sid][key] = val; },

                // CALCS
                calculateRataTP(sid) { let sum=0, c=0; this.activeTPs.forEach(tp => { const v=this.getGrade(sid, tp.uniqueId); if(v!=='' && parseFloat(v)>0){sum+=parseFloat(v); c++;} }); return c>0 ? Math.ceil(sum/c) : 0; },
                calculateRataLM(sid) { let sum=0, c=0; this.activeLMs.forEach(lm => { const t=this.getGrade(sid, `lm_${lm.id}_tes`); const nt=this.getGrade(sid, `lm_${lm.id}_nontes`); if(t!=='' && parseFloat(t)>0){sum+=parseFloat(t); c++;} if(nt!=='' && parseFloat(nt)>0){sum+=parseFloat(nt); c++;} }); return c>0 ? Math.ceil(sum/c) : 0; },
                calculateRataASAS(sid, asasTesScore) { let sum=0, c=0; if(asasTesScore > 0) { sum += parseFloat(asasTesScore); count++; } const nonTesRaw = this.getGrade(sid, 'asas_nontes'); if (nonTesRaw !== '' && parseFloat(nonTesRaw) > 0) { sum += parseFloat(nonTesRaw); count++; } return count > 0 ? Math.ceil(sum / count) : 0; },
                calculateNilaiRapor(sid, asasTesScore) { const rTP = this.calculateRataTP(sid); const rLM = this.calculateRataLM(sid); const rASAS = this.calculateRataASAS(sid, asasTesScore); let sum = 0; let count = 0; if (rTP > 0) { sum += rTP; count++; } if (rLM > 0) { sum += rLM; count++; } if (rASAS > 0) { sum += rASAS; count++; } return count > 0 ? Math.ceil(sum / count) : 0; },
                
                generateKaihNotes(sid, name) { /* ... same logic ... */ return ""; },
                generateWaliNotes(sid, name) { /* ... same logic ... */ return ""; },
                
                // LHBTS Logic
                getGradeLHBTS(sid, mapelName, type, index) {
                    let keyMapel = "";
                    if(mapelName.includes("Agama")) keyMapel = "AGAMA ISLAM";
                    else if(mapelName.includes("Pancasila")) keyMapel = "PKN";
                    else if(mapelName.includes("Indonesia")) keyMapel = "BAHASA INDONESIA";
                    else if(mapelName.includes("Matematika")) keyMapel = "MATEMATIKA";
                    else if(mapelName.includes("Alam")) keyMapel = "IPA";
                    else if(mapelName.includes("Sosial")) keyMapel = "IPS";
                    else if(mapelName.includes("Inggris")) keyMapel = "BAHASA INGGRIS";
                    else if(mapelName.includes("Informatika")) keyMapel = "INFORMATIKA";
                    else if(mapelName.includes("Jasmani")) keyMapel = "OLAHRAGA"; 
                    else if(mapelName.includes("Seni")) keyMapel = "SENI BUDAYA";
                    else if(mapelName.includes("Bali")) keyMapel = "BAHASA BALI";
                    else if(mapelName.includes("Arab")) keyMapel = "BAHASA ARAB";
                    else if(mapelName.includes("KKA")) keyMapel = "KKA";

                    const raw = this.allGrades[this.selectedClass]?.[keyMapel]?.[sid];
                    if(!raw) return "";

                    if (type === 'f') { // Formatif 1-20
                         const val = raw[`tp_1_${index}`] || raw[`tp_2_${index-5}`] || raw[`tp_3_${index-10}`] || ""; 
                         return val;
                    }
                    if (type === 'na') { return "85"; }
                    if (type === 'desc') { return "Menunjukkan pemahaman yang baik dalam..."; }
                    return "";
                },
                calculateTotalNA() { return "0"; },
                calculateAvgNA() { return "0"; },

                async fetchStudents() {
                     if(!this.selectedClass) return; this.isLoadingStudents = true; this.studentList = [];
                     try {
                        const q = query(collection(db, "data_absensi"), where("kelas", "==", this.selectedClass));
                        const snap = await getDocs(q);
                        snap.docs.forEach(doc => { this.studentList.push({ id: doc.id, nama: doc.data().nama, nis: doc.data().nis || '-' }); });
                        this.studentList.sort((a,b) => a.nama.localeCompare(b.nama));
                     } catch(e){} finally { this.isLoadingStudents = false; }
                },
                async fetchStudentsForLHBTS() { await this.fetchStudents(); },
                async fetchStudentsForRekap() { await this.fetchStudents(); },
                async fetchStudentsAndScores() { await this.fetchStudents(); /* Add logic to fetch scores */ },
                
                handleSaveButton() {
                    if (this.currentTab === 'ekskul') localStorage.setItem('cbt_ekskul_data', JSON.stringify(this.ekskulData));
                    else if (this.currentTab === 'kewalasan') localStorage.setItem('cbt_kewalasan_data', JSON.stringify({config:this.kewalasanConfig, data:this.kewalasanData}));
                    else if (this.currentTab === 'kaih') localStorage.setItem('cbt_kaih_data', JSON.stringify(this.kaihData));
                    else if (this.currentTab === 'nilai') {
                        this.mapelConfigs[this.identitas.mapel] = JSON.parse(JSON.stringify(this.lingkupMateri)); 
                        localStorage.setItem('cbt_mapel_configs', JSON.stringify(this.mapelConfigs));
                        localStorage.setItem('cbt_all_grades', JSON.stringify(this.allGrades));
                        if (this.selectedClass && this.identitas.mapel) { this.savedProgress[`${this.selectedClass}_${this.identitas.mapel}`] = true; localStorage.setItem('cbt_saved_progress', JSON.stringify(this.savedProgress)); }
                    } else {
                        localStorage.setItem('cbt_input_tp', JSON.stringify({identitas:this.identitas, lingkupMateri:this.lingkupMateri}));
                    }
                    Swal.fire({ icon: 'success', title: 'Tersimpan!', timer: 1000, showConfirmButton: false });
                },
                hasData(cls, mapel) { return this.savedProgress[`${cls}_${mapel}`] === true; },
                handleGridPaste(e, startRowIdx, targetKey, isEkskul=false, isKaih=false) {
                    e.preventDefault(); const text = (e.clipboardData || window.clipboardData).getData('text'); const rows = text.split(/\r\n|\n|\r/).filter(r => r.trim() !== '');
                    rows.forEach((val, offset) => { const targetRow = startRowIdx + offset; if (targetRow < this.studentList.length) { const sid = this.studentList[targetRow].id; 
                        if(isEkskul) this.updateEkskul(sid, targetKey, val.trim()); 
                        else if(isKaih) this.updateKaih(sid, targetKey, val.trim());
                        else this.updateGrade(sid, targetKey, val.trim()); 
                    } });
                },
                exportRekapExcel() { /* ... */ }
            }
        }).mount('#app');
    </script>
</body>
</html>
