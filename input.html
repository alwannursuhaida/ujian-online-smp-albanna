<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>E-Rapor Guru - SMP ALBANNA</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üìù</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Montserrat', sans-serif; }
        .input-abcd:focus { ring: 2px solid #3b82f6; transform: scale(1.005); }
        .fade-enter-active, .fade-leave-active { transition: opacity 0.3s ease; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
        
        /* Excel Table Styles */
        .excel-table th, .excel-table td { border: 1px solid #e2e8f0; }
        .excel-input { width: 100%; height: 100%; padding: 4px; border: none; outline: none; text-align: center; background: transparent; font-family: monospace; font-weight: bold; font-size: 11px; }
        .excel-input.text-left { text-align: left; padding-left: 8px; }
        .excel-input:focus { background: #eff6ff; box-shadow: inset 0 0 0 2px #3b82f6; }
        .input-error { background-color: #fee2e2 !important; color: #dc2626 !important; }
        
        /* Sticky Column Logic */
        .sticky-col { position: sticky; left: 0; z-index: 20; background-color: #f8fafc; border-right: 2px solid #e2e8f0; }
        .sticky-col-2 { position: sticky; left: 40px; z-index: 20; background-color: #f8fafc; border-right: 2px solid #e2e8f0; }
        .sticky-col-3 { position: sticky; left: 240px; z-index: 20; background-color: #f8fafc; border-right: 2px solid #e2e8f0; }
        .sticky-right { position: sticky; right: 0; z-index: 20; border-left: 2px solid #e2e8f0; }
        
        /* Header Colors */
        .header-lm { background-color: #f1f5f9; border-left: 2px solid #94a3b8; }
        .header-asas { background-color: #fff7ed; border-left: 2px solid #ea580c; }
        .header-avg { background-color: #ecfdf5; border-left: 2px solid #059669; }
        .header-rapor { background-color: #eff6ff; border-left: 2px solid #2563eb; color: #1e40af; }
        .header-ekskul-1 { background-color: #fff7ed; border-left: 2px solid #ea580c; color: #9a3412; }
        .header-ekskul-2 { background-color: #f0fdf4; border-left: 2px solid #16a34a; color: #166534; }
        .header-ekskul-3 { background-color: #eff6ff; border-left: 2px solid #2563eb; color: #1e40af; }
        
        .input-readonly { background-color: #f3f4f6; color: #4b5563; cursor: not-allowed; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">

    <div id="app" class="flex h-screen overflow-hidden">
        
        <div class="w-64 bg-slate-900 text-white flex flex-col h-full shadow-2xl z-20 shrink-0">
            <div class="p-6 text-center border-b border-slate-700 bg-slate-800">
                <h1 class="font-bold text-xl tracking-wider">E-RAPOR</h1>
                <p class="text-xs text-slate-400 mt-1">GURU & WALI KELAS</p>
            </div>
            
            <nav class="flex-1 p-4 space-y-2 overflow-y-auto">
                <div class="text-[10px] font-bold text-slate-500 uppercase mb-1 ml-2 tracking-wider">Guru Mapel</div>
                <button @click="currentTab = 'identitas'" :class="['w-full text-left px-4 py-3 rounded transition flex items-center gap-3', currentTab === 'identitas' ? 'bg-blue-600 text-white shadow-lg' : 'hover:bg-slate-800 text-slate-400']"><i class="fas fa-id-card w-5"></i> Identitas Pelajaran</button>
                <button @click="switchToTP" :class="['w-full text-left px-4 py-3 rounded transition flex items-center gap-3', currentTab === 'tp' ? 'bg-blue-600 text-white shadow-lg' : 'hover:bg-slate-800 text-slate-400']"><i class="fas fa-bullseye w-5"></i> Penyusunan TP <i v-if="!isIdentityValid" class="fas fa-lock text-xs ml-auto opacity-50"></i></button>
                <button @click="switchToNilai" :class="['w-full text-left px-4 py-3 rounded transition flex items-center gap-3', currentTab === 'nilai' ? 'bg-blue-600 text-white shadow-lg' : 'hover:bg-slate-800 text-slate-400']"><i class="fas fa-edit w-5"></i> Input Nilai <i v-if="!isTpValid" class="fas fa-lock text-xs ml-auto opacity-50"></i></button>
                
                <div class="border-t border-slate-700 my-2"></div>
                
                <div class="text-[10px] font-bold text-slate-500 uppercase mb-1 ml-2 tracking-wider">Wali Kelas</div>
                <button @click="switchToEkskul" :class="['w-full text-left px-4 py-3 rounded transition flex items-center gap-3', currentTab === 'ekskul' ? 'bg-orange-600 text-white shadow-lg' : 'hover:bg-slate-800 text-slate-400']"><i class="fas fa-futbol w-5"></i> Input Ekskul</button>
                <button @click="switchToKewalasan" :class="['w-full text-left px-4 py-3 rounded transition flex items-center gap-3', currentTab === 'kewalasan' ? 'bg-teal-600 text-white shadow-lg' : 'hover:bg-slate-800 text-slate-400']"><i class="fas fa-user-graduate w-5"></i> Kewalasan</button>
                <button @click="switchToKaih" :class="['w-full text-left px-4 py-3 rounded transition flex items-center gap-3', currentTab === 'kaih' ? 'bg-cyan-600 text-white shadow-lg' : 'hover:bg-slate-800 text-slate-400']"><i class="fas fa-star w-5"></i> Input 7 KAIH</button>
                
                <div class="border-t border-slate-700 my-2"></div>
                <button @click="currentTab = 'monitoring'" :class="['w-full text-left px-4 py-3 rounded transition flex items-center gap-3', currentTab === 'monitoring' ? 'bg-indigo-600 text-white shadow-lg' : 'hover:bg-slate-800 text-slate-400']"><i class="fas fa-chart-line w-5"></i> Monitoring Input</button>
                <button @click="switchToRekap" :class="['w-full text-left px-4 py-3 rounded transition flex items-center gap-3', currentTab === 'rekap' ? 'bg-emerald-600 text-white shadow-lg' : 'hover:bg-slate-800 text-slate-400']"><i class="fas fa-trophy w-5"></i> Rekapitulasi Nilai</button>
                <button @click="switchToRekapAkhir" :class="['w-full text-left px-4 py-3 rounded transition flex items-center gap-3', currentTab === 'rekap_akhir' ? 'bg-purple-600 text-white shadow-lg' : 'hover:bg-slate-800 text-slate-400']"><i class="fas fa-file-invoice w-5"></i> Cetak Rapor</button>
            </nav>
            <div class="p-4 border-t border-slate-800"><a href="index.html" class="w-full text-center text-xs text-gray-400 hover:text-white font-bold flex items-center justify-center gap-2 p-2 hover:bg-slate-800 rounded transition"><i class="fas fa-home"></i> KEMBALI KE MENU</a></div>
        </div>

        <div class="flex-1 flex flex-col h-full overflow-hidden bg-gray-50 relative">
            <div class="bg-white p-4 shadow-sm border-b flex justify-between items-center px-8 z-10">
                <div><h2 class="text-2xl font-bold text-slate-800 uppercase">{{ getPageTitle() }}</h2><p class="text-xs text-gray-500">{{ getPageSubtitle() }}</p></div>
                
                <button v-if="['identitas','tp','nilai','ekskul','kewalasan','kaih'].includes(currentTab)" @click="handleSaveButton" class="bg-green-600 text-white px-6 py-2 rounded-lg font-bold shadow hover:bg-green-700 transition flex items-center gap-2"><i class="fas fa-save"></i> SIMPAN PROGRES</button>
                
                <button v-if="currentTab === 'rekap'" @click="exportRekapExcel" class="bg-emerald-600 text-white px-6 py-2 rounded-lg font-bold shadow hover:bg-emerald-700 transition flex items-center gap-2"><i class="fas fa-file-excel"></i> UNDUH LENGKAP</button>
                
                <div v-if="currentTab === 'rekap_akhir'" class="flex gap-2 items-center">
                    <div class="flex flex-col">
                        <label class="text-[10px] text-gray-500 font-bold">MODE UNDUH</label>
                        <select v-model="downloadMode" class="bg-gray-50 border border-gray-300 text-gray-900 text-xs rounded-lg focus:ring-purple-500 focus:border-purple-500 block p-1">
                            <option value="batch">ZIP (File Terpisah)</option>
                            <option value="combine">GABUNG (1 File)</option>
                        </select>
                    </div>
                    <button @click="generateRaporBackend('xlsx')" :disabled="isProcessingDownload" :class="['text-white px-4 py-2 rounded-lg font-bold shadow transition flex items-center gap-2 text-xs', isProcessingDownload ? 'bg-gray-400' : 'bg-green-600 hover:bg-green-700']">
                        <i v-if="isProcessingDownload" class="fas fa-spinner fa-spin"></i>
                        <i v-else class="fas fa-file-excel"></i> 
                        {{ isProcessingDownload ? 'MEMPROSES...' : 'XLSX RAPOR' }}
                    </button>
                    <button @click="generateRaporBackend('pdf')" :disabled="isProcessingDownload" :class="['text-white px-4 py-2 rounded-lg font-bold shadow transition flex items-center gap-2 text-xs', isProcessingDownload ? 'bg-gray-400' : 'bg-red-600 hover:bg-red-700']">
                        <i v-if="isProcessingDownload" class="fas fa-spinner fa-spin"></i>
                        <i v-else class="fas fa-file-pdf"></i> 
                        {{ isProcessingDownload ? 'MEMPROSES...' : 'PDF RAPOR' }}
                    </button>
                </div>
            </div>

            <div class="flex-1 overflow-y-auto p-8 pb-32">
                
                <transition name="fade"><div v-if="currentTab === 'identitas'"><div class="bg-white p-8 rounded-xl shadow-lg border border-indigo-100 max-w-3xl mx-auto mt-10"><div class="text-center mb-8"><div class="bg-indigo-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4 text-indigo-600"><i class="fas fa-book-reader fa-2x"></i></div><h3 class="text-xl font-bold text-slate-800">Lengkapi Data Awal</h3></div><div class="space-y-6"><div><label class="block text-sm font-bold text-gray-600 uppercase mb-2">Pilih Mata Pelajaran <span class="text-red-500">*</span></label><select v-model="identitas.mapel" class="w-full p-4 border-2 border-indigo-100 rounded-xl bg-indigo-50/30 focus:border-indigo-500 outline-none font-bold text-slate-800"><option value="" disabled>-- Pilih Mapel --</option><option v-for="m in mapelList" :value="m">{{ m }}</option></select></div><div><label class="block text-sm font-bold text-gray-600 uppercase mb-2">Jenjang Kelas <span class="text-red-500">*</span></label><select v-model="identitas.jenjang" class="w-full p-4 border-2 border-indigo-100 rounded-xl bg-indigo-50/30 focus:border-indigo-500 outline-none font-bold text-slate-800"><option value="" disabled>-- Pilih Jenjang --</option><option value="7">Kelas 7</option><option value="8">Kelas 8</option><option value="9">Kelas 9</option></select></div><div><label class="block text-sm font-bold text-gray-600 uppercase mb-2">Nama Guru Pengampu <span class="text-red-500">*</span></label><input v-model="identitas.guru" class="w-full pl-4 p-4 border-2 border-gray-200 rounded-xl focus:border-indigo-500 outline-none text-slate-800" placeholder="Nama Lengkap & Gelar"></div><div class="pt-4"><button @click="switchToTP" class="w-full bg-indigo-600 text-white py-4 rounded-xl font-bold hover:bg-indigo-700 transition shadow-lg flex justify-center items-center gap-2">MULAI MENYUSUN TP <i class="fas fa-arrow-right"></i></button></div></div></div></div></transition>

                <transition name="fade"><div v-if="currentTab === 'tp'"><div class="mb-6 flex items-center gap-2 bg-indigo-50 px-4 py-2 rounded-lg border border-indigo-200 w-fit"><span class="font-bold text-indigo-900 text-sm">{{ identitas.mapel }}</span><span class="text-gray-400">|</span><span class="font-bold text-indigo-900 text-sm">Jenjang {{ identitas.jenjang }}</span></div><div v-for="(lm, lmIndex) in lingkupMateri" :key="lm.id" class="mb-8 bg-white rounded-xl shadow border border-slate-200 overflow-hidden"><div class="bg-slate-100 p-4 border-b flex items-center gap-4 cursor-pointer" @click="lm.isOpen = !lm.isOpen"><div class="bg-indigo-600 text-white w-8 h-8 flex items-center justify-center rounded-full font-bold text-sm">{{ lmIndex + 1 }}</div><div class="flex-1" @click.stop><input v-model="lm.judul" class="w-full p-2 bg-transparent border-b-2 border-slate-300 focus:border-indigo-600 outline-none font-bold" :placeholder="'Lingkup Materi ' + (lmIndex + 1)"></div><i :class="['fas text-slate-400', lm.isOpen ? 'fa-chevron-up' : 'fa-chevron-down']"></i></div><div v-show="lm.isOpen" class="p-6 space-y-6 bg-slate-50/30"><div v-for="(tp, tpIndex) in lm.tujuan" :key="tpIndex" class="relative group border-b border-slate-100 pb-4"><h4 class="font-bold text-xs text-slate-500 mb-2">TP {{ lmIndex + 1 }}.{{ tpIndex + 1 }}</h4><div class="grid grid-cols-1 md:grid-cols-12 gap-2 mb-2"><div class="md:col-span-1"><input v-model="tp.a" readonly class="w-full p-2 border rounded bg-gray-100 text-center text-xs font-bold"></div><div class="md:col-span-5"><textarea v-model="tp.b" rows="1" class="input-abcd w-full p-2 border rounded text-xs" placeholder="Behavior (KKO + Materi)"></textarea></div><div class="md:col-span-3"><textarea v-model="tp.c" rows="1" class="input-abcd w-full p-2 border rounded text-xs" placeholder="Condition (Melalui...)"></textarea></div><div class="md:col-span-3"><textarea v-model="tp.d" rows="1" class="input-abcd w-full p-2 border rounded text-xs" placeholder="Degree (Kriteria)"></textarea></div></div><div class="bg-indigo-50 p-2 rounded border border-indigo-100 flex items-center gap-2"><i class="fas fa-magic text-indigo-400 text-xs"></i><p class="text-xs text-indigo-900 italic font-medium">"{{ generateSentence(tp) }}"</p></div></div></div></div></div></transition>

                <transition name="fade"><div v-if="currentTab === 'nilai'"><div class="bg-white p-4 rounded-xl shadow border mb-6 flex flex-col md:flex-row justify-between items-center gap-4"><div class="w-full md:w-1/3"><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Pilih Kelas</label><select v-model="selectedClass" @change="fetchStudentsAndScores" class="w-full p-2 border-2 border-blue-200 rounded font-bold text-blue-900"><option value="" disabled>-- Pilih Kelas --</option><option v-for="c in filteredClasses" :value="c">{{ c }}</option></select></div><div class="text-right text-xs text-gray-500"><p><strong>Mapel:</strong> {{ identitas.mapel }}</p><p class="text-green-600 font-bold" v-if="lastSavedGrade">Tersimpan: {{ lastSavedGrade }}</p></div></div><div class="bg-white rounded-xl shadow border overflow-hidden relative"><div v-if="!selectedClass" class="p-10 text-center text-gray-400"><i class="fas fa-arrow-up fa-2x mb-2"></i><br>Pilih kelas dulu.</div><div v-else-if="isLoadingStudents" class="p-10 text-center text-blue-500"><i class="fas fa-circle-notch fa-spin fa-2x"></i></div><div v-else class="overflow-x-auto"><table class="w-full text-left border-collapse excel-table text-sm"><thead><tr class="bg-slate-800 text-white"><th class="p-3 w-10 text-center sticky-col bg-slate-800" rowspan="2">No</th><th class="p-3 w-64 sticky-col-2 bg-slate-800 left-10" rowspan="2">Nama Siswa</th><template v-for="lm in activeLMs" :key="lm.id"><th :colspan="lm.tpCount + 2" class="p-2 text-center text-xs font-bold header-lm text-slate-800">{{ lm.judul || 'LM ' + lm.id }}</th></template><th colspan="2" class="p-2 text-center text-xs font-bold header-asas text-orange-800">ASAS</th><th colspan="3" class="p-2 text-center text-xs font-bold header-avg text-green-800">RATA-RATA</th><th rowspan="2" class="p-2 text-center text-xs font-bold header-rapor">Nilai Akhir (Rapor)</th></tr><tr class="bg-slate-100 text-slate-600"><template v-for="lm in activeLMs" :key="lm.id"><template v-for="(tp, idx) in lm.tujuan" :key="lm.id + '_' + idx"><th class="p-2 text-center text-[10px] w-16 border-l" :title="generateSentence(tp)">TP {{ lm.id }}.{{ idx+1 }}</th></template><th class="p-2 text-center text-[10px] w-14 bg-blue-50 font-bold border-l-2">LM Tes</th><th class="p-2 text-center text-[10px] w-14 bg-blue-50 font-bold">LM Non</th></template><th class="p-2 text-center text-[10px] w-16 bg-orange-50 font-bold">Tes</th><th class="p-2 text-center text-[10px] w-16 bg-orange-50 font-bold">Non</th><th class="p-2 text-center text-[10px] w-12 bg-green-50 font-bold">TP</th><th class="p-2 text-center text-[10px] w-12 bg-green-50 font-bold">LM</th><th class="p-2 text-center text-[10px] w-12 bg-green-50 font-bold">ASAS</th></tr></thead><tbody class="bg-white"><tr v-for="(s, sIdx) in studentList" :key="s.id" class="hover:bg-blue-50"><td class="text-center bg-gray-50 text-gray-500 select-none sticky-col left-0">{{ sIdx + 1 }}</td><td class="px-3 py-2 font-bold text-gray-700 select-none whitespace-nowrap sticky-col-2 bg-white left-10">{{ s.nama }}</td><template v-for="lm in activeLMs" :key="lm.id"><template v-for="(tp, idx) in lm.tujuan" :key="lm.id + '_' + idx"><td class="p-0"><input type="text" :class="['excel-input', getValidationClass(getGrade(s.id, `tp_${lm.id}_${idx+1}` ))]" :value="getGrade(s.id, `tp_${lm.id}_${idx+1}` )" @input="updateGrade(s.id, `tp_${lm.id}_${idx+1}`, $event.target.value)" @paste="handleGridPaste($event, sIdx, `tp_${lm.id}_${idx+1}`)"></td></template><td class="p-0 bg-blue-50/20 border-l-2"><input type="text" :class="['excel-input font-bold text-blue-700', getValidationClass(getGrade(s.id, `lm_${lm.id}_tes`))]" :value="getGrade(s.id, `lm_${lm.id}_tes`)" @input="updateGrade(s.id, `lm_${lm.id}_tes`, $event.target.value)"></td><td class="p-0 bg-blue-50/20"><input type="text" :class="['excel-input font-bold text-blue-700', getValidationClass(getGrade(s.id, `lm_${lm.id}_nontes`))]" :value="getGrade(s.id, `lm_${lm.id}_nontes`)" @input="updateGrade(s.id, `lm_${lm.id}_nontes`, $event.target.value)"></td></template><td class="p-0 bg-orange-50/30 border-l-2"><input type="text" class="excel-input font-bold text-orange-700 bg-orange-100 cursor-not-allowed" :value="s.asasTesScore" readonly></td><td class="p-0 bg-orange-50/30"><input type="text" :class="['excel-input font-bold text-orange-700', getValidationClass(getGrade(s.id, 'asas_nontes'))]" :value="getGrade(s.id, 'asas_nontes')" @input="updateGrade(s.id, 'asas_nontes', $event.target.value)"></td><td class="p-0 bg-green-50/30 text-center font-bold text-green-800 border-l-2">{{ calculateRataTP(s.id) }}</td><td class="p-0 bg-green-50/30 text-center font-bold text-green-800">{{ calculateRataLM(s.id) }}</td><td class="p-0 bg-green-50/30 text-center font-bold text-green-800">{{ calculateRataASAS(s.id, s.asasTesScore) }}</td><td class="p-0 bg-blue-100 text-center font-extrabold text-blue-900 border-l-2">{{ calculateNilaiRapor(s.id, s.asasTesScore) }}</td></tr></tbody></table></div></div></div></transition>

                <transition name="fade">
                    <div v-if="currentTab === 'ekskul'">
                        <div class="bg-white p-4 rounded-xl shadow border mb-6 flex flex-col md:flex-row justify-between items-center gap-4">
                            <div class="w-full md:w-1/3">
                                <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Pilih Kelas (Wali Kelas)</label>
                                <select v-model="selectedClass" @change="fetchStudents" class="w-full p-2 border-2 border-orange-200 rounded font-bold text-orange-900"><option value="" disabled>-- Pilih Kelas --</option><option v-for="c in filteredClasses" :value="c">{{ c }}</option></select>
                            </div>
                            <div class="text-right text-xs text-gray-500"><p><strong>Jenjang:</strong> Kelas {{ identitas.jenjang }}</p><p class="text-orange-600 italic">Khusus Wali Kelas</p></div>
                        </div>
                        <div class="bg-white rounded-xl shadow border overflow-hidden relative">
                            <div v-if="!selectedClass" class="p-10 text-center text-gray-400">Pilih kelas perwalian Anda.</div>
                            <div v-else class="overflow-x-auto">
                                <table class="w-full text-left border-collapse excel-table text-sm">
                                    <thead><tr class="bg-orange-800 text-white"><th class="p-3 w-10 text-center sticky-col bg-orange-800" rowspan="2">No</th><th class="p-3 w-64 sticky-col-2 bg-orange-800" rowspan="2">Nama Siswa</th><th colspan="2" class="p-2 text-center text-xs font-bold header-ekskul-1">EKSKUL 1 (WAJIB)</th><th colspan="2" class="p-2 text-center text-xs font-bold header-ekskul-2">EKSKUL 2 (OPSIONAL)</th><th colspan="2" class="p-2 text-center text-xs font-bold header-ekskul-3">EKSKUL 3 (OPSIONAL)</th></tr><tr class="text-slate-600 bg-slate-100"><th class="p-2 w-48 text-center text-xs border-l">Nama Kegiatan</th><th class="p-2 w-48 text-center text-xs">Deskripsi / Predikat</th><th class="p-2 w-48 text-center text-xs border-l">Nama Kegiatan</th><th class="p-2 w-48 text-center text-xs">Deskripsi / Predikat</th><th class="p-2 w-48 text-center text-xs border-l">Nama Kegiatan</th><th class="p-2 w-48 text-center text-xs">Deskripsi / Predikat</th></tr></thead>
                                    <tbody class="bg-white">
                                        <tr v-for="(s, sIdx) in studentList" :key="s.id" class="hover:bg-orange-50">
                                            <td class="text-center bg-gray-50 text-gray-500 select-none sticky-col left-0">{{ sIdx + 1 }}</td>
                                            <td class="px-3 py-2 font-bold text-gray-700 select-none whitespace-nowrap sticky-col-2 bg-white left-10">{{ s.nama }}</td>
                                            <td class="p-0 border-l bg-orange-50/50"><input type="text" class="excel-input text-left font-bold text-orange-900 bg-transparent cursor-not-allowed" value="PRAMUKA" readonly></td>
                                            <td class="p-0 bg-orange-50/50"><input type="text" class="excel-input text-left" v-model="getEkskulData(s.id).ek1_desc" @input="updateEkskul(s.id, 'ek1_desc', $event.target.value)" @paste="handleGridPaste($event, sIdx, 'ek1_desc', true)" placeholder="Sangat Baik..."></td>
                                            <td class="p-0 border-l"><input type="text" class="excel-input text-left" v-model="getEkskulData(s.id).ek2_nama" @input="updateEkskul(s.id, 'ek2_nama', $event.target.value)" @paste="handleGridPaste($event, sIdx, 'ek2_nama', true)" placeholder="Nama Ekskul"></td>
                                            <td class="p-0"><input type="text" class="excel-input text-left" v-model="getEkskulData(s.id).ek2_desc" @input="updateEkskul(s.id, 'ek2_desc', $event.target.value)" @paste="handleGridPaste($event, sIdx, 'ek2_desc', true)" placeholder="Predikat..."></td>
                                            <td class="p-0 border-l"><input type="text" class="excel-input text-left" v-model="getEkskulData(s.id).ek3_nama" @input="updateEkskul(s.id, 'ek3_nama', $event.target.value)" @paste="handleGridPaste($event, sIdx, 'ek3_nama', true)" placeholder="Nama Ekskul"></td>
                                            <td class="p-0"><input type="text" class="excel-input text-left" v-model="getEkskulData(s.id).ek3_desc" @input="updateEkskul(s.id, 'ek3_desc', $event.target.value)" @paste="handleGridPaste($event, sIdx, 'ek3_desc', true)" placeholder="Predikat..."></td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </transition>

                <transition name="fade">
                    <div v-if="currentTab === 'kewalasan'">
                        <div class="bg-white p-6 rounded-xl shadow border mb-6">
                            <h3 class="font-bold text-teal-800 text-lg mb-4 flex items-center gap-2">
                                <i class="fas fa-list-ol"></i> Konfigurasi Aspek Nilai Karakter
                            </h3>
                            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                                <div><label class="text-[10px] font-bold text-gray-500 uppercase">Aspek 1</label><input v-model="kewalasanConfig.a1" class="w-full p-2 border rounded text-sm bg-teal-50" placeholder="Religius"></div>
                                <div><label class="text-[10px] font-bold text-gray-500 uppercase">Aspek 2</label><input v-model="kewalasanConfig.a2" class="w-full p-2 border rounded text-sm bg-teal-50" placeholder="Mandiri"></div>
                                <div><label class="text-[10px] font-bold text-gray-500 uppercase">Aspek 3</label><input v-model="kewalasanConfig.a3" class="w-full p-2 border rounded text-sm bg-teal-50" placeholder="Gotong Royong"></div>
                                <div><label class="text-[10px] font-bold text-gray-500 uppercase">Aspek 4</label><input v-model="kewalasanConfig.a4" class="w-full p-2 border rounded text-sm bg-teal-50" placeholder="Bernalar Kritis"></div>
                            </div>
                            <div class="flex items-end gap-4 border-t pt-4">
                                <div class="w-full md:w-1/3"><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Pilih Kelas</label><select v-model="selectedClass" @change="fetchStudents" class="w-full p-2 border-2 border-teal-200 rounded font-bold text-teal-900"><option value="" disabled>-- Pilih Kelas --</option><option v-for="c in filteredClasses" :value="c">{{ c }}</option></select></div>
                                <div class="text-right flex-1 text-xs text-gray-400 italic">Nilai > 90 = Sangat Baik, <= 90 = Baik.</div>
                            </div>
                        </div>
                        <div class="bg-white rounded-xl shadow border overflow-hidden relative">
                            <div v-if="!selectedClass" class="p-10 text-center text-gray-400">Pilih kelas perwalian Anda.</div>
                            <div v-else class="overflow-x-auto">
                                <table class="w-full text-left border-collapse excel-table text-sm">
                                    <thead>
                                        <tr class="bg-teal-800 text-white">
                                            <th class="p-3 w-10 text-center" rowspan="2">No</th>
                                            <th class="p-3 w-64" rowspan="2">Nama Siswa</th>
                                            <th colspan="3" class="p-2 text-center text-xs bg-yellow-600 font-bold border-l">Kehadiran</th>
                                            <th colspan="4" class="p-2 text-center text-xs bg-teal-700 font-bold border-l">Rapor Karakter (Skor 0-100)</th>
                                            <th class="p-3 w-96 text-center bg-gray-800" rowspan="2">Catatan Wali Kelas (Otomatis)</th>
                                        </tr>
                                        <tr class="text-teal-100 bg-teal-900">
                                            <th class="p-1 text-center w-10 bg-yellow-700 border-l text-white">S</th><th class="p-1 text-center w-10 bg-yellow-700 text-white">I</th><th class="p-1 text-center w-10 bg-yellow-700 text-white">A</th>
                                            <th class="p-1 text-center w-24 border-l font-normal text-[10px]">{{ kewalasanConfig.a1 || 'Aspek 1' }}</th>
                                            <th class="p-1 text-center w-24 font-normal text-[10px]">{{ kewalasanConfig.a2 || 'Aspek 2' }}</th>
                                            <th class="p-1 text-center w-24 font-normal text-[10px]">{{ kewalasanConfig.a3 || 'Aspek 3' }}</th>
                                            <th class="p-1 text-center w-24 font-normal text-[10px]">{{ kewalasanConfig.a4 || 'Aspek 4' }}</th>
                                        </tr>
                                    </thead>
                                    <tbody class="bg-white">
                                        <tr v-for="(s, sIdx) in studentList" :key="s.id" class="hover:bg-teal-50">
                                            <td class="text-center bg-gray-50 text-gray-500 select-none">{{ sIdx + 1 }}</td>
                                            <td class="px-3 py-2 font-bold text-gray-700 whitespace-nowrap">{{ s.nama }}</td>
                                            <td class="p-0 border-l bg-yellow-50"><input type="number" class="excel-input text-yellow-800" v-model="getKewalasan(s.id).s" @input="updateKewalasan(s.id, 's', $event.target.value)" placeholder="0"></td>
                                            <td class="p-0 bg-yellow-50"><input type="number" class="excel-input text-yellow-800" v-model="getKewalasan(s.id).i" @input="updateKewalasan(s.id, 'i', $event.target.value)" placeholder="0"></td>
                                            <td class="p-0 bg-yellow-50"><input type="number" class="excel-input text-yellow-800" v-model="getKewalasan(s.id).a" @input="updateKewalasan(s.id, 'a', $event.target.value)" placeholder="0"></td>
                                            <td class="p-0 border-l"><input type="number" class="excel-input" v-model="getKewalasan(s.id).c1" @input="updateKewalasan(s.id, 'c1', $event.target.value)"></td>
                                            <td class="p-0"><input type="number" class="excel-input" v-model="getKewalasan(s.id).c2" @input="updateKewalasan(s.id, 'c2', $event.target.value)"></td>
                                            <td class="p-0"><input type="number" class="excel-input" v-model="getKewalasan(s.id).c3" @input="updateKewalasan(s.id, 'c3', $event.target.value)"></td>
                                            <td class="p-0"><input type="number" class="excel-input" v-model="getKewalasan(s.id).c4" @input="updateKewalasan(s.id, 'c4', $event.target.value)"></td>
                                            <td class="p-2 border-l bg-gray-50 text-xs italic text-gray-600"><textarea readonly rows="2" class="w-full bg-transparent border-none outline-none resize-none" :value="generateWaliNotes(s.id, s.nama)"></textarea></td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </transition>

                <transition name="fade">
                    <div v-if="currentTab === 'kaih'">
                        <div class="bg-white p-6 rounded-xl shadow border mb-6">
                            <h3 class="font-bold text-cyan-800 text-lg mb-4 flex items-center gap-2">
                                <i class="fas fa-star"></i> Input 7 Kebiasaan Anak Indonesia Hebat (KAIH)
                            </h3>
                            <div class="flex items-end gap-4 border-t pt-4">
                                <div class="w-full md:w-1/3">
                                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Pilih Kelas</label>
                                    <select v-model="selectedClass" @change="fetchStudents" class="w-full p-2 border-2 border-cyan-200 rounded font-bold text-cyan-900"><option value="" disabled>-- Pilih Kelas --</option><option v-for="c in filteredClasses" :value="c">{{ c }}</option></select>
                                </div>
                                <div class="text-right flex-1 text-xs text-gray-400 italic">Isi nilai (0-100) per indikator. Deskripsi otomatis.</div>
                            </div>
                        </div>

                        <div class="bg-white rounded-xl shadow border overflow-hidden relative">
                            <div v-if="!selectedClass" class="p-10 text-center text-gray-400">Pilih kelas perwalian Anda.</div>
                            <div v-else class="overflow-x-auto">
                                <table class="w-full text-left border-collapse excel-table text-sm">
                                    <thead>
                                        <tr class="bg-cyan-800 text-white">
                                            <th class="p-3 w-10 text-center sticky-col bg-cyan-800" rowspan="2">No</th>
                                            <th class="p-3 w-64 sticky-col-2 bg-cyan-800" rowspan="2">Nama Siswa</th>
                                            
                                            <template v-for="aspect in kaihConfig" :key="aspect.id">
                                                <th :colspan="aspect.count" class="p-1 text-center font-bold text-[10px] border-l border-cyan-600 bg-cyan-900">
                                                    {{ aspect.name }}
                                                </th>
                                            </template>
                                            
                                            <th class="p-3 w-96 text-center bg-gray-800 sticky-right" rowspan="2">Deskripsi 7 KAIH (Otomatis)</th>
                                        </tr>
                                        <tr class="bg-cyan-700 text-cyan-50">
                                            <template v-for="aspect in kaihConfig" :key="aspect.id + '_sub'">
                                                <th v-for="n in aspect.count" :key="aspect.id + '_' + n" class="p-1 text-center w-8 text-[9px] border-l border-cyan-600">
                                                    Ind.{{ n }}
                                                </th>
                                            </template>
                                        </tr>
                                    </thead>
                                    <tbody class="bg-white">
                                        <tr v-for="(s, sIdx) in studentList" :key="s.id" class="hover:bg-cyan-50">
                                            <td class="text-center bg-gray-50 text-gray-500 select-none sticky-col left-0">{{ sIdx + 1 }}</td>
                                            <td class="px-3 py-2 font-bold text-gray-700 whitespace-nowrap sticky-col-2 bg-white left-10">{{ s.nama }}</td>
                                            
                                            <template v-for="aspect in kaihConfig" :key="aspect.id">
                                                <td v-for="n in aspect.count" :key="aspect.id + '_' + n" class="p-0 border-l border-gray-100">
                                                    <input 
                                                        type="number" 
                                                        class="excel-input" 
                                                        v-model="getKaih(s.id)[`${aspect.id}_${n}`]"
                                                        @input="updateKaih(s.id, `${aspect.id}_${n}`, $event.target.value)"
                                                        @paste="handleGridPaste($event, sIdx, `${aspect.id}_${n}`, false, true)"
                                                        placeholder="0"
                                                    >
                                                </td>
                                            </template>

                                            <td class="p-2 border-l bg-gray-50 text-xs italic text-gray-600 sticky-right">
                                                <textarea readonly rows="3" class="w-full bg-transparent border-none outline-none resize-none" :value="generateKaihNotes(s.id, s.nama)"></textarea>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </transition>

                <transition name="fade">
                    <div v-if="currentTab === 'monitoring'">
                        <div class="bg-white p-6 rounded-xl shadow border">
                            <h2 class="text-xl font-bold text-slate-800 mb-4">Monitoring Input Nilai</h2>
                            <div v-for="(classes, jenjang) in classesMap" :key="jenjang" class="mb-6">
                                <h3 class="font-bold text-blue-900 border-b pb-2 mb-3">JENJANG KELAS {{ jenjang }}</h3>
                                <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4">
                                    <div v-for="cls in classes" :key="cls" class="bg-gray-50 border p-3 rounded text-center"><div class="font-bold text-lg text-slate-700">{{ cls }}</div><div class="text-xs text-gray-500 mt-2 space-y-1"><div v-for="m in mapelList" :key="m" class="flex justify-between"><span>{{ m }}</span><i :class="hasData(cls, m) ? 'fas fa-check-circle text-green-500' : 'fas fa-circle text-gray-200'"></i></div><div class="border-t border-gray-200 my-2 pt-1 font-bold text-[10px] text-slate-400">WALI KELAS</div><div class="flex justify-between"><span>EKSKUL</span><i :class="hasData(cls, 'EKSKUL') ? 'fas fa-check-circle text-green-500' : 'fas fa-circle text-gray-200'"></i></div><div class="flex justify-between"><span>KEWALASAN</span><i :class="hasData(cls, 'KEWALASAN') ? 'fas fa-check-circle text-green-500' : 'fas fa-circle text-gray-200'"></i></div><div class="flex justify-between"><span>7 KAIH</span><i :class="hasData(cls, 'KAIH') ? 'fas fa-check-circle text-green-500' : 'fas fa-circle text-gray-200'"></i></div></div></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </transition>
                
                <transition name="fade">
                    <div v-if="currentTab === 'rekap'">
                        <div class="bg-white p-4 rounded-xl shadow border mb-6 flex flex-col md:flex-row justify-between items-center gap-4">
                            <div class="w-full md:w-1/3 flex gap-2">
                                <div class="w-1/2"><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Jenjang</label><select v-model="rekapJenjang" class="w-full p-2 border rounded font-bold text-emerald-900"><option value="7">Kelas 7</option><option value="8">Kelas 8</option><option value="9">Kelas 9</option></select></div>
                                <div class="w-1/2"><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Kelas</label><select v-model="selectedClass" @change="fetchStudentsForRekap" class="w-full p-2 border-2 border-emerald-200 rounded font-bold text-emerald-900"><option value="" disabled>-- Pilih --</option><option v-for="c in classesMap[rekapJenjang]" :value="c">{{ c }}</option></select></div>
                            </div>
                            <div class="text-right text-xs text-gray-500 italic">Data diambil dari Input Nilai masing-masing Guru.</div>
                        </div>
                        <div class="bg-white rounded-xl shadow border overflow-hidden relative"><div v-if="!selectedClass" class="p-10 text-center text-gray-400">Pilih kelas untuk melihat rekapitulasi.</div><div v-else class="overflow-x-auto"><table class="w-full text-left border-collapse excel-table text-xs"><thead class="bg-emerald-800 text-white"><tr><th class="p-3 w-10 text-center sticky-col bg-emerald-800" rowspan="2">No</th><th class="p-3 w-48 sticky-col-2 bg-emerald-800" rowspan="2">Nama Siswa</th><template v-for="m in mapelList" :key="m"><th :colspan="getMapelColSpan(m)" class="p-2 text-center border-l-4 border-emerald-400 bg-emerald-900">{{ m }}</th></template><th class="p-3 text-center bg-emerald-950 sticky-right w-16" rowspan="2">TOTAL SKOR</th><th class="p-3 text-center bg-emerald-950 sticky-right w-16" rowspan="2">RATA-RATA</th><th class="p-3 text-center bg-yellow-600 text-black sticky-right w-10 font-extrabold" rowspan="2">RANK</th></tr><tr class="bg-emerald-700 text-emerald-50"><template v-for="m in mapelList" :key="m + '_sub'"><template v-for="col in getMapelColumns(m)" :key="col.id"><th class="p-1 text-center w-8 border-l border-emerald-600" :title="col.title">{{ col.label }}</th></template><th class="p-1 text-center w-10 bg-emerald-600 font-bold border-l">R.TP</th><th class="p-1 text-center w-10 bg-emerald-600 font-bold">R.LM</th><th class="p-1 text-center w-10 bg-emerald-600 font-bold">R.ASAS</th><th class="p-1 text-center w-12 bg-yellow-400 text-black font-extrabold border-l-2">AKHIR</th></template></tr></thead><tbody class="bg-white"><tr v-for="(row, idx) in rekapData" :key="row.id" class="hover:bg-emerald-50"><td class="text-center font-bold sticky-col bg-white">{{ idx + 1 }}</td><td class="px-3 py-2 font-bold text-gray-700 whitespace-nowrap sticky-col-2 bg-white left-10">{{ row.nama }}</td><template v-for="m in mapelList" :key="m"><template v-for="col in getMapelColumns(m)" :key="col.id"><td class="text-center border-l text-gray-500">{{ row.grades[m]?.details?.[col.id] || '-' }}</td></template><td class="text-center font-bold text-emerald-700 bg-emerald-50 border-l">{{ row.grades[m]?.rTP || '-' }}</td><td class="text-center font-bold text-emerald-700 bg-emerald-50">{{ row.grades[m]?.rLM || '-' }}</td><td class="text-center font-bold text-emerald-700 bg-emerald-50">{{ row.grades[m]?.rASAS || '-' }}</td><td class="text-center font-extrabold text-blue-900 bg-blue-100 border-l-2 border-blue-200">{{ row.grades[m]?.final || '-' }}</td></template><td class="text-center font-extrabold text-white bg-emerald-900 sticky-right">{{ row.total }}</td><td class="text-center font-bold text-white bg-emerald-800 sticky-right">{{ row.average }}</td><td class="text-center font-extrabold text-black bg-yellow-400 sticky-right border-l-2 border-yellow-600">{{ row.rank }}</td></tr></tbody></table></div></div>
                    </div>
                </transition>

                <transition name="fade">
                    <div v-if="currentTab === 'rekap_akhir'">
                        <div class="bg-white p-4 rounded-xl shadow border mb-6 flex flex-col md:flex-row justify-between items-center gap-4">
                            <div class="w-full md:w-1/2 flex gap-2">
                                <div class="w-1/3"><label class="block text-xs font-bold text-purple-500 uppercase mb-1">Jenjang</label><select v-model="rekapJenjang" class="w-full p-2 border rounded font-bold text-purple-900"><option value="7">Kelas 7</option><option value="8">Kelas 8</option><option value="9">Kelas 9</option></select></div>
                                <div class="w-2/3">
                                    <label class="block text-xs font-bold text-purple-500 uppercase mb-1">Kelas / Filter</label>
                                    <select v-model="selectedClass" @change="fetchStudentsForRekap" class="w-full p-2 border-2 border-purple-200 rounded font-bold text-purple-900">
                                        <option value="" disabled>-- Pilih --</option>
                                        <option value="SEMUA">-- SEMUA KELAS {{ rekapJenjang }} --</option>
                                        <option v-for="c in classesMap[rekapJenjang]" :value="c">{{ c }}</option>
                                    </select>
                                </div>
                            </div>
                            <div class="text-right text-xs text-gray-500">Preview Rapor Lengkap</div>
                        </div>
                        <div class="bg-white rounded-xl shadow border overflow-hidden relative">
                            <div v-if="!selectedClass" class="p-10 text-center text-gray-400">Pilih kelas (atau semua kelas) untuk melihat Rapor Akhir.</div>
                            <div v-else class="overflow-x-auto">
                                <table class="w-full text-left border-collapse excel-table text-xs">
                                    <thead class="bg-purple-800 text-white">
                                        <tr>
                                            <th class="p-3 w-10 text-center sticky-col bg-purple-800" rowspan="2">No</th>
                                            <th class="p-3 w-48 sticky-col-2 bg-purple-800" rowspan="2">Nama Siswa</th>
                                            <th class="p-3 w-20 sticky-col-3 bg-purple-800" rowspan="2">Kelas</th>
                                            <template v-for="m in mapelList" :key="m"><th colspan="3" class="p-2 text-center border-l-4 border-purple-500 bg-purple-900">{{ m }}</th></template>
                                        </tr>
                                        <tr class="bg-purple-700 text-purple-100">
                                            <template v-for="m in mapelList" :key="m + '_desc'"><th class="p-2 text-center w-12 font-bold bg-purple-600 border-l">NILAI</th><th class="p-2 text-center min-w-[350px]">Deskripsi 1 (Kuat)</th><th class="p-2 text-center min-w-[350px]">Deskripsi 2 (Lemah)</th></template>
                                        </tr>
                                    </thead>
                                    <tbody class="bg-white">
                                        <tr v-for="(row, idx) in rekapAkhirTableData" :key="row.id" class="hover:bg-purple-50">
                                            <td class="text-center font-bold sticky-col bg-white">{{ idx + 1 }}</td>
                                            <td class="px-3 py-2 font-bold text-gray-700 whitespace-nowrap sticky-col-2 bg-white left-10">{{ row.nama }}</td>
                                            <td class="px-3 py-2 text-center text-gray-600 font-bold sticky-col-3 bg-white">{{ row.kelas }}</td>
                                            <template v-for="m in mapelList" :key="m">
                                                <td class="text-center font-extrabold text-lg text-purple-800 bg-purple-50 border-l">{{ row.data[m].nilai || '-' }}</td>
                                                <td class="p-2 border text-[11px] text-green-700 align-top whitespace-normal leading-relaxed">{{ row.data[m].desc1 }}</td>
                                                <td class="p-2 border text-[11px] text-orange-700 align-top whitespace-normal leading-relaxed">{{ row.data[m].desc2 }}</td>
                                            </template>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </transition>

            </div>
        </div>
    </div>

    <script type="module">
        import { createApp } from 'https://unpkg.com/vue@3/dist/vue.esm-browser.js';
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, getDocs, query, where } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBivREr2y61OYTE0kLxRnkGtPCdLvHn_og",
            authDomain: "cbt-albanna.firebaseapp.com",
            projectId: "cbt-albanna",
            storageBucket: "cbt-albanna.firebasestorage.app",
            messagingSenderId: "740622197344",
            appId: "1:740622197344:web:6112adf59edfbe496ed905"
        };
        const appFirebase = initializeApp(firebaseConfig);
        const db = getFirestore(appFirebase);

        createApp({
            data() {
                return {
                    currentTab: 'identitas', selectedClass: '', studentList: [], isLoadingStudents: false, lastSavedGrade: null,
                    identitas: { mapel: '', guru: '', jenjang: '' }, 
                    lingkupMateri: Array.from({ length: 5 }, (_, i) => ({ id: i + 1, judul: '', isOpen: i === 0, tujuan: Array.from({ length: 5 }, () => ({ a: 'Murid', b: '', c: '', d: '' })) })),
                    
                    allGrades: {}, savedProgress: {}, bankSoalCache: {},
                    ekskulData: {}, mapelConfigs: {}, 
                    kewalasanConfig: { a1: 'Religius', a2: 'Mandiri', a3: 'Gotong Royong', a4: 'Bernalar Kritis' },
                    kewalasanData: {},
                    kaihData: {}, 
                    
                    kaihConfig: [
                        { id: 'a1', name: 'Bangun Pagi', count: 4 },
                        { id: 'a2', name: 'Beribadah', count: 9 },
                        { id: 'a3', name: 'Makan Sehat', count: 3 },
                        { id: 'a4', name: 'Berolahraga', count: 1 },
                        { id: 'a5', name: 'Gemar Belajar', count: 4 },
                        { id: 'a6', name: 'Bermasyarakat', count: 8 },
                        { id: 'a7', name: 'Tidur Cepat', count: 3 }
                    ],
                    
                    rekapJenjang: '7',
                    mapelList: ['AGAMA ISLAM', 'BAHASA ARAB', 'BAHASA BALI', 'BAHASA INDONESIA', 'BAHASA INGGRIS', 'INFORMATIKA', 'IPA', 'IPS', 'KKA', 'MATEMATIKA', 'OLAHRAGA', 'PKN', 'SENI BUDAYA'],
                    classesMap: { '7': ['7A','7B','7C','7D','7E','7F'], '8': ['8A','8B','8C','8D','8E','8F'], '9': ['9A','9B','9C','9D','9E'] },

                    // --- BACKEND CONFIG ---
                    // URL Backend yang sudah diperbarui ke localhost
                    backendUrl: 'http://localhost:8000', 
                    isProcessingDownload: false,
                    downloadMode: 'batch'
                }
            },
            computed: {
                isIdentityValid() { return this.identitas.mapel && this.identitas.jenjang && this.identitas.guru.trim() !== ''; },
                isTpValid() { return this.lingkupMateri.some(lm => lm.judul && lm.tujuan.some(tp => tp.b)); },
                filteredClasses() { return this.identitas.jenjang ? this.classesMap[this.identitas.jenjang] : []; },
                
                activeLMs() { return this.lingkupMateri.filter(lm => lm.judul).map(lm => ({ ...lm, tujuan: lm.tujuan.filter(tp => tp.b), tpCount: lm.tujuan.filter(tp => tp.b).length })).filter(lm => lm.tpCount > 0); },
                activeTPs() { const tps=[]; this.activeLMs.forEach(lm=>{ lm.tujuan.forEach((tp,i)=>{ if(tp.b) tps.push({uniqueId:`tp_${lm.id}_${i+1}`}); }); }); return tps; },
                
                // REKAP DATA (RANKING & DETAIL)
                rekapData() {
                    if (!this.selectedClass || this.currentTab !== 'rekap') return [];
                    
                    const rawList = this.studentList.map(s => {
                        const grades = {}; let total = 0; let countMapel = 0;
                        const studentClass = s.kelas;
                        
                        this.mapelList.forEach(m => {
                            const raw = this.allGrades[studentClass]?.[m]?.[s.id];
                            if (raw) {
                                let sumTP=0, cTP=0, sumLM=0, cLM=0;
                                let asasTes = raw['asas_tes_auto'] ? parseFloat(raw['asas_tes_auto']) : 0;
                                let asasNon = raw['asas_nontes'] ? parseFloat(raw['asas_nontes']) : 0;
                                const details = {}; 

                                Object.keys(raw).forEach(k => {
                                    const val = parseFloat(raw[k]);
                                    details[k] = raw[k];
                                    if(!isNaN(val) && val > 0) {
                                        if (k.startsWith('tp_')) { sumTP+=val; cTP++; }
                                        else if (k.startsWith('lm_')) { sumLM+=val; cLM++; }
                                    }
                                });
                                const rTP = cTP > 0 ? Math.ceil(sumTP/cTP) : 0;
                                const rLM = cLM > 0 ? Math.ceil(sumLM/cLM) : 0;
                                let rASAS = 0, cA = 0;
                                if(asasTes > 0) { rASAS += asasTes; cA++; } if(asasNon > 0) { rASAS += asasNon; cA++; }
                                rASAS = cA > 0 ? Math.ceil(rASAS/cA) : 0;

                                let sumFinal = 0, countFinal = 0;
                                if(rTP > 0) { sumFinal += rTP; countFinal++; } if(rLM > 0) { sumFinal += rLM; countFinal++; } if(rASAS > 0) { sumFinal += rASAS; countFinal++; }
                                const final = countFinal > 0 ? Math.ceil(sumFinal / countFinal) : 0;

                                grades[m] = { rTP, rLM, rASAS, final, details };
                                if(final > 0) { total += final; countMapel++; }
                            } else { grades[m] = { rTP:'-', rLM:'-', rASAS:'-', final:'-', details: {} }; }
                        });
                        const average = countMapel > 0 ? Math.round(total / countMapel) : 0;
                        return { id: s.id, nama: s.nama, kelas: s.kelas, grades, total, average };
                    });
                    
                    const sortedByTotal = [...rawList].sort((a, b) => b.total - a.total);
                    const rankMap = {};
                    sortedByTotal.forEach((item, index) => { rankMap[item.id] = index + 1; });
                    
                    return rawList.map(item => ({ ...item, rank: rankMap[item.id] })).sort((a, b) => {
                        if (a.kelas === b.kelas) return a.nama.localeCompare(b.nama);
                        return a.kelas.localeCompare(b.kelas);
                    });
                },

                // REKAP AKHIR TABLE DATA
                rekapAkhirTableData() {
                     if (!this.selectedClass || this.currentTab !== 'rekap_akhir') return [];
                     
                     return this.studentList.map(s => {
                         const dataPerMapel = {};
                         const studentClass = s.kelas;
                         
                         this.mapelList.forEach(m => {
                             const raw = this.allGrades[studentClass]?.[m]?.[s.id];
                             const config = this.mapelConfigs[m];
                             if (raw && config) {
                                 let sumTP=0, cTP=0, sumLM=0, cLM=0;
                                 let asasTes = raw['asas_tes_auto'] ? parseFloat(raw['asas_tes_auto']) : 0;
                                 let asasNon = raw['asas_nontes'] ? parseFloat(raw['asas_nontes']) : 0;
                                 let maxScore = -1, minScore = 101;
                                 let maxTPText = "", minTPText = "";
                                 
                                 config.forEach(lm => {
                                     if(lm.judul) {
                                         lm.tujuan.forEach((tp, idx) => {
                                             if(tp.b) {
                                                 const key = `tp_${lm.id}_${idx+1}`;
                                                 const val = raw[key] ? parseFloat(raw[key]) : 0;
                                                 if(val > 0) { sumTP+=val; cTP++; if(val > maxScore){maxScore=val; maxTPText=this.generateContentString(tp);} if(val < minScore){minScore=val; minTPText=this.generateContentString(tp);} }
                                             }
                                         });
                                         const t = raw[`lm_${lm.id}_tes`]; if(t){sumLM+=parseFloat(t);cLM++}
                                         const nt = raw[`lm_${lm.id}_nontes`]; if(nt){sumLM+=parseFloat(nt);cLM++}
                                     }
                                 });
                                 const rTP = cTP > 0 ? Math.ceil(sumTP/cTP) : 0;
                                 const rLM = cLM > 0 ? Math.ceil(sumLM/cLM) : 0;
                                 let rASAS = 0, cA=0;
                                 if(asasTes>0){rASAS+=asasTes;cA++} if(asasNon>0){rASAS+=asasNon;cA++}
                                 rASAS = cA>0?Math.ceil(rASAS/cA):0;
                                 let sumF=0, cF=0;
                                 if(rTP>0){sumF+=rTP;cF++} if(rLM>0){sumF+=rLM;cF++} if(rASAS>0){sumF+=rASAS;cF++}
                                 const final = cF>0?Math.ceil(sumF/cF):0;
                                 const desc1 = maxScore > -1 ? `Ananda menunjukkan kemahiran dalam ${maxTPText}` : "-";
                                 const desc2 = (minScore < 101 && minScore < maxScore) ? `Ananda perlu bimbingan dalam ${minTPText}` : (minScore < 101 && minScore < 75 ? `Ananda perlu bimbingan dalam ${minTPText}` : "-");
                                 dataPerMapel[m] = { nilai: final, desc1, desc2 };
                             } else { dataPerMapel[m] = { nilai: 0, desc1: "-", desc2: "-" }; }
                         });
                         return { id: s.id, nama: s.nama, kelas: s.kelas, data: dataPerMapel };
                     }).sort((a,b) => {
                         if (a.kelas === b.kelas) return a.nama.localeCompare(b.nama);
                         return a.kelas.localeCompare(b.kelas);
                     });
                }
            },
            mounted() {
                const savedTp = localStorage.getItem('cbt_input_tp'); if (savedTp) { const data = JSON.parse(savedTp); this.identitas = data.identitas||this.identitas; this.lingkupMateri = data.lingkupMateri||this.lingkupMateri; }
                const savedGrades = localStorage.getItem('cbt_all_grades'); if (savedGrades) this.allGrades = JSON.parse(savedGrades);
                const savedProg = localStorage.getItem('cbt_saved_progress'); if (savedProg) this.savedProgress = JSON.parse(savedProg);
                const savedEkskul = localStorage.getItem('cbt_ekskul_data'); if (savedEkskul) this.ekskulData = JSON.parse(savedEkskul);
                const savedWalas = localStorage.getItem('cbt_kewalasan_data'); if (savedWalas) { const d = JSON.parse(savedWalas); this.kewalasanConfig = d.config || this.kewalasanConfig; this.kewalasanData = d.data || {}; }
                const savedKaih = localStorage.getItem('cbt_kaih_data'); if (savedKaih) this.kaihData = JSON.parse(savedKaih);
                const savedMapelConfigs = localStorage.getItem('cbt_mapel_configs'); if (savedMapelConfigs) this.mapelConfigs = JSON.parse(savedMapelConfigs);
                this.loadBankSoal();
            },
            methods: {
                generateContentString(tp) { let s = (tp.c ? tp.c.trim() + " " : "") + (tp.b ? tp.b.trim() + " " : "") + (tp.d ? tp.d.trim() : ""); return s.trim(); },
                getMapelColSpan(mapel) { return this.getMapelColumns(mapel).length + 4; },
                getMapelColumns(mapel) { const c=this.mapelConfigs[mapel]; if(!c)return[]; const cs=[]; c.forEach(lm=>{if(lm.judul) lm.tujuan.forEach((tp,i)=>{if(tp.b)cs.push({id:`tp_${lm.id}_${i+1}`,label:`TP${lm.id}.${i+1}`,title:`${tp.b}`})})}); return cs; },
                getPageTitle() { 
                    if (this.currentTab === 'rekap_akhir') return 'REKAP AKHIR RAPOR'; 
                    if (this.currentTab === 'identitas') return 'IDENTITAS PELAJARAN'; 
                    if (this.currentTab === 'tp') return 'PENYUSUNAN TP (ABCD)'; 
                    if (this.currentTab === 'nilai') return 'INPUT NILAI RAPOR'; 
                    if (this.currentTab === 'rekap') return 'REKAPITULASI NILAI'; 
                    if (this.currentTab === 'ekskul') return 'INPUT EKSTRAKURIKULER'; 
                    if (this.currentTab === 'kewalasan') return 'KEWALASAN (KARAKTER)';
                    if (this.currentTab === 'kaih') return '7 KAIH';
                    return 'MONITORING INPUT'; 
                },
                getPageSubtitle() { 
                    if (this.currentTab === 'kaih') return 'Input nilai 7 Kebiasaan Anak Indonesia Hebat.';
                    if (this.currentTab === 'kewalasan') return 'Input Absensi dan Perkembangan Karakter Siswa.';
                    if (this.currentTab === 'rekap_akhir') return 'Preview Nilai dan Deskripsi Rapor per Siswa.'; return this.currentTab === 'ekskul' ? 'Menu khusus Wali Kelas. Isi kegiatan siswa.' : 'Lengkapi data secara berurutan.'; 
                },

                switchToTP() { if (!this.isIdentityValid) return Swal.fire('Lengkapi Identitas', '', 'warning'); this.currentTab = 'tp'; },
                switchToNilai() { if (!this.isIdentityValid || !this.isTpValid) return Swal.fire('Data Belum Lengkap', 'Isi Identitas dan TP dulu.', 'warning'); this.currentTab = 'nilai'; this.selectedClass = ''; },
                switchToEkskul() { if (!this.identitas.jenjang) return Swal.fire('Pilih Jenjang', '', 'warning'); this.currentTab = 'ekskul'; this.selectedClass = ''; },
                switchToKewalasan() { if (!this.identitas.jenjang) return Swal.fire('Pilih Jenjang', '', 'warning'); this.currentTab = 'kewalasan'; this.selectedClass = ''; },
                switchToKaih() { if (!this.identitas.jenjang) return Swal.fire('Pilih Jenjang', '', 'warning'); this.currentTab = 'kaih'; this.selectedClass = ''; },
                switchToRekap() { this.currentTab = 'rekap'; this.selectedClass = ''; },
                switchToRekapAkhir() { this.currentTab = 'rekap_akhir'; this.selectedClass = ''; },

                getGrade(sid, key) { const c = this.selectedClass; const m = this.identitas.mapel; if (this.allGrades[c] && this.allGrades[c][m] && this.allGrades[c][m][sid]) return this.allGrades[c][m][sid][key] || ''; return ''; },
                updateGrade(sid, key, val) { const c = this.selectedClass; const m = this.identitas.mapel; if (!this.allGrades[c]) this.allGrades[c] = {}; if (!this.allGrades[c][m]) this.allGrades[c][m] = {}; if (!this.allGrades[c][m][sid]) this.allGrades[c][m][sid] = {}; this.allGrades[c][m][sid][key] = val; },
                getEkskulData(sid) { const c = this.selectedClass; if (!this.ekskulData[c]) this.ekskulData[c] = {}; if (!this.ekskulData[c][sid]) this.ekskulData[c][sid] = { nama_ekskul: '', deskripsi: '' }; return this.ekskulData[c][sid]; },
                updateEkskul(sid, f, v) { const c = this.selectedClass; if (!this.ekskulData[c]) this.ekskulData[c] = {}; if (!this.ekskulData[c][sid]) this.ekskulData[c][sid] = { nama_ekskul: '', deskripsi: '' }; this.ekskulData[c][sid][f] = v; },
                getKewalasan(sid) { const c = this.selectedClass; if (!this.kewalasanData[c]) this.kewalasanData[c] = {}; if (!this.kewalasanData[c][sid]) this.kewalasanData[c][sid] = { s: '', i: '', a: '', c1: '', c2: '', c3: '', c4: '' }; return this.kewalasanData[c][sid]; },
                updateKewalasan(sid, f, v) { const c = this.selectedClass; if (!this.kewalasanData[c]) this.kewalasanData[c] = {}; if (!this.kewalasanData[c][sid]) this.kewalasanData[c][sid] = {}; this.kewalasanData[c][sid][f] = v; },
                
                // KAIH LOGIC
                getKaih(sid) { 
                    const c = this.selectedClass; 
                    if (!this.kaihData[c]) this.kaihData[c] = {}; 
                    if (!this.kaihData[c][sid]) this.kaihData[c][sid] = {};
                    return this.kaihData[c][sid]; 
                },
                updateKaih(sid, key, val) { 
                    const c = this.selectedClass; 
                    if (!this.kaihData[c]) this.kaihData[c] = {}; 
                    if (!this.kaihData[c][sid]) this.kaihData[c][sid] = {}; 
                    this.kaihData[c][sid][key] = val; 
                },
                
                generateKaihNotes(sid, name) {
                    const d = this.getKaih(sid);
                    const aspectScores = [];
                    this.kaihConfig.forEach(aspect => {
                        let sum = 0, count = 0;
                        for(let i=1; i<=aspect.count; i++) {
                            const val = parseFloat(d[`${aspect.id}_${i}`] || 0);
                            if(val > 0) { sum+=val; count++; }
                        }
                        const avg = count > 0 ? sum/count : 0;
                        if(avg > 0) aspectScores.push({ name: aspect.name, val: avg });
                    });
                    if (aspectScores.length === 0) return "-";
                    const totalSum = aspectScores.reduce((a,b) => a+b.val, 0);
                    const totalAvg = totalSum / aspectScores.length;
                    const veryGood = aspectScores.filter(a => a.val > totalAvg).map(a => a.name);
                    const good = aspectScores.filter(a => a.val <= totalAvg).map(a => a.name);
                    let desc = `Ananda ${name}`;
                    if (veryGood.length > 0) {
                        desc += ` sangat baik dalam ${veryGood.join(', ')}`;
                        if (good.length > 0) desc += `, dan baik dalam ${good.join(', ')}.`;
                        else desc += ".";
                    } else if (good.length > 0) {
                        desc += ` baik dalam ${good.join(', ')}.`;
                    }
                    return desc;
                },

                generateWaliNotes(sid, name) {
                    const d = this.getKewalasan(sid);
                    const scores = [
                        { key: 'a1', val: parseInt(d.c1 || 0), name: this.kewalasanConfig.a1 || 'Aspek 1' },
                        { key: 'a2', val: parseInt(d.c2 || 0), name: this.kewalasanConfig.a2 || 'Aspek 2' },
                        { key: 'a3', val: parseInt(d.c3 || 0), name: this.kewalasanConfig.a3 || 'Aspek 3' },
                        { key: 'a4', val: parseInt(d.c4 || 0), name: this.kewalasanConfig.a4 || 'Aspek 4' }
                    ];
                    const best = scores.reduce((prev, current) => (prev.val > current.val) ? prev : current);
                    if (best.val === 0) return "-";
                    const predikat = best.val > 90 ? "Sangat Baik" : "Baik";
                    return `Ananda ${name} ${predikat} dalam ${best.name}.`;
                },

                async loadBankSoal() { const q = query(collection(db, "bank_soal")); const snap = await getDocs(q); snap.forEach(doc => { this.bankSoalCache[doc.id] = doc.data(); }); },
                getRealScoreFromDoc(docData) { const exam = this.bankSoalCache[docData.examId]; if (!exam) return 0; let score = 0; exam.soal.forEach((q, idx) => { if (['PG', 'BS'].includes(q.type) && docData.answers[idx] === q.answer) score += parseInt(q.poin); if (['URAIAN', 'ESAI', 'ISIAN'].includes(q.type) && docData.manualScores && docData.manualScores[idx] !== undefined) { score += parseInt(docData.manualScores[idx]); } }); return score; },
                
                async fetchStudentsAndScores() {
                    if(!this.selectedClass) return; 
                    this.isLoadingStudents = true; 
                    this.studentList = [];
                    
                    try {
                        let classesToFetch = [];
                        if (this.selectedClass === 'SEMUA') {
                            classesToFetch = this.classesMap[this.rekapJenjang];
                        } else {
                            classesToFetch = [this.selectedClass];
                        }

                        const qAbsen = query(collection(db, "data_absensi"), where("kelas", "in", classesToFetch));
                        const snapAbsen = await getDocs(qAbsen);
                        
                        const uniqueMap = new Map();
                        snapAbsen.docs.forEach(doc => { 
                            const d = doc.data(); 
                            if(!uniqueMap.has(d.nama)) {
                                uniqueMap.set(d.nama, { 
                                    id: doc.id, 
                                    nama: d.nama, 
                                    kelas: d.kelas,
                                    nis: d.nis || d.nisn || "-", // Handle NIS fallback
                                    asasTesScore: 0 
                                }); 
                            }
                        });

                        if (this.currentTab === 'nilai') {
                            const qJawaban = query(collection(db, "jawaban_siswa"), where("mapel", "==", this.identitas.mapel), where("student.kelas", "in", classesToFetch));
                            const snapJawaban = await getDocs(qJawaban);
                            snapJawaban.docs.forEach(doc => { 
                                const data = doc.data(); 
                                const sName = data.student.nama; 
                                if (uniqueMap.has(sName)) { 
                                    const score = this.getRealScoreFromDoc(data); 
                                    const finalScore = data.isRemedialDone ? 75 : score; 
                                    uniqueMap.get(sName).asasTesScore = finalScore; 
                                } 
                            });
                        }

                        this.studentList = Array.from(uniqueMap.values()).sort((a,b) => {
                            if (a.kelas === b.kelas) return a.nama.localeCompare(b.nama);
                            return a.kelas.localeCompare(b.kelas);
                        });

                        this.studentList.forEach(s => {
                            if (!this.allGrades[s.kelas]) this.allGrades[s.kelas] = {};
                            if (!this.allGrades[s.kelas][this.identitas.mapel]) this.allGrades[s.kelas][this.identitas.mapel] = {};
                            if (!this.allGrades[s.kelas][this.identitas.mapel][s.id]) this.allGrades[s.kelas][this.identitas.mapel][s.id] = {};
                            
                            if (!this.ekskulData[s.kelas]) this.ekskulData[s.kelas] = {};
                            if (!this.ekskulData[s.kelas][s.id]) this.ekskulData[s.kelas][s.id] = { nama_ekskul: '', deskripsi: '' };
                            
                            if (!this.kewalasanData[s.kelas]) this.kewalasanData[s.kelas] = {};
                            if (!this.kewalasanData[s.kelas][s.id]) this.kewalasanData[s.kelas][s.id] = { s:'', i:'', a:'', c1:'', c2:'', c3:'', c4:'' };
                            
                            if (!this.kaihData[s.kelas]) this.kaihData[s.kelas] = {};
                            if (!this.kaihData[s.kelas][s.id]) this.kaihData[s.kelas][s.id] = {};
                        });

                    } catch(e) { 
                        console.error(e); 
                        Swal.fire('Error', 'Gagal memuat data siswa: ' + e.message, 'error');
                    } finally { 
                        this.isLoadingStudents = false; 
                    }
                },
                
                async fetchStudentsForRekap() { await this.fetchStudentsAndScores(); },
                async fetchStudents() { await this.fetchStudentsAndScores(); },

                // --- CALCS ---
                calculateRataTP(sid) { let sum=0, c=0; this.activeTPs.forEach(tp => { const v=this.getGrade(sid, tp.uniqueId); if(v!=='' && parseFloat(v)>0){sum+=parseFloat(v); c++;} }); return c>0 ? Math.ceil(sum/c) : 0; },
                calculateRataLM(sid) { let sum=0, c=0; this.activeLMs.forEach(lm => { const t=this.getGrade(sid, `lm_${lm.id}_tes`); const nt=this.getGrade(sid, `lm_${lm.id}_nontes`); if(t!=='' && parseFloat(t)>0){sum+=parseFloat(t); c++;} if(nt!=='' && parseFloat(nt)>0){sum+=parseFloat(nt); c++;} }); return c>0 ? Math.ceil(sum/c) : 0; },
                calculateRataASAS(sid, asasTesScore) { let sum=0, c=0; if(asasTesScore > 0) { sum += parseFloat(asasTesScore); c++; } const nonTesRaw = this.getGrade(sid, 'asas_nontes'); if (nonTesRaw !== '' && parseFloat(nonTesRaw) > 0) { sum += parseFloat(nonTesRaw); c++; } return c > 0 ? Math.ceil(sum / c) : 0; },
                calculateNilaiRapor(sid, asasTesScore) { const rTP = this.calculateRataTP(sid); const rLM = this.calculateRataLM(sid); const rASAS = this.calculateRataASAS(sid, asasTesScore); let sum = 0; let count = 0; if (rTP > 0) { sum += rTP; count++; } if (rLM > 0) { sum += rLM; count++; } if (rASAS > 0) { sum += rASAS; count++; } return count > 0 ? Math.ceil(sum / count) : 0; },

                isValidScore(val) { if(val==='') return true; const n=Number(val); return !isNaN(n) && n>=0 && n<=100; },
                getValidationClass(val) { return this.isValidScore(val) ? '' : 'input-error'; },
                generateSentence(tp) { let s = (tp.c ? tp.c.trim() + ", " : "") + tp.a + (tp.b ? " dapat " + tp.b.trim() : "") + (tp.d ? " " + tp.d.trim() : ""); return s.replace(/\s+/g, ' ').trim() + "."; },
                toggleSection(i) { this.lingkupMateri[i].isOpen = !this.lingkupMateri[i].isOpen; },
                handleSaveButton() {
                    if (this.currentTab === 'ekskul') { localStorage.setItem('cbt_ekskul_data', JSON.stringify(this.ekskulData)); Swal.fire({ icon: 'success', title: 'Data Ekskul Tersimpan!', timer: 1000, showConfirmButton: false }); }
                    else if (this.currentTab === 'kewalasan') { const dataWalas = { config: this.kewalasanConfig, data: this.kewalasanData }; localStorage.setItem('cbt_kewalasan_data', JSON.stringify(dataWalas)); Swal.fire({ icon: 'success', title: 'Data Kewalasan Tersimpan!', timer: 1000, showConfirmButton: false }); }
                    else if (this.currentTab === 'kaih') { localStorage.setItem('cbt_kaih_data', JSON.stringify(this.kaihData)); Swal.fire({ icon: 'success', title: 'Data 7 KAIH Tersimpan!', timer: 1000, showConfirmButton: false }); }
                    else if(this.currentTab === 'nilai') {
                        if(this.studentList.length > 0) { this.studentList.forEach(s => { this.updateGrade(s.id, 'asas_tes_auto', s.asasTesScore); }); }
                        this.mapelConfigs[this.identitas.mapel] = JSON.parse(JSON.stringify(this.lingkupMateri)); 
                        localStorage.setItem('cbt_mapel_configs', JSON.stringify(this.mapelConfigs));
                        localStorage.setItem('cbt_all_grades', JSON.stringify(this.allGrades));
                        if (this.selectedClass && this.identitas.mapel) { this.savedProgress[`${this.selectedClass}_${this.identitas.mapel}`] = true; localStorage.setItem('cbt_saved_progress', JSON.stringify(this.savedProgress)); }
                        Swal.fire({ title: 'Alhamdulillah! ü§≤', text: 'Selamat kamu sudah terbebas/sedikit terbebas dari tagihan wakakur :)', icon: 'success' });
                    } else { const dataTP = { identitas: this.identitas, lingkupMateri: this.lingkupMateri }; localStorage.setItem('cbt_input_tp', JSON.stringify(dataTP)); Swal.fire({ icon: 'success', title: 'Tersimpan!', timer: 1000, showConfirmButton: false }); }
                },
                hasData(cls, mapel) { return this.savedProgress[`${cls}_${mapel}`] === true; },
                handleGridPaste(e, startRowIdx, targetKey, isEkskul=false, isKaih=false) {
                    e.preventDefault(); const text = (e.clipboardData || window.clipboardData).getData('text'); const rows = text.split(/\r\n|\n|\r/).filter(r => r.trim() !== '');
                    rows.forEach((val, offset) => { const targetRow = startRowIdx + offset; if (targetRow < this.studentList.length) { const sid = this.studentList[targetRow].id; 
                        if(isEkskul) this.updateEkskul(sid, targetKey, val.trim()); 
                        else if(isKaih) this.updateKaih(sid, targetKey, val.trim());
                        else this.updateGrade(sid, targetKey, val.trim()); 
                    } });
                },
                
                exportRekapExcel() {
                    if(this.rekapData.length === 0) return Swal.fire('Data Kosong', 'Pilih kelas terlebih dahulu.', 'warning');
                    const rows = this.rekapData.map((d, i) => {
                        const row = { 'Rank': d.rank, 'Kelas': d.kelas, 'Nama Siswa': d.nama };
                        this.mapelList.forEach(m => {
                            const cols = this.getMapelColumns(m);
                            cols.forEach(col => { row[`${m} - ${col.label}`] = d.grades[m]?.details?.[col.id] || 0; });
                            row[`${m} - Rata TP`] = d.grades[m]?.rTP || 0;
                            row[`${m} - Rata LM`] = d.grades[m]?.rLM || 0;
                            row[`${m} - Rata ASAS`] = d.grades[m]?.rASAS || 0;
                            row[`${m} - NILAI AKHIR`] = d.grades[m]?.final || 0;
                        });
                        row['TOTAL SKOR'] = d.total; row['RATA-RATA'] = d.average; return row;
                    });
                    const ws = XLSX.utils.json_to_sheet(rows);
                    const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Rekap Detail"); XLSX.writeFile(wb, `Rekap_Detail_Nilai_${this.selectedClass}.xlsx`);
                },

                exportRekapAkhirExcel() {
                    if(this.rekapAkhirTableData.length === 0) return Swal.fire('Data Kosong', 'Pilih kelas terlebih dahulu.', 'warning');
                    const rows = this.rekapAkhirTableData.map((d, i) => {
                         const row = { 'No': i + 1, 'Kelas': d.kelas, 'Nama Siswa': d.nama };
                         this.mapelList.forEach(m => {
                             row[`${m} - Nilai`] = d.data[m].nilai;
                             row[`${m} - Deskripsi Kuat`] = d.data[m].desc1;
                             row[`${m} - Deskripsi Lemah`] = d.data[m].desc2;
                         });
                         return row;
                    });
                    const ws = XLSX.utils.json_to_sheet(rows);
                    const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Rapor Akhir"); XLSX.writeFile(wb, `Leger_Rapor_${this.rekapJenjang}_${this.selectedClass}.xlsx`);
                },

                // --- INTEGRASI BACKEND (DIPERBARUI) ---
                async generateRaporBackend(format) {
                    // 1. Validasi: Pastikan data tabel rekap akhir tidak kosong
                    if (this.rekapAkhirTableData.length === 0) {
                        return Swal.fire('Data Kosong', 'Silakan pilih kelas terlebih dahulu di menu Rekap Akhir.', 'warning');
                    }
                    
                    this.isProcessingDownload = true;
                    
                    try {
                        // 2. Mapping Data dari Frontend ke Format yang Diminta Backend (app.py)
                        const siswaPayload = this.studentList.map((s, index) => {
                            // Cari data nilai siswa yang sesuai di tabel rekap akhir
                            const studentRow = this.rekapAkhirTableData.find(r => r.id === s.id);
                            
                            // Jika data tidak ditemukan di tabel rekap, lewati
                            if (!studentRow) return null;

                            // Loop setiap mapel untuk mengambil nilai dan deskripsi
                            const listMapel = this.mapelList.map(m => {
                                const dataNilai = studentRow.data[m];
                                
                                // Gabungkan Deskripsi Kuat (desc1) dan Lemah (desc2) menjadi satu string rapi
                                let fullDesc = "";
                                
                                // Masukkan deskripsi kompetensi tertinggi (jika ada)
                                if (dataNilai.desc1 && dataNilai.desc1 !== '-') {
                                    fullDesc += dataNilai.desc1;
                                }
                                
                                // Masukkan deskripsi kompetensi terendah (jika ada)
                                if (dataNilai.desc2 && dataNilai.desc2 !== '-') {
                                    // Tambahkan baris baru (Enter) jika sebelumnya sudah ada isinya
                                    if (fullDesc) fullDesc += "\n\n"; 
                                    fullDesc += dataNilai.desc2;
                                }
                                
                                return {
                                    mapel_key: m,                     // Contoh: "AGAMA ISLAM" (nanti di-normalize backend)
                                    na: parseFloat(dataNilai.nilai) || 0,
                                    deskripsi: fullDesc || "-"        // Kirim "-" jika kosong agar tidak error
                                };
                            });

                            // Ambil NIS/NISN. Prioritas: NIS -> NISN -> "-"
                            const nisValue = s.nis || s.nisn || "-";

                            return {
                                no_urut: index + 1,
                                nama_peserta: s.nama,
                                nis_nisn: nisValue,
                                nama_sekolah: "SMP ALBANNA",
                                alamat_sekolah: "Jl. Tukad Yeh Ho III No. 16",
                                kelas: s.kelas,            // Kelas asli siswa (misal 7A)
                                fase: "D",                 // Fase SMP
                                semester: "1 (Ganjil)",
                                tahun_ajaran: "2024/2025",
                                mapel: listMapel
                            };
                        }).filter(Boolean); // Hapus data null jika ada error mapping

                        // 3. Siapkan Payload (Bungkusan Data)
                        const payload = { siswa: siswaPayload };
                        
                        // Cek mode download (batch/zip atau combine/gabung)
                        const combineParam = this.downloadMode === 'combine' ? 1 : 0;
                        
                        // Susun URL Endpoint
                        const endpoint = `${this.backendUrl}/api/rapor/${format}?combine=${combineParam}`;

                        console.log("Mengirim data ke backend:", endpoint); 

                        // 4. Kirim Request ke Backend menggunakan Fetch API
                        const response = await fetch(endpoint, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        // Cek jika backend merespon dengan error
                        if (!response.ok) {
                            const errorText = await response.text();
                            throw new Error(errorText || "Terjadi kesalahan di server backend.");
                        }

                        // 5. Proses File yang Diterima (Blob)
                        const blob = await response.blob();
                        
                        // Tentukan nama file output
                        let filename = `Rapor_${this.selectedClass}`;
                        
                        if (this.downloadMode === 'combine') {
                            filename += `_Gabungan.${format === 'xlsx' ? 'xlsx' : 'pdf'}`;
                        } else {
                            // Cek header untuk memastikan ekstensi (fallback logic)
                            const headerContentDisp = response.headers.get('Content-Disposition');
                            if (headerContentDisp && headerContentDisp.includes('.xlsx')) {
                                filename += `.xlsx`;
                            } else if (headerContentDisp && headerContentDisp.includes('.pdf')) {
                                filename += `.pdf`;
                            } else {
                                filename += `_Batch.zip`;
                            }
                        }

                        // Buat link download virtual dan klik otomatis
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = filename;
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        
                        // Tampilkan notifikasi sukses
                        Swal.fire({ 
                            icon: 'success', 
                            title: 'Berhasil', 
                            text: `File ${format.toUpperCase()} berhasil diunduh!` 
                        });

                    } catch (error) {
                        console.error("Error Download:", error);
                        Swal.fire({
                            icon: 'error',
                            title: 'Gagal',
                            text: 'Gagal memproses data: ' + error.message,
                            footer: 'Pastikan backend (uvicorn) sudah berjalan di localhost:8000'
                        });
                    } finally {
                        this.isProcessingDownload = false;
                    }
                }
            }
        }).mount('#app');
    </script>
</body>
</html>
