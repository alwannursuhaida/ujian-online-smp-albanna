<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal Remidi - SMP ALBANNA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Montserrat', sans-serif; }
        .animate-fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body class="bg-gray-50 min-h-screen flex flex-col">

    <div id="app" class="flex-1 flex flex-col">

        <!-- NAVBAR (TANPA TOMBOL MENU) -->
        <nav class="bg-blue-900 text-white p-4 shadow-lg sticky top-0 z-50">
            <div class="max-w-4xl mx-auto flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <div class="bg-white text-blue-900 p-2 rounded-lg">
                        <i class="fas fa-clipboard-check fa-lg"></i>
                    </div>
                    <div>
                        <h1 class="font-bold text-lg leading-none">PORTAL REMIDI</h1>
                        <p class="text-xs text-blue-200">SMP ALBANNA</p>
                    </div>
                </div>
                <!-- Hanya tombol Keluar yang tersisa -->
                <div class="flex gap-2">
                    <button v-if="isLoggedIn" @click="logout" class="text-xs bg-red-600 hover:bg-red-700 px-3 py-2 rounded font-bold transition shadow">
                        KELUAR <i class="fas fa-sign-out-alt ml-1"></i>
                    </button>
                </div>
            </div>
        </nav>

        <!-- 1. HALAMAN LOGIN (INPUT KELAS -> NAMA DARI DB) -->
        <div v-if="!isLoggedIn" class="flex-1 flex flex-col items-center justify-center p-4 animate-fade-in">
            <div class="bg-white p-8 rounded-2xl shadow-xl w-full max-w-md border-t-8 border-blue-600">
                <div class="text-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">CEK KELULUSAN</h2>
                    <p class="text-sm text-gray-500">Pilih kelas dan nama Anda.</p>
                </div>

                <div class="space-y-4">
                    <!-- 1. Pilih Kelas (Paling Atas) -->
                    <div>
                        <label class="block text-xs font-bold text-gray-600 uppercase mb-1">Kelas</label>
                        <select v-model="form.kelas" @change="fetchStudents" class="w-full p-3 border rounded-lg bg-gray-50 focus:ring-2 focus:ring-blue-600 outline-none">
                            <option value="" disabled>-- Pilih Kelas --</option>
                            <optgroup label="Kelas 7"><option v-for="c in 'ABCDEF'" :value="'7'+c">7{{c}}</option></optgroup>
                            <optgroup label="Kelas 8"><option v-for="c in 'ABCDEF'" :value="'8'+c">8{{c}}</option></optgroup>
                            <optgroup label="Kelas 9"><option v-for="c in 'ABCDE'" :value="'9'+c">9{{c}}</option></optgroup>
                        </select>
                    </div>

                    <!-- 2. Pilih Nama (Dropdown Dinamis) -->
                    <div>
                        <label class="block text-xs font-bold text-gray-600 uppercase mb-1">Nama Lengkap</label>
                        <select v-model="form.nama" :disabled="!form.kelas || studentList.length === 0" class="w-full p-3 border rounded-lg bg-gray-50 focus:ring-2 focus:ring-blue-600 outline-none disabled:bg-gray-200 disabled:text-gray-400">
                            <option value="" disabled>-- Pilih Nama Siswa --</option>
                            <option v-for="s in studentList" :key="s.id" :value="s.nama">{{ s.nama }}</option>
                        </select>
                        
                        <!-- Indikator Loading/Kosong -->
                        <p v-if="isLoadingList" class="text-xs text-blue-500 mt-1 animate-pulse">
                            <i class="fas fa-spinner fa-spin"></i> Mengambil data siswa...
                        </p>
                        <p v-if="!isLoadingList && form.kelas && studentList.length === 0" class="text-xs text-red-400 mt-1 italic">
                            * Belum ada data siswa di kelas ini.
                        </p>
                    </div>

                    <button @click="checkStatus" :disabled="!form.nama" class="w-full bg-blue-600 text-white py-3 rounded-lg font-bold hover:bg-blue-700 shadow-lg transition flex justify-center items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed">
                        <span v-if="isLoading"><i class="fas fa-circle-notch fa-spin"></i> Memuat...</span>
                        <span v-else>LIHAT HASIL <i class="fas fa-search"></i></span>
                    </button>
                </div>
            </div>
        </div>

        <!-- 2. DASHBOARD SISWA -->
        <div v-else class="flex-1 max-w-4xl mx-auto w-full p-4 animate-fade-in">
            
            <!-- Header Siswa -->
            <div class="bg-white p-6 rounded-xl shadow-sm border mb-6 flex justify-between items-center">
                <div>
                    <h2 class="text-2xl font-bold text-gray-800">{{ form.nama }}</h2>
                    <span class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-xs font-bold">Kelas {{ form.kelas }}</span>
                </div>
                <div class="text-right hidden md:block">
                    <p class="text-xs text-gray-400 uppercase font-bold">KKM / Batas Lulus</p>
                    <p class="text-3xl font-bold text-blue-600">75</p>
                </div>
            </div>

            <!-- TAB MENU -->
            <div class="flex gap-2 mb-6 border-b-2 border-gray-200">
                <button @click="activeTab = 'rapor'" :class="['px-6 py-3 font-bold text-sm transition border-b-4 -mb-1', activeTab === 'rapor' ? 'border-blue-600 text-blue-800' : 'border-transparent text-gray-400 hover:text-gray-600']">
                    <i class="fas fa-file-alt mr-2"></i> STATUS NILAI
                </button>
                <button @click="activeTab = 'jadwal'" :class="['px-6 py-3 font-bold text-sm transition border-b-4 -mb-1', activeTab === 'jadwal' ? 'border-blue-600 text-blue-800' : 'border-transparent text-gray-400 hover:text-gray-600']">
                    <i class="fas fa-calendar-alt mr-2"></i> JADWAL REMIDI
                </button>
            </div>

            <!-- TAB 1: STATUS NILAI -->
            <div v-if="activeTab === 'rapor'" class="bg-white rounded-xl shadow-sm overflow-hidden border">
                <table class="w-full text-left">
                    <thead class="bg-gray-50 border-b text-gray-500 text-xs uppercase">
                        <tr>
                            <th class="p-4">Mata Pelajaran</th>
                            <th class="p-4 text-center">Nilai Akhir</th>
                            <th class="p-4 text-center">Status</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-100">
                        <tr v-for="mapel in masterMapel" :key="mapel" class="hover:bg-gray-50">
                            <td class="p-4 font-bold text-gray-700">{{ mapel }}</td>
                            
                            <!-- NILAI -->
                            <td class="p-4 text-center font-mono font-bold text-gray-600">
                                {{ getStudentScore(mapel) !== null ? getStudentScore(mapel) : '-' }}
                            </td>

                            <!-- STATUS -->
                            <td class="p-4 text-center">
                                <div v-if="getStudentScore(mapel) === null" class="text-xs text-gray-400 italic">
                                    Belum Ada Data
                                </div>
                                <div v-else>
                                    <span v-if="getStudentScore(mapel) >= 75" class="bg-green-100 text-green-700 px-3 py-1 rounded-full text-xs font-bold shadow-sm">
                                        <i class="fas fa-check-circle"></i> LOLOS
                                    </span>
                                    <span v-else class="bg-red-100 text-red-700 px-3 py-1 rounded-full text-xs font-bold shadow-sm animate-pulse">
                                        <i class="fas fa-exclamation-circle"></i> REMIDI
                                    </span>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- TAB 2: JADWAL REMIDI -->
            <div v-if="activeTab === 'jadwal'">
                
                <!-- Tombol Edit (Admin) -->
                <div class="mb-4 flex justify-between items-center">
                    <h3 class="font-bold text-gray-700">Jadwal Pelaksanaan Remidi</h3>
                    <button @click="enableAdminMode" :class="['text-xs px-3 py-1 rounded font-bold border transition', isAdminMode ? 'bg-red-100 text-red-600 border-red-200' : 'bg-white text-gray-400 border-gray-200 hover:border-blue-400 hover:text-blue-500']">
                        <i class="fas fa-edit"></i> {{ isAdminMode ? 'Matikan Mode Admin' : 'Edit Jadwal (Admin)' }}
                    </button>
                </div>

                <!-- Form Tambah Jadwal (Admin Only) -->
                <div v-if="isAdminMode" class="bg-blue-50 p-4 rounded-lg mb-6 border border-blue-200">
                    <h4 class="text-xs font-bold text-blue-800 uppercase mb-2">Tambah Jadwal Baru</h4>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-2">
                        <select v-model="newSchedule.mapel" class="p-2 rounded border text-sm"><option value="" disabled>Pilih Mapel</option><option v-for="m in masterMapel" :value="m">{{m}}</option></select>
                        <input v-model="newSchedule.hari" placeholder="Hari, Tanggal" class="p-2 rounded border text-sm">
                        <input v-model="newSchedule.waktu" placeholder="Waktu (ex: 08.00 - 09.00)" class="p-2 rounded border text-sm">
                        <button @click="addSchedule" class="bg-blue-600 text-white rounded font-bold text-sm hover:bg-blue-700">TAMBAH</button>
                    </div>
                </div>

                <div class="grid gap-4">
                    <div v-if="scheduleList.length === 0" class="text-center text-gray-400 py-10 bg-white rounded-xl border border-dashed">
                        <p>Belum ada jadwal remidi yang dirilis.</p>
                    </div>
                    
                    <div v-for="item in scheduleList" :key="item.id" class="bg-white p-4 rounded-xl shadow-sm border flex justify-between items-center hover:shadow-md transition">
                        <div class="flex gap-4 items-center">
                            <div class="bg-blue-100 text-blue-800 w-12 h-12 rounded-lg flex items-center justify-center shrink-0">
                                <i class="fas fa-calendar-day text-xl"></i>
                            </div>
                            <div>
                                <h4 class="font-bold text-gray-800">{{ item.mapel }}</h4>
                                <p class="text-sm text-gray-500"><i class="far fa-clock mr-1"></i> {{ item.hari }} | {{ item.waktu }}</p>
                            </div>
                        </div>
                        <button v-if="isAdminMode" @click="deleteSchedule(item.id)" class="text-red-400 hover:text-red-600 px-2"><i class="fas fa-trash"></i></button>
                    </div>
                </div>
            </div>

        </div>

        <!-- FOOTER -->
        <footer class="text-center p-6 text-xs text-gray-400">
            &copy; 2025 SMP ALBANNA - Sistem Informasi Akademik
        </footer>

    </div>

    <script type="module">
        import { createApp } from 'https://unpkg.com/vue@3/dist/vue.esm-browser.js';
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, query, where, getDocs, addDoc, deleteDoc, doc, onSnapshot, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBivREr2y61OYTE0kLxRnkGtPCdLvHn_og",
            authDomain: "cbt-albanna.firebaseapp.com",
            projectId: "cbt-albanna",
            storageBucket: "cbt-albanna.firebasestorage.app",
            messagingSenderId: "740622197344",
            appId: "1:740622197344:web:6112adf59edfbe496ed905"
        };

        const appFirebase = initializeApp(firebaseConfig);
        const db = getFirestore(appFirebase);

        createApp({
            data() {
                return {
                    isLoading: false,
                    isLoadingList: false,
                    isLoggedIn: false,
                    activeTab: 'rapor',
                    isAdminMode: false,
                    form: { nama: '', kelas: '' },
                    studentList: [], // List Nama dari Database
                    
                    // DATA
                    studentResults: [], 
                    bankSoalCache: {},  
                    scheduleList: [],   
                    newSchedule: { mapel: '', hari: '', waktu: '' },
                    
                    masterMapel: ['MATEMATIKA', 'IPA', 'BAHASA INGGRIS', 'BAHASA INDONESIA', 'BAHASA BALI', 'SENI BUDAYA', 'BAHASA ARAB', 'OLAHRAGA', 'IPS', 'PAI', 'INFORMATIKA', 'PKN', 'KKA']
                }
            },
            mounted() {
                // Load Jadwal Realtime
                const qSch = query(collection(db, "jadwal_remidi"), orderBy("mapel"));
                onSnapshot(qSch, (snap) => {
                    this.scheduleList = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                });
                
                // Pre-load Bank Soal (untuk kunci jawaban)
                this.loadBankSoal();
            },
            methods: {
                async loadBankSoal() {
                    const q = query(collection(db, "bank_soal"));
                    const snap = await getDocs(q);
                    snap.forEach(doc => { this.bankSoalCache[doc.id] = doc.data(); });
                },

                // --- TARIK DATA SISWA (SEMUA STATUS) ---
                async fetchStudents() {
                    if(!this.form.kelas) return;
                    this.isLoadingList = true;
                    this.studentList = [];
                    this.form.nama = ''; 

                    try {
                        // Ambil semua siswa di kelas ini (Tanpa filter status 'H')
                        // Agar siswa yang absen/sakit pun bisa login cek jadwal remidi
                        const q = query(collection(db, "data_absensi"), where("kelas", "==", this.form.kelas));
                        const snapshot = await getDocs(q);
                        
                        // Sort manual client-side untuk menghindari error index
                        this.studentList = snapshot.docs
                            .map(doc => doc.data())
                            .sort((a,b) => a.nama.localeCompare(b.nama));
                            
                    } catch(e) {
                        console.error("Error fetching students:", e);
                    } finally {
                        this.isLoadingList = false;
                    }
                },

                async checkStatus() {
                    if(!this.form.nama || !this.form.kelas) return alert("Lengkapi identitas!");
                    this.isLoading = true;

                    try {
                        // Query jawaban siswa berdasarkan kelas
                        const q = query(collection(db, "jawaban_siswa"), where("student.kelas", "==", this.form.kelas));
                        const snap = await getDocs(q);
                        
                        // Filter Nama di Client-side (Case Insensitive & Trim)
                        this.studentResults = snap.docs
                            .map(doc => doc.data())
                            .filter(d => d.student.nama.trim().toUpperCase() === this.form.nama.trim().toUpperCase());

                        // Login berhasil meski data kosong (untuk melihat jadwal remidi)
                        this.isLoggedIn = true;
                    } catch(e) {
                        alert("Gagal memuat data: " + e.message);
                    } finally {
                        this.isLoading = false;
                    }
                },

                logout() {
                    this.isLoggedIn = false;
                    this.studentResults = [];
                    this.studentList = [];
                    this.form = { nama: '', kelas: '' };
                    this.isAdminMode = false;
                },

                // --- KALKULASI NILAI ---
                getStudentScore(mapelName) {
                    const result = this.studentResults.find(r => r.mapel === mapelName);
                    if (!result) return null; 

                    const exam = this.bankSoalCache[result.examId];
                    if (!exam) return 0; 

                    let score = 0;
                    exam.soal.forEach((q, idx) => {
                        if (['PG', 'BS'].includes(q.type) && result.answers[idx] === q.answer) {
                            score += parseInt(q.poin);
                        }
                        if (['URAIAN', 'ESAI', 'ISIAN'].includes(q.type) && result.manualScores && result.manualScores[idx] !== undefined) {
                            score += parseInt(result.manualScores[idx]);
                        }
                    });
                    return score;
                },

                // --- ADMIN JADWAL ---
                enableAdminMode() {
                    if(this.isAdminMode) {
                        this.isAdminMode = false;
                    } else {
                        const pass = prompt("Masukkan Password Admin:");
                        if(pass === 'admin123') {
                            this.isAdminMode = true;
                        } else {
                            alert("Password Salah!");
                        }
                    }
                },
                async addSchedule() {
                    if(!this.newSchedule.mapel || !this.newSchedule.hari || !this.newSchedule.waktu) return alert("Lengkapi jadwal!");
                    try {
                        await addDoc(collection(db, "jadwal_remidi"), this.newSchedule);
                        this.newSchedule = { mapel: '', hari: '', waktu: '' };
                        alert("Jadwal ditambahkan.");
                    } catch(e) { alert("Gagal: " + e.message); }
                },
                async deleteSchedule(id) {
                    if(confirm("Hapus jadwal ini?")) await deleteDoc(doc(db, "jadwal_remidi", id));
                }
            }
        }).mount('#app');
    </script>
</body>
</html>
