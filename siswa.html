<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ujian CBT Online - SMP ALBANNA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Montserrat', sans-serif; user-select: none; -webkit-user-select: none; }
        .animate-pop { animation: popIn 0.3s ease-out; }
        @keyframes popIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        
        /* Scroll smooth */
        html { scroll-behavior: smooth; }
        
        /* Watermark */
        .watermark {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 9999;
            display: flex; flex-wrap: wrap; justify-content: space-around; align-items: center; opacity: 0.06; overflow: hidden;
        }
        .watermark-text { transform: rotate(-30deg); font-size: 18px; font-weight: bold; color: #000; margin: 50px; white-space: nowrap; }

        /* Animasi Sidebar Navigasi */
        .slide-enter-active, .slide-leave-active { transition: transform 0.3s ease-in-out; }
        .slide-enter-from, .slide-leave-to { transform: translateX(100%); }
        
        /* Hide scrollbar for nav */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen" oncontextmenu="return false;">

    <div id="app" class="min-h-screen flex flex-col relative">
        
        <!-- WATERMARK LAYER (HANYA MUNCUL SAAT UJIAN AKTIF) -->
        <div v-if="isExamActive" class="watermark">
            <div v-for="n in 30" class="watermark-text">{{ student.nama }} - {{ student.kelas }} - DILARANG MENYEBARLUASKAN</div>
        </div>

        <!-- LOADING OVERLAY -->
        <div v-if="isLoading" class="fixed inset-0 bg-white flex flex-col items-center justify-center z-50 opacity-95">
            <i class="fas fa-circle-notch fa-spin fa-3x text-blue-900 mb-4"></i>
            <p class="text-blue-900 font-bold animate-pulse">{{ loadingMessage }}</p>
        </div>

        <!-- 1. HALAMAN LOGIN -->
        <div v-if="!isExamActive && !isLocked && !isFinished && !isLoading && !showWarningModal" class="flex flex-col items-center justify-center min-h-screen px-4 bg-gray-100">
            <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-md border-t-8 border-blue-900">
                <div class="text-center mb-6">
                    <div class="bg-blue-100 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-4 text-blue-900">
                        <i class="fas fa-user-graduate fa-3x"></i>
                    </div>
                    <h1 class="text-2xl font-bold text-blue-900">LOGIN PESERTA</h1>
                    <p class="text-xs text-gray-500 tracking-widest">CBT SMP ALBANNA</p>
                </div>

                <div class="space-y-4">
                    <!-- 1. Kelas (Paling Atas) -->
                    <div>
                        <label class="block text-xs font-bold text-gray-600 uppercase mb-1">Kelas</label>
                        <select v-model="student.kelas" @change="fetchStudents" class="w-full p-3 border rounded bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-900">
                            <option value="" disabled>-- Pilih Kelas --</option>
                            <optgroup label="Kelas 7"><option v-for="c in 'ABCDEF'" :value="'7'+c">7{{c}}</option></optgroup>
                            <optgroup label="Kelas 8"><option v-for="c in 'ABCDEF'" :value="'8'+c">8{{c}}</option></optgroup>
                            <optgroup label="Kelas 9"><option v-for="c in 'ABCDE'" :value="'9'+c">9{{c}}</option></optgroup>
                        </select>
                    </div>

                    <!-- 2. Nama -->
                    <div>
                        <label class="block text-xs font-bold text-gray-600 uppercase mb-1">Nama Lengkap</label>
                        <select v-model="student.nama" :disabled="!student.kelas || studentList.length === 0" class="w-full p-3 border rounded bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-900 disabled:bg-gray-200 disabled:text-gray-400">
                            <option value="" disabled>-- Pilih Nama Siswa --</option>
                            <option v-for="s in studentList" :key="s.id" :value="s.nama">{{ s.nama }}</option>
                        </select>
                        <p v-if="isLoadingList" class="text-xs text-blue-500 mt-1 italic animate-pulse">
                            Sedang memuat daftar siswa...
                        </p>
                        <p v-if="!isLoadingList && student.kelas && studentList.length === 0" class="text-xs text-red-500 mt-1 italic">
                            * Data siswa kelas {{ student.kelas }} belum diinput Guru.
                        </p>
                    </div>

                    <!-- 3. Mapel -->
                    <div>
                        <label class="block text-xs font-bold text-gray-600 uppercase mb-1">Mata Pelajaran</label>
                        <select v-model="selectedExamId" class="w-full p-3 border rounded bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-900">
                            <option value="" disabled>-- Pilih Soal Ujian --</option>
                            <option v-for="exam in availableExams" :value="exam.id">
                                {{ exam.config.mapel }} ({{ exam.config.durasi }} Menit)
                            </option>
                        </select>
                        
                        <p v-if="availableExams.length === 0 && student.kelas" class="text-xs text-red-500 mt-2 italic bg-red-50 p-2 rounded border border-red-100">
                            <i class="fas fa-info-circle"></i> Tidak ada ujian aktif untuk kelas {{ student.kelas }}.<br>Hubungi pengawas jika soal belum dibuka.
                        </p>
                    </div>

                    <button @click="checkLogin" class="w-full bg-blue-900 text-white py-4 rounded-lg font-bold mt-4 hover:bg-blue-800 transition shadow-lg flex justify-center items-center gap-2">
                        <span>MASUK UJIAN</span> <i class="fas fa-sign-in-alt"></i>
                    </button>
                </div>
            </div>
            <p class="mt-6 text-xs text-gray-400 text-center">&copy; 2025 IT SMP Albanna.<br>Sistem Monitoring Aktif.</p>
        </div>

        <!-- 1.5. MODAL PERINGATAN -->
        <div v-if="showWarningModal" class="fixed inset-0 bg-slate-900 bg-opacity-90 flex items-center justify-center z-50 p-4">
            <div class="bg-white w-full max-w-lg rounded-xl shadow-2xl overflow-hidden animate-pop">
                <div class="bg-red-600 p-4 text-white text-center">
                    <i class="fas fa-exclamation-triangle fa-3x mb-2"></i>
                    <h2 class="text-xl font-bold">PERATURAN UJIAN</h2>
                </div>
                <div class="p-6">
                    <div class="bg-red-50 border-l-4 border-red-600 p-4 mb-6 text-sm text-gray-700 space-y-3">
                        <ul class="list-disc pl-5 space-y-1 font-medium">
                            <li>Dilarang keras <strong>keluar dari browser</strong>, <strong>pindah tab</strong>, atau <strong>minimize</strong>.</li>
                            <li>Dilarang melakukan <strong>Screenshot</strong> atau <strong>Rekam Layar</strong>.</li>
                            <li>Pelanggaran akan menyebabkan akun <strong>TERKUNCI OTOMATIS</strong>.</li>
                        </ul>
                    </div>

                    <div class="flex items-start gap-3 mb-6 p-3 border rounded-lg bg-gray-50 cursor-pointer hover:bg-gray-100 transition" @click="agreed = !agreed">
                        <div :class="['w-6 h-6 border-2 rounded flex items-center justify-center shrink-0 transition', agreed ? 'bg-blue-600 border-blue-600 text-white' : 'border-gray-400 bg-white']">
                            <i class="fas fa-check text-xs" v-if="agreed"></i>
                        </div>
                        <span class="text-sm font-bold text-gray-600 select-none">Saya menyetujui dan siap mengerjakan dengan jujur.</span>
                    </div>

                    <button @click="startExam" :disabled="!agreed" :class="['w-full py-4 rounded-lg font-bold text-lg transition shadow-lg flex justify-center items-center gap-2', agreed ? 'bg-blue-900 text-white hover:bg-blue-800 transform hover:scale-[1.02]' : 'bg-gray-300 text-gray-500 cursor-not-allowed']">
                        <span>BUKA SOAL</span> <i class="fas fa-unlock"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- 2. HALAMAN UJIAN -->
        <div v-if="isExamActive && !isLocked" class="flex-1 flex flex-col">
            
            <!-- Header Ujian -->
            <div class="sticky top-0 bg-white shadow-md z-40 px-4 py-3 flex justify-between items-center border-b-4 border-blue-900">
                <div class="flex flex-col">
                    <h2 class="font-bold text-blue-900 text-lg leading-tight">{{ student.mapel }}</h2>
                    <p class="text-xs text-gray-500 font-mono">{{ student.nama }} | {{ student.kelas }}</p>
                </div>
                <div class="flex items-center gap-3">
                    <!-- Tombol Toggle Navigasi -->
                    <button @click="showNav = !showNav" :class="['px-3 py-2 rounded border font-bold text-xs flex items-center gap-1 transition', showNav ? 'bg-blue-600 text-white border-blue-600' : 'bg-indigo-100 text-indigo-700 border-indigo-200 hover:bg-indigo-200']">
                        <i class="fas fa-th"></i> <span class="hidden md:inline">{{ showNav ? 'TUTUP NAV' : 'NO. SOAL' }}</span>
                    </button>
                    <!-- Timer -->
                    <div :class="['px-4 py-2 rounded font-mono font-bold text-xl border-2', timerSeconds < 300 ? 'bg-red-50 text-red-600 border-red-200 animate-pulse' : 'bg-gray-100 text-gray-700 border-gray-200']">
                        {{ timerDisplay }}
                    </div>
                </div>
            </div>

            <div class="flex-1 flex overflow-hidden relative">
                
                <!-- AREA SOAL (Scrollable) -->
                <div class="flex-1 overflow-y-auto p-4 pb-32 w-full" id="question-container">
                    <div class="max-w-4xl mx-auto">
                        <div v-for="(group, gIndex) in groupedQuestions" :key="gIndex" class="mb-8">
                            <h3 class="text-sm font-bold text-gray-500 mb-4 border-b-2 border-dashed border-gray-300 pb-2 uppercase flex items-center gap-2">
                                <span class="bg-blue-900 text-white w-6 h-6 flex items-center justify-center rounded text-xs">{{ group.questions.length }}</span> {{ group.label }}
                            </h3>
                            
                            <div v-for="(q, index) in group.questions" :key="q.originalIndex" :id="'q-' + q.originalIndex" class="bg-white p-6 rounded-xl shadow-sm mb-6 border border-gray-100 hover:shadow-md transition scroll-mt-24">
                                <div class="flex justify-between items-start mb-4">
                                    <div class="flex gap-3">
                                        <div class="bg-blue-100 text-blue-800 w-8 h-8 flex items-center justify-center rounded-full font-bold text-sm shrink-0 border border-blue-200">
                                            {{ getDisplayNumber(q.originalIndex) }}
                                        </div>
                                        <!-- Checkbox Ragu-ragu -->
                                        <label class="flex items-center gap-1 cursor-pointer select-none">
                                            <input type="checkbox" v-model="doubts[q.originalIndex]" class="w-4 h-4 text-yellow-500 rounded border-gray-300 focus:ring-yellow-500">
                                            <span class="text-xs font-bold text-yellow-600 bg-yellow-50 px-2 py-0.5 rounded border border-yellow-200 hover:bg-yellow-100 transition">RAGU-RAGU</span>
                                        </label>
                                    </div>
                                </div>

                                <div class="pl-0 md:pl-11">
                                    <div v-if="q.image" class="mb-4"><img :src="q.image" class="max-h-64 rounded-lg border shadow-sm cursor-zoom-in" onclick="window.open(this.src)"></div>
                                    <p class="text-gray-800 font-medium mb-5 text-lg leading-relaxed whitespace-pre-wrap">{{ q.text }}</p>
                                    
                                    <!-- Jawaban -->
                                    <div v-if="q.type === 'PG'" class="space-y-3">
                                        <label v-for="opt in ['A','B','C','D']" :class="['flex items-center p-3 border-2 rounded-lg cursor-pointer transition-all relative overflow-hidden', answers[q.originalIndex] === opt ? 'bg-blue-50 border-blue-500 text-blue-900' : 'border-gray-100 hover:bg-gray-50']">
                                            <input type="radio" :name="'q'+q.originalIndex" :value="opt" v-model="answers[q.originalIndex]" class="hidden">
                                            <div :class="['w-8 h-8 flex items-center justify-center rounded-full font-bold mr-3 transition-colors', answers[q.originalIndex] === opt ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-500']">{{ opt }}</div><span class="font-medium">{{ q.options[opt] }}</span>
                                        </label>
                                    </div>
                                    <div v-if="q.type === 'BS'" class="flex gap-4">
                                        <label :class="['flex-1 p-4 border-2 rounded-lg text-center cursor-pointer font-bold transition-all', answers[q.originalIndex] === 'BENAR' ? 'bg-green-50 border-green-500 text-green-700' : 'border-gray-100 hover:bg-gray-50']"><input type="radio" :name="'q'+q.originalIndex" value="BENAR" v-model="answers[q.originalIndex]" class="hidden"> BENAR</label>
                                        <label :class="['flex-1 p-4 border-2 rounded-lg text-center cursor-pointer font-bold transition-all', answers[q.originalIndex] === 'SALAH' ? 'bg-red-50 border-red-500 text-red-700' : 'border-gray-100 hover:bg-gray-50']"><input type="radio" :name="'q'+q.originalIndex" value="SALAH" v-model="answers[q.originalIndex]" class="hidden"> SALAH</label>
                                    </div>
                                    <div v-if="q.type === 'PG_KOMPLEKS'" class="space-y-2">
                                        <label v-for="(opt, i) in q.options" :class="['flex items-center p-3 border-2 rounded-lg cursor-pointer transition-all', (answers[q.originalIndex] || []).includes(i) ? 'bg-blue-50 border-blue-500' : 'border-gray-100 hover:bg-gray-50']"><input type="checkbox" :value="i" v-model="answers[q.originalIndex]" class="mr-3 w-5 h-5 text-blue-600 rounded focus:ring-blue-500"><span>{{ opt.text }}</span></label>
                                    </div>
                                    <div v-if="['URAIAN', 'ESAI', 'ISIAN'].includes(q.type)"><textarea v-model="answers[q.originalIndex]" rows="5" class="w-full p-4 border-2 border-gray-200 rounded-lg focus:border-blue-500 outline-none text-gray-700 bg-gray-50" placeholder="Ketik jawaban..."></textarea></div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-10 mb-20">
                            <button @click="submitExam" class="w-full bg-green-600 text-white py-5 rounded-xl font-bold text-xl hover:bg-green-700 shadow-lg flex items-center justify-center gap-3"><i class="fas fa-paper-plane"></i> KIRIM JAWABAN SAYA</button>
                        </div>
                    </div>
                </div>

                <!-- PANEL NAVIGASI FLOATING (KANAN) -->
                <transition name="slide">
                    <div v-if="showNav" class="w-80 bg-white shadow-2xl border-l border-gray-200 flex flex-col fixed right-0 top-[76px] bottom-0 z-50 md:absolute md:top-0">
                        <div class="p-4 border-b bg-gray-50 flex justify-between items-center">
                            <h3 class="font-bold text-gray-700">Navigasi Soal</h3>
                            <button @click="showNav = false" class="text-gray-400 hover:text-red-500"><i class="fas fa-times fa-lg"></i></button>
                        </div>
                        <div class="p-4 overflow-y-auto flex-1">
                            <div class="grid grid-cols-5 gap-2">
                                <button v-for="(status, idx) in questionStatusList" :key="idx" 
                                    @click="scrollToQuestion(status.originalIndex)"
                                    :class="['h-10 rounded-lg font-bold text-sm transition shadow-sm border flex items-center justify-center', status.class]">
                                    {{ idx + 1 }}
                                </button>
                            </div>
                            
                            <div class="mt-6 space-y-3 text-xs text-gray-600 font-medium border-t pt-4">
                                <div class="flex items-center gap-2"><div class="w-4 h-4 bg-green-500 rounded border border-green-600"></div> Sudah Dijawab</div>
                                <div class="flex items-center gap-2"><div class="w-4 h-4 bg-yellow-400 rounded border border-yellow-500"></div> Ragu-ragu</div>
                                <div class="flex items-center gap-2"><div class="w-4 h-4 bg-gray-100 rounded border border-gray-300"></div> Belum Dijawab</div>
                            </div>
                        </div>
                    </div>
                </transition>

            </div>
        </div>

        <!-- 3. HALAMAN TERBLOKIR (PERSISTENT) -->
        <div v-if="isLocked" class="min-h-screen bg-red-600 flex flex-col items-center justify-center text-white p-8 text-center z-50">
            <div class="bg-white p-8 rounded-full mb-6 shadow-xl animate-pulse"><i class="fas fa-lock fa-5x text-red-600"></i></div>
            <h1 class="text-4xl font-bold mb-2">UJIAN TERKUNCI!</h1>
            <p class="text-xl mb-8 opacity-90">Anda terdeteksi keluar/refresh halaman ujian.</p>
            <div class="bg-red-800 bg-opacity-50 p-6 rounded-xl border border-red-400 max-w-lg">
                <h3 class="font-bold mb-2 text-sm">SOLUSI:</h3><p class="mb-2">Lapor Pengawas untuk buka blokir.</p>
                <div class="bg-white text-red-900 px-4 py-2 rounded font-mono font-bold text-lg">{{ student.nama || 'Siswa' }}</div>
                <div class="mt-2 text-xs italic opacity-75">Menunggu admin membuka blokir...</div>
            </div>
        </div>

        <!-- 4. HALAMAN SELESAI -->
        <div v-if="isFinished" class="min-h-screen bg-green-50 flex flex-col items-center justify-center p-8 text-center">
            <div class="bg-white p-6 rounded-full shadow-lg mb-6"><i class="fas fa-check-circle fa-5x text-green-500"></i></div>
            <h1 class="text-3xl font-bold text-green-800 mb-2">UJIAN SELESAI</h1>
            <p class="text-gray-600 mb-8">Jawaban Anda telah berhasil disimpan.</p>
            <p class="mt-8 text-xs text-gray-400 animate-pulse">Mengalihkan ke halaman login...</p>
        </div>

    </div>

    <script type="module">
        import { createApp } from 'https://unpkg.com/vue@3/dist/vue.esm-browser.js';
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, query, where, onSnapshot, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBivREr2y61OYTE0kLxRnkGtPCdLvHn_og",
            authDomain: "cbt-albanna.firebaseapp.com",
            projectId: "cbt-albanna",
            storageBucket: "cbt-albanna.firebasestorage.app",
            messagingSenderId: "740622197344",
            appId: "1:740622197344:web:6112adf59edfbe496ed905"
        };

        const appFirebase = initializeApp(firebaseConfig);
        const db = getFirestore(appFirebase);

        createApp({
            data() {
                return {
                    loadingMessage: 'Menghubungkan...', isLoading: true, isLoadingList: false,
                    student: { nama: '', kelas: '', mapel: '' }, studentList: [],
                    allExams: [], selectedExamId: '',
                    isExamActive: false, isLocked: false, isFinished: false, showWarningModal: false, agreed: false,
                    groupedQuestions: [], answers: {}, doubts: {}, showNav: false, 
                    timerSeconds: 0, timerInterval: null, submitTime: '',
                    unlockListener: null, flatQuestionOrder: [] 
                }
            },
            computed: {
                availableExams() {
                    if(!this.student.kelas) return [];
                    const grade = this.student.kelas.charAt(0);
                    return this.allExams.filter(e => e.config.kelas == grade && e.isLocked === false);
                },
                timerDisplay() {
                    const m = Math.floor(this.timerSeconds/60); const s = this.timerSeconds%60;
                    return `${m}:${s<10?'0'+s:s}`;
                },
                questionStatusList() {
                    return this.flatQuestionOrder.map((qOriginalIndex) => {
                        const isDoubt = this.doubts[qOriginalIndex];
                        const answer = this.answers[qOriginalIndex];
                        const isAnswered = (answer !== null && answer !== '' && (!Array.isArray(answer) || answer.length > 0));
                        let btnClass = 'bg-gray-100 text-gray-500 border-gray-200 hover:bg-gray-200'; 
                        if (isDoubt) btnClass = 'bg-yellow-400 text-white border-yellow-500 hover:bg-yellow-500'; 
                        else if (isAnswered) btnClass = 'bg-green-500 text-white border-green-600 hover:bg-green-600';
                        return { originalIndex: qOriginalIndex, class: btnClass };
                    });
                }
            },
            async mounted() {
                // ANTI SCREENSHOT & SHORTCUT
                document.addEventListener('keyup', (e) => { if (e.key === 'PrintScreen') { navigator.clipboard.writeText(''); this.triggerLock("Screenshot"); } });
                document.addEventListener('visibilitychange', () => { if (document.hidden && this.isExamActive) this.triggerLock("Pindah Tab"); });
                ['copy','cut','paste','contextmenu'].forEach(e => document.addEventListener(e, ev => ev.preventDefault()));

                const lockedData = localStorage.getItem('cbt_client_lock');
                if (lockedData) {
                    const data = JSON.parse(lockedData);
                    this.student = data.student; this.selectedExamId = data.examId;
                    this.isLocked = true; this.isLoading = false; this.listenForUnlock();
                    return; 
                }

                try {
                    const q = query(collection(db, "bank_soal"));
                    const snapshot = await getDocs(q);
                    this.allExams = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                } catch (e) { console.log(e); } finally { this.isLoading = false; }

                window.history.pushState(null, null, window.location.href);
                window.onpopstate = function () { window.history.go(1); };
                window.onbeforeunload = function() { return "Ujian akan terblokir!"; };
            },
            methods: {
                async fetchStudents() {
                    if(!this.student.kelas) return;
                    this.isLoadingList = true; this.studentList = []; this.student.nama = ''; 
                    try {
                        // Query hanya berdasarkan kelas, sort manual
                        const q = query(collection(db, "data_absensi"), where("kelas", "==", this.student.kelas));
                        const snapshot = await getDocs(q);
                        this.studentList = snapshot.docs.map(doc => doc.data()).sort((a,b) => a.nama.localeCompare(b.nama));
                    } catch(e) {
                        console.log("Fallback sorting client-side:", e);
                    } finally { this.isLoadingList = false; }
                },

                shuffleArray(array) { for (let i = array.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [array[i], array[j]] = [array[j], array[i]]; } return array; },
                
                async checkLogin() {
                    if(!this.student.nama || !this.student.kelas || !this.selectedExamId) return alert("Lengkapi data!");
                    this.isLoading = true;
                    try {
                        // Cek Ganda (Filter Manual untuk stabilitas)
                        const qSubmit = query(collection(db, "jawaban_siswa"), where("examId", "==", this.selectedExamId));
                        const snapSubmit = await getDocs(qSubmit);
                        if(snapSubmit.docs.some(doc => doc.data().student.nama.toUpperCase() === this.student.nama.toUpperCase())) throw new Error("Sudah Mengerjakan.");

                        const qBlock = query(collection(db, "blocked_students"), where("examId", "==", this.selectedExamId));
                        const snapBlock = await getDocs(qBlock);
                        if(snapBlock.docs.some(doc => doc.data().student.nama.toUpperCase() === this.student.nama.toUpperCase())) throw new Error("Terblokir.");

                        this.showWarningModal = true; 
                    } catch (e) { alert(e.message); } finally { this.isLoading = false; }
                },
                startExam() {
                    this.showWarningModal = false;
                    const exam = this.allExams.find(e => e.id === this.selectedExamId);
                    this.student.mapel = exam.config.mapel;
                    this.activeExam = exam;

                    const groups = {}; this.flatQuestionOrder = [];
                    exam.soal.forEach((q, idx) => {
                        if(!groups[q.type]) groups[q.type] = { label: q.typeLabel, questions: [] };
                        groups[q.type].questions.push({ ...q, originalIndex: idx });
                    });
                    this.groupedQuestions = Object.values(groups).map(g => {
                        const shuffled = this.shuffleArray(g.questions);
                        shuffled.forEach(q => this.flatQuestionOrder.push(q.originalIndex));
                        return { label: g.label, questions: shuffled };
                    });

                    this.answers = {}; this.doubts = {};
                    exam.soal.forEach((q, idx) => { this.answers[idx] = (q.type==='PG_KOMPLEKS' ? [] : null); this.doubts[idx] = false; });

                    this.timerSeconds = parseInt(exam.config.durasi) * 60;
                    this.timerInterval = setInterval(() => { if(this.timerSeconds > 0) this.timerSeconds--; else this.submitExam(true); }, 1000);

                    const elem = document.documentElement; if (elem.requestFullscreen) elem.requestFullscreen().catch(()=>{});
                    this.isExamActive = true;
                    this.showNav = true; 
                },
                scrollToQuestion(idx) {
                    const el = document.getElementById('q-' + idx);
                    if (el) { el.scrollIntoView({ behavior: 'smooth', block: 'center' }); if (window.innerWidth < 768) this.showNav = false; }
                },
                getDisplayNumber(idx) { return this.flatQuestionOrder.indexOf(idx) + 1; },
                async triggerLock(reason) {
                    if(this.isLocked) return;
                    this.isExamActive = false; this.isLocked = true; clearInterval(this.timerInterval);
                    localStorage.setItem('cbt_client_lock', JSON.stringify({ student: this.student, examId: this.activeExam.id, mapel: this.activeExam.config.mapel }));
                    try { await addDoc(collection(db, "blocked_students"), { student: this.student, examId: this.activeExam.id, mapel: this.activeExam.config.mapel, reason: reason, timestamp: new Date().toISOString() }); this.listenForUnlock(); } catch(e) {}
                },
                listenForUnlock() {
                    const q = query(collection(db, "blocked_students"), where("examId", "==", this.selectedExamId));
                    this.unlockListener = onSnapshot(q, (snap) => {
                        if (!snap.docs.find(doc => doc.data().student.nama.toUpperCase() === this.student.nama.toUpperCase())) {
                            alert("Blokir dibuka."); localStorage.removeItem('cbt_client_lock'); window.location.reload(); 
                        }
                    });
                },
                async submitExam(force=false) {
                    if(!force) {
                        // VALIDASI JAWABAN & RAGU-RAGU
                        for(let i=0; i<this.activeExam.soal.length; i++) { 
                            const ans = this.answers[i];
                            const isDoubt = this.doubts[i];
                            
                            if(ans === null || ans === '' || (Array.isArray(ans) && ans.length===0)) {
                                return alert(`Soal No. ${this.getDisplayNumber(i)} belum dijawab!`);
                            }
                            
                            if (isDoubt) {
                                return alert(`Soal No. ${this.getDisplayNumber(i)} masih ditandai Ragu-ragu. Hilangkan centang Ragu-ragu untuk mengirim.`);
                            }
                        }
                        if(!confirm("Kirim Jawaban?")) return;
                    }
                    this.isLoading = true;
                    try {
                        await addDoc(collection(db, "jawaban_siswa"), { student: this.student, examId: this.activeExam.id, mapel: this.activeExam.config.mapel, answers: this.answers, timestamp: new Date().toISOString() });
                        this.isExamActive = false; this.isFinished = true; this.submitTime = new Date().toLocaleTimeString();
                        if (document.exitFullscreen) document.exitFullscreen();
                        window.onbeforeunload = null; localStorage.removeItem('cbt_client_lock'); 
                        // REDIRECT RELOAD KE LOGIN
                        setTimeout(() => { window.location.reload(); }, 3000);
                    } catch(e) { alert("Gagal: " + e.message); this.isExamActive = true; } finally { this.isLoading = false; }
                }
            }
        }).mount('#app');
    </script>
</body>
</html>
