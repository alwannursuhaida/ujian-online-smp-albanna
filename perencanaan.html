<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Perencanaan Pembelajaran - SMP ALBANNA</title>
    
    <!-- FAVICON -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸŽ“</text></svg>">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    
    <!-- PDF Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Montserrat', sans-serif; }
        .fade-enter-active, .fade-leave-active { transition: opacity 0.4s ease; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
        
        .animate-float { animation: float 6s ease-in-out infinite; }
        @keyframes float { 0% { transform: translateY(0px); } 50% { transform: translateY(-20px); } 100% { transform: translateY(0px); } }
        
        .bg-glass { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); }

        .details-grid {
            display: grid;
            grid-template-columns: 220px 20px 1fr;
            gap: 8px;
            margin-bottom: 1.5rem;
            align-items: start;
        }
        .details-label { font-weight: bold; color: #1e3a8a; }
        .details-colon { text-align: center; font-weight: bold; color: #64748b; }
        .details-value { color: #334155; white-space: pre-wrap; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen pb-20">

    <div id="app" class="max-w-6xl mx-auto pt-10 px-4">
        
        <!-- NAVBAR -->
        <div class="flex justify-between items-center mb-8">
            <div class="flex items-center gap-3">
                <div class="bg-gradient-to-br from-blue-900 to-blue-700 text-white p-3 rounded-xl shadow-lg">
                    <i class="fas fa-pen-nib fa-lg"></i>
                </div>
                <div>
                    <h1 class="text-2xl font-bold text-slate-800 tracking-tight">PERENCANAAN PEMBELAJARAN</h1>
                    <p class="text-xs text-gray-500 font-bold tracking-widest">SMP ALBANNA</p>
                </div>
            </div>
            <div class="flex gap-3">
                <button v-if="viewMode === 'form'" @click="switchView('list')" class="text-gray-500 hover:text-blue-900 font-bold text-sm flex items-center gap-2 transition px-4 py-2 bg-white rounded-lg border hover:shadow-md">
                    <i class="fas fa-list"></i> Lihat Arsip
                </button>
                <a href="index.html" class="text-gray-500 hover:text-blue-900 font-bold text-sm flex items-center gap-2 transition px-4 py-2 bg-white rounded-lg border hover:shadow-md">
                    <i class="fas fa-home"></i> Menu Utama
                </a>
            </div>
        </div>
        
        <!-- INFO USER LOGIN -->
        <div v-if="currentUser" class="mb-6 flex justify-end text-xs text-gray-500">
            Login sebagai: <span class="font-bold text-blue-900 ml-1">{{ currentUser.name }}</span>
        </div>

        <!-- VIEW 1: LIST ARSIP -->
        <transition name="fade">
            <div v-if="viewMode === 'list'" class="space-y-6">
                <div class="flex justify-between items-center bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                    <div>
                        <h2 class="text-xl font-bold text-slate-800">Arsip Perencanaan Anda</h2>
                        <p class="text-sm text-gray-500">Kelola draft dan modul ajar yang telah dibuat.</p>
                    </div>
                    <button @click="createNew" class="bg-blue-600 text-white px-6 py-3 rounded-xl font-bold shadow-lg hover:bg-blue-700 hover:shadow-blue-200 transition transform hover:-translate-y-1 flex items-center gap-2">
                        <i class="fas fa-plus"></i> BUAT BARU
                    </button>
                </div>

                <div v-if="savedPlans.length === 0" class="text-center py-20 bg-white rounded-2xl border border-dashed border-gray-300">
                    <i class="fas fa-folder-open text-gray-300 text-6xl mb-4"></i>
                    <p class="text-gray-500 font-medium">Belum ada perencanaan tersimpan.</p>
                </div>

                <div v-else class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <div v-for="(plan, index) in savedPlans" :key="plan.id" class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 hover:shadow-md transition group relative overflow-hidden">
                        <div class="absolute top-0 left-0 w-2 h-full bg-blue-500"></div>
                        <div class="flex justify-between items-start mb-3">
                            <div class="flex gap-2">
                                <span class="bg-blue-50 text-blue-700 text-xs font-bold px-2 py-1 rounded uppercase">{{ plan.fase }}</span>
                                <span class="bg-indigo-50 text-indigo-700 text-xs font-bold px-2 py-1 rounded uppercase">{{ plan.mapel }}</span>
                            </div>
                            <span class="text-[10px] text-gray-400">{{ new Date(plan.lastUpdated).toLocaleDateString() }}</span>
                        </div>
                        <h3 class="font-bold text-lg text-slate-800 mb-1 line-clamp-2 h-14">{{ plan.lingkupMateri || 'Tanpa Judul' }}</h3>
                        <p class="text-xs text-gray-500 mb-4"><i class="fas fa-user-circle mr-1"></i> {{ plan.nama }}</p>
                        
                        <div class="grid grid-cols-3 gap-2 border-t pt-4 mt-2">
                            <button @click="editPlan(index)" class="py-2 bg-yellow-50 text-yellow-600 rounded-lg text-xs font-bold hover:bg-yellow-100 transition"><i class="fas fa-pen"></i> Edit</button>
                            <button @click="viewPlan(index)" class="py-2 bg-blue-50 text-blue-600 rounded-lg text-xs font-bold hover:bg-blue-100 transition"><i class="fas fa-eye"></i> Lihat</button>
                            <button @click="deletePlan(index)" class="py-2 bg-red-50 text-red-600 rounded-lg text-xs font-bold hover:bg-red-100 transition"><i class="fas fa-trash"></i> Hapus</button>
                        </div>
                        <button @click.stop="generatePDF(plan)" class="w-full mt-2 py-2 bg-green-50 text-green-700 rounded-lg text-xs font-bold hover:bg-green-100 transition flex items-center justify-center gap-1 relative z-10 cursor-pointer border border-green-100">
                            <i class="fas fa-file-pdf"></i> Ekstrak PDF
                        </button>
                    </div>
                </div>
            </div>
        </transition>

        <!-- VIEW 2: FORM WIZARD -->
        <transition name="fade">
            <div v-if="viewMode === 'form'">
                
                <!-- PROGRESS BAR -->
                <div class="w-full bg-gray-200 rounded-full h-2 mb-8">
                    <div class="bg-gradient-to-r from-blue-500 to-indigo-600 h-2 rounded-full transition-all duration-500 shadow-sm" :style="{ width: (step / 8) * 100 + '%' }"></div>
                </div>

                <!-- STEP 1: IDENTITAS -->
                <div v-if="step === 1" class="bg-white p-8 rounded-2xl shadow-xl border-t-8 border-blue-900 animate-pop">
                    <h2 class="text-xl font-bold text-gray-800 mb-6 border-b pb-2 flex items-center gap-2"><i class="fas fa-id-card text-blue-600"></i> 1. Identitas Perangkat Ajar</h2>
                    
                    <!-- INFO LOGO -->
                    <div class="mb-6 bg-blue-50 p-4 rounded-lg border border-blue-100 text-center text-sm text-blue-800">
                        <i class="fas fa-magic mr-2"></i> Menggunakan Kop Otomatis (Server).
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="md:col-span-2">
                            <label class="block text-sm font-bold text-gray-700 mb-2">Mata Pelajaran <span class="text-red-500">*</span></label>
                            <select v-model="form.mapel" class="w-full p-4 border-2 border-gray-200 rounded-xl focus:border-blue-500 outline-none font-bold text-blue-900">
                                <option value="" disabled>-- Pilih Mata Pelajaran --</option>
                                <option v-for="m in mapelList" :value="m">{{ m }}</option>
                            </select>
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-sm font-bold text-gray-700 mb-2">Lingkup Materi (Judul Modul) <span class="text-red-500">*</span></label>
                            <input v-model="form.lingkupMateri" class="w-full p-4 border-2 border-gray-200 rounded-xl focus:border-blue-500 outline-none font-bold text-lg text-blue-900 placeholder-gray-300" placeholder="Contoh: Sistem Pencernaan Manusia">
                        </div>
                        <div><label class="block text-sm font-bold text-gray-600 mb-2">Nama Penyusun <span class="text-red-500">*</span></label><input v-model="form.nama" class="w-full p-3 border rounded-lg outline-none focus:ring-2 focus:ring-blue-900" placeholder="Nama Lengkap"></div>
                        <div><label class="block text-sm font-bold text-gray-600 mb-2">Institusi</label><input v-model="form.institusi" class="w-full p-3 border rounded-lg bg-gray-50 text-gray-500" readonly></div>
                        <div>
                            <label class="block text-sm font-bold text-gray-600 mb-2">Fase / Kelas <span class="text-red-500">*</span></label>
                            <select v-model="form.fase" class="w-full p-3 border rounded-lg outline-none focus:ring-2 focus:ring-blue-900">
                                <option value="" disabled>-- Pilih Fase --</option>
                                <option value="Fase D (Kelas 7)">Fase D (Kelas 7)</option>
                                <option value="Fase D (Kelas 8)">Fase D (Kelas 8)</option>
                                <option value="Fase D (Kelas 9)">Fase D (Kelas 9)</option>
                            </select>
                        </div>
                        <div><label class="block text-sm font-bold text-gray-600 mb-2">Alokasi Waktu <span class="text-red-500">*</span></label><input v-model="form.waktu" class="w-full p-3 border rounded-lg outline-none focus:ring-2 focus:ring-blue-900" placeholder="Contoh: 2 JP"></div>
                    </div>
                    <div class="mt-8 flex justify-end"><button @click="nextStep" class="bg-blue-900 text-white px-8 py-3 rounded-xl font-bold hover:bg-blue-800 shadow-lg flex items-center gap-2 transition transform hover:scale-105">LANJUT <i class="fas fa-arrow-right"></i></button></div>
                </div>

                <!-- STEP 2-4 (SAMA SEPERTI SEBELUMNYA) -->
                <!-- ... (Bagian Motivasi & Identifikasi disingkat agar fokus ke perubahan) ... -->
                <div v-if="step === 2" class="flex flex-col items-center justify-center py-16 text-center"><h2 class="text-3xl font-bold text-slate-800 mb-6">Selamat! ðŸŽ‰</h2><button @click="nextStep" class="bg-blue-600 text-white px-8 py-3 rounded-full">Lanjut</button></div>
                <div v-if="step === 3" class="bg-white p-8 rounded-2xl shadow-xl border-t-8 border-blue-900"><h2 class="text-xl font-bold mb-4">Identifikasi</h2><div class="grid grid-cols-3 gap-4"><textarea v-model="form.pesertaDidik" class="border p-2 rounded" placeholder="Peserta Didik"></textarea><textarea v-model="form.materi" class="border p-2 rounded" placeholder="Materi"></textarea><div class="border p-2 rounded h-32 overflow-y-auto"><label v-for="i in profilOptions" :key="i" class="block"><input type="checkbox" :value="i" v-model="form.profil"> {{i}}</label></div></div><div class="mt-4 flex justify-end gap-2"><button @click="step=1">Kembali</button><button @click="nextStep" class="bg-blue-900 text-white px-6 py-2 rounded">Lanjut</button></div></div>
                <div v-if="step === 4" class="flex flex-col items-center justify-center py-16 text-center"><h2 class="text-3xl font-bold text-slate-800">"Guru adalah pekerjaan mulia."</h2><button @click="nextStep" class="bg-red-500 text-white px-8 py-3 rounded-full mt-4">Lanjut Desain</button></div>

                <!-- STEP 5: DESAIN PEMBELAJARAN (TP DINAMIS) -->
                <div v-if="step === 5" class="bg-white p-8 rounded-2xl shadow-xl border-t-8 border-teal-600">
                    <div class="flex justify-between mb-6 border-b pb-4"><h2 class="text-xl font-bold text-gray-800">4. Desain Pembelajaran</h2><button @click="step=3" class="text-sm text-gray-400 font-bold hover:text-teal-600"><i class="fas fa-arrow-left"></i> Kembali</button></div>
                    <div class="grid gap-6">
                        <div class="grid md:grid-cols-2 gap-4">
                            <div><label class="font-bold text-teal-800 text-sm mb-1 block">Capaian Pembelajaran (CP)</label><textarea v-model="form.cp" rows="2" class="w-full p-3 border rounded-lg bg-teal-50/50 focus:bg-white transition text-sm"></textarea></div>
                            <div><label class="font-bold text-teal-800 text-sm mb-1 block">Lintas Disiplin Ilmu</label><textarea v-model="form.lintasDisiplin" rows="2" class="w-full p-3 border rounded-lg bg-teal-50/50 focus:bg-white transition text-sm"></textarea></div>
                        </div>

                        <!-- TUJUAN PEMBELAJARAN & INDIKATOR -->
                        <div class="space-y-4 bg-teal-50 p-4 rounded-xl border border-teal-200">
                            <h3 class="font-bold text-teal-900 flex items-center gap-2"><i class="fas fa-bullseye"></i> Tujuan Pembelajaran & Indikator</h3>
                            
                            <div v-for="(item, index) in form.tujuanPembelajaran" :key="index" class="bg-white p-4 rounded-lg border border-teal-200 shadow-sm relative">
                                <button v-if="form.tujuanPembelajaran.length > 1" @click="removeTP(index)" class="absolute top-2 right-2 text-red-400 hover:text-red-600 text-xs font-bold"><i class="fas fa-times"></i> Hapus TP</button>
                                <div class="mb-3">
                                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Tujuan Pembelajaran {{ index + 1 }}</label>
                                    <textarea v-model="item.text" rows="2" class="w-full p-2 border rounded focus:ring-2 focus:ring-teal-500 outline-none text-sm" placeholder="Contoh: Peserta didik mampu menjelaskan..."></textarea>
                                </div>
                                <div class="pl-4 border-l-2 border-teal-100">
                                    <label class="block text-xs font-bold text-gray-400 mb-1 uppercase">Indikator (ITP) untuk TP {{ index + 1 }}</label>
                                    <div v-for="(ind, iIdx) in item.indikators" :key="iIdx" class="flex gap-2 mb-2">
                                        <span class="text-gray-400 text-xs pt-2">{{ iIdx + 1 }}.</span>
                                        <input v-model="ind.text" class="flex-1 p-2 border rounded text-xs bg-gray-50 focus:bg-white" placeholder="Indikator pencapaian...">
                                        <button v-if="item.indikators.length > 1" @click="removeIndikator(index, iIdx)" class="text-gray-400 hover:text-red-500"><i class="fas fa-minus-circle"></i></button>
                                    </div>
                                    <button @click="addIndikator(index)" class="text-xs font-bold text-teal-600 hover:text-teal-800 flex items-center gap-1 mt-1">
                                        <i class="fas fa-plus"></i> Tambah Indikator
                                    </button>
                                </div>
                            </div>
                            <button @click="addTP" class="w-full py-2 border-2 border-dashed border-teal-300 text-teal-600 font-bold rounded-lg hover:bg-teal-50 transition text-sm">
                                <i class="fas fa-plus-circle"></i> Tambah Tujuan Pembelajaran Baru
                            </button>
                        </div>

                        <!-- Field Lainnya -->
                        <div class="grid md:grid-cols-2 gap-4">
                            <div><label class="font-bold text-teal-800 text-sm mb-1 block">Topik Pembelajaran</label><input v-model="form.topik" class="w-full p-3 border rounded-lg bg-teal-50/50 focus:bg-white transition text-sm"></div>
                            <div><label class="font-bold text-teal-800 text-sm mb-1 block">Praktik Pedagogis</label><input v-model="form.pedagogi" class="w-full p-3 border rounded-lg bg-teal-50/50 focus:bg-white transition text-sm" placeholder="PBL, PjBL, Inkuiri..."></div>
                        </div>
                        <div class="grid md:grid-cols-3 gap-4">
                            <div><label class="font-bold text-teal-800 text-xs mb-1 block">Kemitraan Pembelajaran</label><textarea v-model="form.kemitraan" rows="2" class="w-full p-2 border rounded-lg text-xs"></textarea></div>
                            <div><label class="font-bold text-teal-800 text-xs mb-1 block">Lingkungan Pembelajaran</label><textarea v-model="form.lingkungan" rows="2" class="w-full p-2 border rounded-lg text-xs"></textarea></div>
                            <div><label class="font-bold text-teal-800 text-xs mb-1 block">Pemanfaatan Digital</label><textarea v-model="form.digital" rows="2" class="w-full p-2 border rounded-lg text-xs"></textarea></div>
                        </div>
                    </div>
                    <div class="mt-8 flex justify-end gap-3"><button @click="saveDraft()" class="text-gray-500 font-bold px-4 hover:text-teal-600 text-sm">Simpan Draft</button><button @click="nextStep" class="bg-teal-600 text-white px-8 py-3 rounded-xl font-bold hover:bg-teal-700 shadow-lg transition">LANJUT <i class="fas fa-arrow-right"></i></button></div>
                </div>

                <!-- STEP 6-7 (SAMA) -->
                <div v-if="step === 6" class="flex flex-col items-center justify-center py-24 text-center"><h2 class="text-2xl mb-4">Tarik Nafas...</h2><button @click="nextStep" class="bg-blue-600 text-white px-8 py-2 rounded-full">Lanjut</button></div>
                <div v-if="step === 7" class="bg-white p-8 rounded-2xl shadow-xl border-t-8 border-indigo-600"><h2 class="text-xl font-bold mb-4">5. Pengalaman Belajar</h2>
                    <div class="space-y-4">
                        <div class="border p-4 rounded"><h3 class="font-bold mb-2">A. Awal</h3><div class="flex gap-2 mb-2"><label v-for="p in prinsip" :key="'a'+p" class="text-xs"><input type="checkbox" :value="p" v-model="form.pengalamanAwal.prinsip"> {{p}}</label></div><textarea v-model="form.pengalamanAwal.deskripsi" class="w-full border p-2 rounded"></textarea></div>
                        <div class="border p-4 rounded"><h3 class="font-bold mb-2">B. Inti</h3>
                             <div class="mb-2"><label>Memahami</label><textarea v-model="form.pengalamanIntiMemahami.deskripsi" class="w-full border p-2 rounded"></textarea></div>
                             <div class="mb-2"><label>Mengaplikasi</label><textarea v-model="form.pengalamanIntiMengaplikasi.deskripsi" class="w-full border p-2 rounded"></textarea></div>
                             <div class="mb-2"><label>Merefleksi</label><textarea v-model="form.pengalamanIntiMerefleksi.deskripsi" class="w-full border p-2 rounded"></textarea></div>
                        </div>
                        <div class="border p-4 rounded"><h3 class="font-bold mb-2">C. Penutup</h3><div class="flex gap-2 mb-2"><label v-for="p in prinsip" :key="'t'+p" class="text-xs"><input type="checkbox" :value="p" v-model="form.pengalamanPenutup.prinsip"> {{p}}</label></div><textarea v-model="form.pengalamanPenutup.deskripsi" class="w-full border p-2 rounded"></textarea></div>
                    </div>
                    <div class="mt-4 flex justify-end"><button @click="nextStep" class="bg-indigo-600 text-white px-8 py-2 rounded">Lanjut</button></div>
                </div>

                <!-- STEP 8: ASESMEN -->
                <div v-if="step === 8" class="bg-white p-8 rounded-2xl shadow-xl border-t-8 border-pink-600 mb-20">
                    <div class="flex justify-between items-center mb-8 border-b pb-4">
                        <h2 class="text-xl font-bold text-gray-800">6. Asesmen & Lampiran</h2>
                        <button @click="step = 7" class="text-sm text-gray-400 hover:text-pink-700 font-bold"><i class="fas fa-arrow-left"></i> Kembali</button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                        <div v-for="(type, key) in {Awal: 'pink', Proses: 'purple', Akhir: 'teal'}" :key="key" :class="`bg-${type}-50 p-4 rounded-xl border border-${type}-100`">
                            <h3 :class="`font-bold text-${type}-800 mb-2 text-center border-b border-${type}-200 pb-2`">Asesmen {{key}}</h3>
                            <div class="mb-2 flex flex-wrap gap-1">
                                <label v-for="m in (key === 'Awal' ? methodsAwal : (key === 'Proses' ? methodsProses : methodsAkhir))" :key="key+m" class="text-[10px] bg-white px-2 py-1 border rounded cursor-pointer">
                                    <input type="checkbox" :value="m" v-model="form['asesmen'+key].metode" class="mr-1"> {{m}}
                                </label>
                            </div>
                            <textarea v-model="form['asesmen'+key].deskripsi" rows="4" class="w-full p-2 border rounded text-xs" placeholder="Deskripsi..."></textarea>
                        </div>
                    </div>
                    <div class="border-t pt-6">
                        <h3 class="font-bold text-gray-700 mb-3 flex items-center gap-2"><i class="fas fa-paperclip"></i> Lampiran</h3>
                        <div v-for="(item, index) in form.lampiran" :key="index" class="flex gap-2 mb-2">
                            <input v-model="item.nama" class="w-1/3 p-2 border rounded text-sm" placeholder="Nama Lampiran">
                            <input v-model="item.keterangan" class="flex-1 p-2 border rounded text-sm" placeholder="Keterangan / Link">
                            <button @click="removeLampiran(index)" class="text-red-500 hover:text-red-700 px-2"><i class="fas fa-trash"></i></button>
                        </div>
                        <button @click="addLampiran" class="mt-2 text-xs font-bold text-blue-600 hover:underline">+ Tambah Lampiran</button>
                    </div>
                    <div class="mt-10 flex justify-end gap-3 border-t pt-6">
                        <button @click="saveFinal" class="bg-green-600 text-white px-8 py-3 rounded-xl font-bold hover:bg-green-700 shadow-lg transition transform hover:scale-105 flex items-center gap-2">
                            <i class="fas fa-check-circle"></i> SELESAI & SIMPAN
                        </button>
                        <button @click="saveFinal" class="bg-pink-600 text-white px-8 py-3 rounded-xl font-bold hover:bg-pink-700 shadow-lg transition transform hover:scale-105 flex items-center gap-2">
                            <i class="fas fa-file-pdf"></i> EXPORT PDF
                        </button>
                    </div>
                </div>
            </div>
        </transition>

        <!-- MODAL VIEW (READ ONLY) -->
        <transition name="fade">
            <div v-if="viewModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                <div class="bg-white w-full max-w-4xl h-[90vh] rounded-2xl shadow-2xl flex flex-col overflow-hidden">
                    <div class="p-5 border-b bg-slate-50 flex justify-between items-center">
                        <div><h3 class="font-bold text-xl text-slate-800">{{ viewModal.lingkupMateri }}</h3><p class="text-xs text-gray-500">{{ viewModal.fase }} | {{ viewModal.nama }}</p></div>
                        <button @click="viewModal = null" class="text-gray-400 hover:text-red-500"><i class="fas fa-times fa-lg"></i></button>
                    </div>
                    <div class="flex-1 overflow-y-auto p-8 bg-gray-50 space-y-6">
                        <div class="bg-white p-6 rounded-xl shadow-sm border"><h4 class="font-bold text-blue-800 border-b pb-2 mb-2">I. Identitas</h4><div class="grid details-grid"><div class="details-label">Nama Penyusun</div><div class="details-colon">:</div><div class="details-value">{{ viewModal.nama }}</div><div class="details-label">Mata Pelajaran</div><div class="details-colon">:</div><div class="details-value">{{ viewModal.mapel }}</div><div class="details-label">Lingkup Materi</div><div class="details-colon">:</div><div class="details-value">{{ viewModal.lingkupMateri }}</div></div></div>
                        
                        <!-- VIEW TP LENGKAP -->
                        <div class="bg-white p-6 rounded-xl shadow-sm border">
                            <h4 class="font-bold text-green-800 border-b pb-2 mb-2">II. Tujuan & Indikator</h4>
                            <div v-if="viewModal.tujuanPembelajaran">
                                <div v-for="(t, i) in viewModal.tujuanPembelajaran" :key="i" class="mb-3">
                                    <p class="font-bold text-sm">{{ i+1 }}. {{ t.text }}</p>
                                    <ul class="list-disc pl-5 text-xs text-gray-600 mt-1">
                                        <li v-for="ind in t.indikators">{{ ind.text }}</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </transition>

    </div>

    <script>
        const { createApp } = Vue;

        createApp({
            data() {
                return {
                    currentUser: null,
                    storageKey: '',
                    viewMode: 'list', // 'list' or 'form'
                    step: 1,
                    savedPlans: [],
                    viewModal: null,
                    editingIndex: null, // Jika null berarti Mode Baru
                    sekolah: { logoBase64: null, logoPreview: null },
                    sidebarLogo: null,
                    
                    // LIST MAPEL LENGKAP
                    mapelList: [
                        'AGAMA ISLAM', 'BAHASA ARAB', 'BAHASA BALI', 'BAHASA INDONESIA', 'BAHASA INGGRIS', 
                        'INFORMATIKA', 'IPA', 'IPS', 'KKA', 'MATEMATIKA', 'OLAHRAGA', 'PKN', 'SENI BUDAYA'
                    ],

                    // FORM DATA
                    form: {
                        mapel: '', lingkupMateri: '', nama: '', institusi: 'SMP Albanna', fase: '', waktu: '',
                        pesertaDidik: '', materi: '', profil: [],
                        cp: '', lintasDisiplin: '', 
                        // TP ARRAY
                        tujuanPembelajaran: [ { text: '', indikators: [{ text: '' }] } ],
                        topik: '', pedagogi: '', kemitraan: '', lingkungan: '', digital: '',
                        pengalamanAwal: { prinsip: [], deskripsi: '' },
                        pengalamanIntiMemahami: { prinsip: [], deskripsi: '' },
                        pengalamanIntiMengaplikasi: { prinsip: [], deskripsi: '' },
                        pengalamanIntiMerefleksi: { prinsip: [], deskripsi: '' },
                        pengalamanPenutup: { prinsip: [], deskripsi: '' },
                        asesmenAwal: { metode: [], deskripsi: '' },
                        asesmenProses: { metode: [], deskripsi: '' },
                        asesmenAkhir: { metode: [], deskripsi: '' },
                        lampiran: [{ nama: '', keterangan: '' }]
                    },
                    // OPTIONS
                    prinsip: ['Berkesadaran', 'Bermakna', 'Menggembirakan'],
                    profilOptions: ["Keimanan dan Ketakwaan", "Kewargaan", "Penalaran Kritis", "Kreativitas", "Kolaborasi", "Kemandirian", "Kesehatan", "Komunikasi"],
                    methodsAwal: ['Tanya Jawab', 'Kuis', 'Mind Map', 'Observasi'],
                    methodsProses: ['Observasi', 'Penilaian Diri', 'Antar Teman', 'Kinerja', 'Proyek'],
                    methodsAkhir: ['Tes Tulis', 'Tes Lisan', 'Produk', 'Portofolio']
                }
            },
            mounted() {
                // CEK SESSION
                const session = sessionStorage.getItem('cbt_user_session');
                if (!session) {
                    try { window.location.href = 'index.html'; } 
                    catch(e) { 
                        this.currentUser = { username: 'tamu', name: 'Mode Tamu' }; 
                        this.storageKey = `rpp_library_tamu`;
                        this.loadFromLibrary();
                        return;
                    }
                    return;
                }
                this.currentUser = JSON.parse(session);
                this.storageKey = `rpp_library_${this.currentUser.username}`;
                
                this.loadSidebarImage();
                this.loadFromLibrary();
            },
            methods: {
                // LOAD GAMBAR KOP.PNG
                async loadSidebarImage() {
                    try {
                        const response = await fetch('kop.png');
                        const blob = await response.blob();
                        const reader = new FileReader();
                        reader.onloadend = () => { this.sidebarLogo = reader.result; };
                        reader.readAsDataURL(blob);
                    } catch (e) { console.log("kop.png not found"); }
                },

                // --- NAVIGATION & STORAGE ---
                switchView(mode) { this.viewMode = mode; if(mode === 'list') this.resetForm(); },
                
                loadFromLibrary() {
                    const data = localStorage.getItem(this.storageKey);
                    if(data) this.savedPlans = JSON.parse(data);
                },
                
                saveToLibrary(planData) {
                    // Clean copy
                    const cleanData = JSON.parse(JSON.stringify(planData));
                    if (this.editingIndex !== null) {
                        this.savedPlans[this.editingIndex] = { ...cleanData, lastUpdated: new Date().toISOString() };
                        alert("âœ… Perubahan disimpan!");
                    } else {
                        this.savedPlans.unshift({ ...cleanData, id: Date.now(), lastUpdated: new Date().toISOString() });
                        alert("âœ… Perencanaan baru berhasil dibuat!");
                    }
                    localStorage.setItem(this.storageKey, JSON.stringify(this.savedPlans));
                    this.switchView('list');
                },

                deletePlan(index) {
                    if(confirm("Hapus perencanaan ini?")) {
                        this.savedPlans.splice(index, 1);
                        localStorage.setItem(this.storageKey, JSON.stringify(this.savedPlans));
                    }
                },

                editPlan(index) {
                    this.form = JSON.parse(JSON.stringify(this.savedPlans[index])); // Deep copy
                    this.editingIndex = index;
                    this.viewMode = 'form';
                    this.step = 1;
                },

                viewPlan(index) {
                    this.viewModal = this.savedPlans[index];
                },

                createNew() {
                    this.resetForm();
                    this.editingIndex = null;
                    this.viewMode = 'form';
                    this.step = 1;
                },

                // --- MANAJEMEN TP & INDIKATOR ---
                addTP() { this.form.tujuanPembelajaran.push({ text: '', indikators: [{ text: '' }] }); },
                removeTP(i) { if(this.form.tujuanPembelajaran.length>1) this.form.tujuanPembelajaran.splice(i, 1); },
                addIndikator(ti) { this.form.tujuanPembelajaran[ti].indikators.push({ text: '' }); },
                removeIndikator(ti, ii) { if(this.form.tujuanPembelajaran[ti].indikators.length>1) this.form.tujuanPembelajaran[ti].indikators.splice(ii, 1); },

                // --- FORM LOGIC ---
                nextStep() {
                    if (this.step === 1 && (!this.form.lingkupMateri || !this.form.nama || !this.form.fase || !this.form.mapel)) return alert("Mohon lengkapi Identitas!");
                    this.step++; window.scrollTo(0,0);
                },

                saveDraft() { alert("Tersimpan sementara."); },
                saveFinal() {
                    if (!this.form.lingkupMateri) return alert("Judul Lingkup Materi belum diisi!");
                    const cleanForm = JSON.parse(JSON.stringify(this.form));
                    this.saveToLibrary(cleanForm);
                    this.generatePDF(cleanForm); 
                },

                resetForm() {
                    this.form = {
                        mapel: '', lingkupMateri: '', nama: '', institusi: 'SMP Albanna', fase: '', waktu: '',
                        pesertaDidik: '', materi: '', profil: [], cp: '', lintasDisiplin: '', 
                        tujuanPembelajaran: [{text:'', indikators:[{text:''}]}], 
                        topik: '', pedagogi: '', kemitraan: '', lingkungan: '', digital: '', 
                        pengalamanAwal: { prinsip: [], deskripsi: '' }, pengalamanIntiMemahami: { prinsip: [], deskripsi: '' }, pengalamanIntiMengaplikasi: { prinsip: [], deskripsi: '' }, pengalamanIntiMerefleksi: { prinsip: [], deskripsi: '' }, pengalamanPenutup: { prinsip: [], deskripsi: '' }, 
                        asesmenAwal: { metode: [], deskripsi: '' }, asesmenProses: { metode: [], deskripsi: '' }, asesmenAkhir: { metode: [], deskripsi: '' }, 
                        lampiran: [{ nama: '', keterangan: '' }]
                    }; this.step = 1;
                },

                addLampiran() { this.form.lampiran.push({ nama: '', keterangan: '' }); },
                removeLampiran(i) { if(this.form.lampiran.length>1) this.form.lampiran.splice(i, 1); },
                
                // --- PDF GENERATION ---
                generatePDF(data) {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();
                    const pageWidth = doc.internal.pageSize.getWidth();
                    const pageHeight = doc.internal.pageSize.getHeight();

                    // SIDEBAR KOP
                    if (this.sidebarLogo) doc.addImage(this.sidebarLogo, 'PNG', 8.9, 16.6, 29.3, 263.7);

                    const contentX = 45; // Margin Kiri

                    // JUDUL MODUL
                    doc.setFont("helvetica", "bold"); doc.setFontSize(14);
                    doc.text("MODUL AJAR / PERENCANAAN PEMBELAJARAN", (pageWidth+contentX)/2 - 10, 30, {align:'center'});
                    doc.setFontSize(12);
                    doc.text(`SMP ALBANNA - ${data.mapel}`, (pageWidth+contentX)/2 - 10, 37, {align:'center'});

                    // FORMAT TP
                    let tpString = '';
                    if (data.tujuanPembelajaran) {
                        data.tujuanPembelajaran.forEach((t, i) => {
                            tpString += `${i+1}. ${t.text}\n`;
                            t.indikators.forEach(ind => tpString += `   - ${ind.text}\n`);
                            tpString += '\n';
                        });
                    }

                    const fmtPrinsip = (t, p) => p.length ? `${t} (${p.join(', ')})` : t;

                    const rows = [
                        [{content: '1. IDENTIFIKASI', colSpan: 2, styles: {fillColor: [220, 220, 220], fontStyle: 'bold'}}],
                        ['Identitas', `Nama: ${data.nama}\nFase: ${data.fase} | Waktu: ${data.waktu}\nJudul: ${data.lingkupMateri}`],
                        ['Peserta Didik', data.pesertaDidik], ['Materi', data.materi], ['Profil Lulusan', data.profil.join(', ')],
                        
                        [{content: '2. DESAIN PEMBELAJARAN', colSpan: 2, styles: {fillColor: [220, 220, 220], fontStyle: 'bold'}}],
                        ['Capaian Pembelajaran', data.cp], ['Lintas Disiplin', data.lintasDisiplin], ['Tujuan & Indikator', tpString],
                        ['Topik', data.topik], ['Pedagogi', data.pedagogi], ['Kemitraan', data.kemitraan],
                        ['Lingkungan', data.lingkungan], ['Digital', data.digital],

                        [{content: '3. PENGALAMAN BELAJAR', colSpan: 2, styles: {fillColor: [220, 220, 220], fontStyle: 'bold'}}],
                        [fmtPrinsip('Awal', data.pengalamanAwal.prinsip), data.pengalamanAwal.deskripsi],
                        [fmtPrinsip('Inti (Paham)', data.pengalamanIntiMemahami.prinsip), data.pengalamanIntiMemahami.deskripsi],
                        [fmtPrinsip('Inti (Aplikasi)', data.pengalamanIntiMengaplikasi.prinsip), data.pengalamanIntiMengaplikasi.deskripsi],
                        [fmtPrinsip('Inti (Refleksi)', data.pengalamanIntiMerefleksi.prinsip), data.pengalamanIntiMerefleksi.deskripsi],
                        [fmtPrinsip('Penutup', data.pengalamanPenutup.prinsip), data.pengalamanPenutup.deskripsi],

                        [{content: '4. ASESMEN & LAMPIRAN', colSpan: 2, styles: {fillColor: [220, 220, 220], fontStyle: 'bold'}}],
                        ['Asesmen Awal', `${data.asesmenAwal.deskripsi}\n[${data.asesmenAwal.metode.join(', ')}]`],
                        ['Proses', `${data.asesmenProses.deskripsi}\n[${data.asesmenProses.metode.join(', ')}]`],
                        ['Akhir', `${data.asesmenAkhir.deskripsi}\n[${data.asesmenAkhir.metode.join(', ')}]`],
                        ['Lampiran', data.lampiran.map(l=>`${l.nama}: ${l.keterangan}`).join('\n')]
                    ];

                    doc.autoTable({
                        startY: 45, margin: { left: contentX },
                        head: [['Komponen', 'Deskripsi']], body: rows,
                        theme: 'grid', columnStyles: { 0: { cellWidth: 45, fontStyle: 'bold' } },
                        styles: { fontSize: 9, cellPadding: 3 },
                        didDrawPage: function (data) { if(this.sidebarLogo) doc.addImage(this.sidebarLogo, 'PNG', 8.9, 16.6, 29.3, 263.7); }
                    });

                    let finalY = doc.lastAutoTable.finalY + 20;
                    if (finalY > 250) { doc.addPage(); finalY = 20; if(this.sidebarLogo) doc.addImage(this.sidebarLogo, 'PNG', 8.9, 16.6, 29.3, 263.7); }
                    const ttdX = pageWidth - 50;
                    doc.text(`Denpasar, ${new Date().toLocaleDateString('id-ID')}`, ttdX, finalY, {align:'center'});
                    doc.text("Guru Mata Pelajaran,", ttdX, finalY+5, {align:'center'});
                    doc.setFont("helvetica", "bold");
                    doc.text(`( ${data.nama} )`, ttdX, finalY+25, {align:'center'});

                    doc.save(`RPP_${data.mapel}_${data.lingkupMateri}.pdf`);
                }
            }
        }).mount('#app');
    </script>
</body>
</html>
