<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Administrasi Ujian - SMP ALBANNA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- PDF Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- Signature Pad (Tanda Tangan Digital) -->
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Montserrat', sans-serif; }
        canvas { border: 2px dashed #cbd5e1; border-radius: 8px; cursor: crosshair; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">

    <div id="app" class="flex h-screen overflow-hidden">
        
        <!-- SIDEBAR -->
        <div class="w-64 bg-slate-900 text-white flex flex-col h-full shadow-2xl z-10">
            <div class="p-6 text-center border-b border-slate-700 bg-slate-800">
                <h1 class="font-bold text-xl tracking-wider">ADMINISTRASI</h1>
                <p class="text-xs text-slate-400 mt-1">SMP ALBANNA</p>
            </div>
            
            <nav class="flex-1 p-4 space-y-2">
                <button class="w-full text-left px-4 py-3 rounded transition flex items-center gap-3 bg-blue-600 text-white shadow-lg">
                    <i class="fas fa-file-signature w-5"></i> Berita Acara
                </button>
                <!-- Placeholder untuk menu administrasi lain kedepannya -->
                <button class="w-full text-left px-4 py-3 rounded transition flex items-center gap-3 hover:bg-slate-800 text-slate-400 cursor-not-allowed">
                    <i class="fas fa-envelope-open-text w-5"></i> Daftar Hadir (Soon)
                </button>
            </nav>

            <div class="p-4 border-t border-slate-800">
                <a href="index.html" class="w-full text-center text-xs text-gray-400 hover:text-white font-bold flex items-center justify-center gap-2 p-2 hover:bg-slate-800 rounded transition">
                    <i class="fas fa-home"></i> KEMBALI KE MENU
                </a>
            </div>
        </div>

        <!-- MAIN CONTENT -->
        <div class="flex-1 flex flex-col h-full overflow-hidden bg-gray-50">
            
            <!-- TOP BAR -->
            <div class="bg-white p-4 shadow-sm border-b flex justify-between items-center px-8">
                <h2 class="text-2xl font-bold text-slate-800 uppercase">Generator Berita Acara</h2>
                <div v-if="isLoading" class="flex items-center gap-2 text-blue-600 font-bold animate-pulse">
                    <i class="fas fa-sync fa-spin"></i> Menyimpan...
                </div>
            </div>

            <!-- FORM AREA -->
            <div class="flex-1 overflow-y-auto p-8">
                <div class="max-w-4xl mx-auto bg-white p-8 rounded-xl shadow-md border border-gray-200">
                    
                    <!-- Header Info -->
                    <div class="mb-6 border-b pb-4">
                        <h3 class="font-bold text-lg text-slate-700 mb-2">1. Waktu & Tempat Pelaksanaan</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label class="block text-xs font-bold text-gray-500 mb-1">Tanggal Ujian</label>
                                <input type="date" v-model="form.tanggal" @change="autoFillDate" class="w-full p-2 border rounded focus:border-blue-500 outline-none">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-500 mb-1">Jam Mulai</label>
                                <input type="time" v-model="form.jamMulai" class="w-full p-2 border rounded focus:border-blue-500 outline-none">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-500 mb-1">Jam Selesai</label>
                                <input type="time" v-model="form.jamSelesai" class="w-full p-2 border rounded focus:border-blue-500 outline-none">
                            </div>
                            <div class="md:col-span-2">
                                <label class="block text-xs font-bold text-gray-500 mb-1">Ruang / Kelas</label>
                                <input type="text" v-model="form.ruang" placeholder="Contoh: Ruang 01 / Kelas 7A" class="w-full p-2 border rounded focus:border-blue-500 outline-none uppercase">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-500 mb-1">Mata Pelajaran</label>
                                <select v-model="form.mapel" class="w-full p-2 border rounded focus:border-blue-500 outline-none">
                                    <option v-for="m in mapelList" :value="m">{{ m }}</option>
                                </select>
                            </div>
                        </div>
                        <!-- Preview Text Otomatis -->
                        <p class="mt-2 text-xs text-gray-400 italic bg-gray-50 p-2 rounded">
                            Preview: "Pada hari ini, <span class="font-bold">{{ displayDate.hari || '...' }}</span> tanggal <span class="font-bold">{{ displayDate.tgl || '...' }}</span> bulan <span class="font-bold">{{ displayDate.bulan || '...' }}</span> tahun <span class="font-bold">{{ displayDate.tahun || '...' }}</span>..."
                        </p>
                    </div>

                    <div class="mb-6 border-b pb-4">
                        <h3 class="font-bold text-lg text-slate-700 mb-2">2. Data Peserta</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label class="block text-xs font-bold text-gray-500 mb-1">Jumlah Seharusnya</label>
                                <input type="number" v-model="form.jmlSeharusnya" class="w-full p-2 border rounded focus:border-blue-500 outline-none">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-500 mb-1">Jumlah Hadir</label>
                                <input type="number" v-model="form.jmlHadir" class="w-full p-2 border rounded focus:border-blue-500 outline-none">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-500 mb-1">Tidak Hadir (Otomatis)</label>
                                <input :value="form.jmlSeharusnya - form.jmlHadir" readonly class="w-full p-2 border rounded bg-gray-100 text-red-600 font-bold">
                            </div>
                        </div>
                    </div>

                    <div class="mb-6 border-b pb-4">
                        <h3 class="font-bold text-lg text-slate-700 mb-2">3. Catatan & Petugas</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-xs font-bold text-gray-500 mb-1">Catatan Kejadian (Jika ada)</label>
                                <textarea v-model="form.catatan" rows="3" class="w-full p-2 border rounded focus:border-blue-500 outline-none" placeholder="Tulis 'Nihil' atau 'Lancar' jika tidak ada kejadian khusus."></textarea>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label class="block text-xs font-bold text-gray-500 mb-1">Nama Guru Mapel (Mengetahui)</label>
                                    <input v-model="form.namaGuru" class="w-full p-2 border rounded focus:border-blue-500 outline-none mb-2" placeholder="Nama Lengkap">
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-gray-500 mb-1">Nama Pengawas</label>
                                    <input v-model="form.namaPengawas" class="w-full p-2 border rounded focus:border-blue-500 outline-none mb-2" placeholder="Nama Lengkap">
                                    
                                    <label class="block text-xs font-bold text-gray-500 mb-1">Tanda Tangan Pengawas</label>
                                    <div class="relative">
                                        <canvas id="signature-pad" width="300" height="150" class="bg-white shadow-inner w-full"></canvas>
                                        <button @click="clearSignature" class="absolute top-2 right-2 text-xs bg-gray-200 hover:bg-red-200 text-gray-600 hover:text-red-600 px-2 py-1 rounded">
                                            <i class="fas fa-eraser"></i> Hapus
                                        </button>
                                    </div>
                                    <p class="text-[10px] text-gray-400 mt-1">*Tanda tangan pada kotak di atas menggunakan mouse/touchscreen.</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mb-6">
                        <label class="block text-xs font-bold text-gray-500 mb-2">Logo Sekolah (Untuk Kop Surat)</label>
                        <input type="file" accept="image/*" @change="handleLogoUpload" class="text-sm">
                        <p class="text-[10px] text-gray-400 mt-1">Upload logo SMP Albanna jika belum ada.</p>
                    </div>

                    <div class="flex gap-4 mt-8">
                        <button @click="resetForm" class="px-6 py-3 bg-gray-200 text-gray-600 rounded font-bold hover:bg-gray-300">
                            Reset
                        </button>
                        <button @click="saveAndGenerate" class="flex-1 px-6 py-3 bg-blue-900 text-white rounded font-bold shadow-lg hover:bg-blue-800 flex items-center justify-center gap-2 transform hover:scale-[1.01] transition">
                            <i class="fas fa-file-pdf"></i> SIMPAN & DOWNLOAD BERITA ACARA
                        </button>
                    </div>

                </div>
            </div>
        </div>

    </div>

    <script type="module">
        import { createApp } from 'https://unpkg.com/vue@3/dist/vue.esm-browser.js';
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // --- CONFIG FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyBivREr2y61OYTE0kLxRnkGtPCdLvHn_og",
            authDomain: "cbt-albanna.firebaseapp.com",
            projectId: "cbt-albanna",
            storageBucket: "cbt-albanna.firebasestorage.app",
            messagingSenderId: "740622197344",
            appId: "1:740622197344:web:6112adf59edfbe496ed905"
        };

        const appFirebase = initializeApp(firebaseConfig);
        const db = getFirestore(appFirebase);

        createApp({
            data() {
                return {
                    isLoading: false,
                    form: {
                        tanggal: '', jamMulai: '', jamSelesai: '', ruang: '', mapel: '',
                        jmlSeharusnya: 0, jmlHadir: 0,
                        catatan: 'Berjalan dengan tertib dan lancar.',
                        namaGuru: '', namaPengawas: ''
                    },
                    displayDate: { hari: '', tgl: '', bulan: '', tahun: '' },
                    mapelList: ['IPA', 'IPS', 'MATEMATIKA', 'BAHASA BALI', 'BAHASA ARAB', 'BAHASA INDONESIA', 'BAHASA INGGRIS', 'OLAHRAGA', 'INFORMATIKA', 'KKA', 'AGAMA ISLAM', 'SENI BUDAYA'],
                    sekolah: { logoBase64: null },
                    signaturePad: null
                }
            },
            mounted() {
                // Init Signature Pad
                const canvas = document.getElementById('signature-pad');
                this.signaturePad = new SignaturePad(canvas, { backgroundColor: 'rgba(255, 255, 255, 0)' });
                
                // Resize canvas handling
                window.addEventListener("resize", this.resizeCanvas);
                this.resizeCanvas();
            },
            methods: {
                resizeCanvas() {
                    const canvas = document.getElementById('signature-pad');
                    const ratio =  Math.max(window.devicePixelRatio || 1, 1);
                    canvas.width = canvas.offsetWidth * ratio;
                    canvas.height = canvas.offsetHeight * ratio;
                    canvas.getContext("2d").scale(ratio, ratio);
                    this.signaturePad.clear(); // Clear on resize to avoid scaling artifacts
                },
                clearSignature() {
                    this.signaturePad.clear();
                },
                handleLogoUpload(e) {
                    const f = e.target.files[0];
                    if(f) { const r = new FileReader(); r.onload = (ev) => this.sekolah.logoBase64 = ev.target.result; r.readAsDataURL(f); }
                },
                autoFillDate() {
                    if (!this.form.tanggal) return;
                    const d = new Date(this.form.tanggal);
                    const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
                    const dateStr = d.toLocaleDateString('id-ID', options); // "Senin, 1 Januari 2024"
                    
                    // Pecah string tanggal
                    const parts = dateStr.split(' '); // ["Senin,", "1", "Januari", "2024"]
                    this.displayDate.hari = parts[0].replace(',', '');
                    this.displayDate.tgl = parts[1];
                    this.displayDate.bulan = parts[2];
                    this.displayDate.tahun = parts[3];
                },
                resetForm() {
                    if(confirm("Reset formulir?")) {
                        this.form = { tanggal: '', jamMulai: '', jamSelesai: '', ruang: '', mapel: '', jmlSeharusnya: 0, jmlHadir: 0, catatan: 'Berjalan dengan tertib dan lancar.', namaGuru: '', namaPengawas: '' };
                        this.signaturePad.clear();
                    }
                },
                async saveAndGenerate() {
                    if(!this.form.tanggal || !this.form.namaPengawas || !this.form.ruang) return alert("Mohon lengkapi data utama (Tanggal, Ruang, Pengawas)!");

                    this.isLoading = true;
                    try {
                        const signatureData = this.signaturePad.isEmpty() ? null : this.signaturePad.toDataURL();

                        // 1. Simpan ke Firebase
                        await addDoc(collection(db, "berita_acara"), {
                            ...this.form,
                            jmlTidakHadir: this.form.jmlSeharusnya - this.form.jmlHadir,
                            signature: signatureData, // Simpan TTD (Base64)
                            createdAt: new Date().toISOString()
                        });

                        // 2. Generate PDF
                        this.generatePDF(signatureData);

                        alert("âœ… Berita Acara berhasil disimpan dan diunduh!");

                    } catch(e) {
                        alert("Gagal: " + e.message);
                    } finally {
                        this.isLoading = false;
                    }
                },
                generatePDF(signatureData) {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();
                    const pageWidth = doc.internal.pageSize.getWidth();

                    // --- KOP SURAT ---
                    if (this.sekolah.logoBase64) doc.addImage(this.sekolah.logoBase64, 'PNG', 15, 10, 25, 25);
                    doc.setFont("times", "bold"); doc.setFontSize(14); doc.text("BERITA ACARA", pageWidth/2, 15, {align:'center'});
                    doc.setFontSize(12); doc.text("PELAKSANAAN ASESMEN SUMATIF AKHIR SEMESTER (ASAS)", pageWidth/2, 22, {align:'center'});
                    doc.text("SMP ALBANNA DENPASAR", pageWidth/2, 29, {align:'center'});
                    doc.setLineWidth(0.5); doc.line(15, 35, pageWidth-15, 35);

                    // --- ISI ---
                    doc.setFont("times", "normal"); doc.setFontSize(11);
                    let y = 45;
                    const lh = 7; // Line height

                    // Paragraf 1
                    const text1 = `Pada hari ini, ${this.displayDate.hari} tanggal ${this.displayDate.tgl} bulan ${this.displayDate.bulan} tahun ${this.displayDate.tahun}.`;
                    doc.text(text1, 15, y); y += lh;

                    // Poin A
                    doc.text(`a. Telah diselenggarakan ASAS untuk Mata Pelajaran ${this.form.mapel}`, 15, y); y += lh;
                    doc.text(`   dari pukul ${this.form.jamMulai} sampai dengan pukul ${this.form.jamSelesai}.`, 15, y); y += lh*1.5;

                    // Detail Sekolah
                    const leftCol = 20; const rightCol = 80;
                    doc.text("Pada Sekolah", leftCol, y); doc.text(": SMP ALBANNA", rightCol, y); y+=lh;
                    doc.text("Ruang / Kelas", leftCol, y); doc.text(`: ${this.form.ruang}`, rightCol, y); y+=lh;
                    doc.text("Jumlah Peserta Seharusnya", leftCol, y); doc.text(`: ${this.form.jmlSeharusnya} Orang`, rightCol, y); y+=lh;
                    const tdkHadir = this.form.jmlSeharusnya - this.form.jmlHadir;
                    doc.text("Jumlah Peserta yang Tidak Hadir", leftCol, y); doc.text(`: ${tdkHadir} Orang`, rightCol, y); y+=lh;
                    doc.text("Jumlah Peserta yang Hadir", leftCol, y); doc.text(`: ${this.form.jmlHadir} Orang`, rightCol, y); y+=lh*1.5;

                    // Poin B (Diubah sedikit agar flow lebih enak dibaca di PDF generik)
                    const textB = "b. Pelaksanaan ujian berlangsung dengan metode Online/Offline menggunakan perangkat sekolah/pribadi.";
                    doc.text(textB, 15, y); y += lh*1.5;

                    // Poin C (Catatan)
                    doc.text("c. Catatan selama pelaksanaan ujian:", 15, y); y += lh;
                    // Kotak Catatan
                    doc.setDrawColor(0);
                    doc.rect(15, y, pageWidth-30, 20); 
                    doc.text(this.form.catatan || "-", 18, y+5, {maxWidth: pageWidth-36});
                    y += 25;

                    doc.text("Berita Acara ini dibuat dengan sesungguhnya.", 15, y); y += lh*2;

                    // --- TANDA TANGAN ---
                    const ttdY = y;
                    
                    // Kiri: Guru Mapel
                    doc.text("Mengetahui,", 40, ttdY, {align:'center'});
                    doc.text("Guru Mata Pelajaran,", 40, ttdY+5, {align:'center'});
                    doc.text(`( ${this.form.namaGuru} )`, 40, ttdY+30, {align:'center'});

                    // Kanan: Pengawas
                    doc.text("Pengawas,", pageWidth-40, ttdY, {align:'center'});
                    // Insert Signature Image if exists
                    if(signatureData) {
                        doc.addImage(signatureData, 'PNG', pageWidth-60, ttdY+5, 40, 20);
                    }
                    doc.text(`( ${this.form.namaPengawas} )`, pageWidth-40, ttdY+30, {align:'center'});

                    doc.save(`BA_${this.form.mapel}_${this.form.ruang}.pdf`);
                }
            }
        }).mount('#app');
    </script>
</body>
</html>
