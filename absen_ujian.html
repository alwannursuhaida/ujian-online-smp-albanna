<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>Absensi & Arsip Ujian - SMP ALBANNA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
    <style>body { font-family: 'Montserrat', sans-serif; }</style>
</head>
<body class="bg-gray-100 min-h-screen">

    <div id="app" class="flex h-screen overflow-hidden">
        
        <div class="w-64 bg-slate-900 text-white flex flex-col h-full shadow-2xl z-10">
            <div class="p-6 text-center border-b border-slate-700 bg-slate-800">
                <h1 class="font-bold text-xl tracking-wider">ABSENSI CBT</h1>
                <p class="text-xs text-slate-400 mt-1">SMP ALBANNA</p>
            </div>
            
            <nav class="flex-1 p-4 space-y-2">
                <button @click="activeTab = 'dashboard'" :class="['w-full text-left px-4 py-3 rounded transition flex items-center gap-3', activeTab === 'dashboard' ? 'bg-blue-600 text-white shadow-lg' : 'hover:bg-slate-800 text-slate-300']">
                    <i class="fas fa-chart-pie w-5"></i> Dashboard
                </button>
                <button @click="activeTab = 'data_siswa'" :class="['w-full text-left px-4 py-3 rounded transition flex items-center gap-3', activeTab === 'data_siswa' ? 'bg-blue-600 text-white shadow-lg' : 'hover:bg-slate-800 text-slate-300']">
                    <i class="fas fa-users w-5"></i> Data Siswa
                </button>
                <button @click="activeTab = 'input_absen'" :class="['w-full text-left px-4 py-3 rounded transition flex items-center gap-3', activeTab === 'input_absen' ? 'bg-blue-600 text-white shadow-lg' : 'hover:bg-slate-800 text-slate-300']">
                    <i class="fas fa-user-check w-5"></i> Input Absensi
                </button>
                <button @click="activeTab = 'arsip'" :class="['w-full text-left px-4 py-3 rounded transition flex items-center gap-3', activeTab === 'arsip' ? 'bg-blue-600 text-white shadow-lg' : 'hover:bg-slate-800 text-slate-300']">
                    <i class="fas fa-archive w-5"></i> Arsip Absensi
                </button>
                <button @click="activeTab = 'susulan'" :class="['w-full text-left px-4 py-3 rounded transition flex items-center gap-3', activeTab === 'susulan' ? 'bg-blue-600 text-white shadow-lg' : 'hover:bg-slate-800 text-slate-300']">
                    <i class="fas fa-file-pdf w-5"></i> Laporan & Susulan
                </button>
            </nav>
            <div class="p-4 border-t border-slate-800"><a href="index.html" class="w-full text-center text-xs text-gray-400 hover:text-white font-bold flex items-center justify-center gap-2 p-2 hover:bg-slate-800 rounded transition"><i class="fas fa-home"></i> KEMBALI KE MENU</a></div>
        </div>

        <div class="flex-1 flex flex-col h-full overflow-hidden bg-gray-50">
            <div class="bg-white p-4 shadow-sm border-b flex justify-between items-center px-8">
                <h2 class="text-2xl font-bold text-slate-800 uppercase">{{ pageTitle }}</h2>
                <div v-if="isLoading" class="flex items-center gap-2 text-blue-600 font-bold animate-pulse"><i class="fas fa-sync fa-spin"></i> Sinkronisasi Data...</div>
            </div>

            <div class="flex-1 overflow-y-auto p-8">

                <div v-show="activeTab === 'dashboard'">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                        <div class="bg-white p-6 rounded-xl shadow-sm border flex flex-col items-center"><h3 class="font-bold text-gray-700 mb-4">Statistik Kehadiran (Live)</h3><div class="h-64 w-full relative"><canvas id="attendanceChart"></canvas></div></div>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="bg-green-100 p-6 rounded-xl border border-green-200 text-center flex flex-col justify-center"><div class="text-4xl font-bold text-green-700">{{ stats.hadir }}</div><div class="text-sm text-green-800 font-bold uppercase mt-2">Siswa Hadir</div></div>
                            <div class="bg-red-100 p-6 rounded-xl border border-red-200 text-center flex flex-col justify-center"><div class="text-4xl font-bold text-red-700">{{ stats.absen }}</div><div class="text-sm text-red-800 font-bold uppercase mt-2">Tidak Hadir</div></div>
                            <div class="bg-blue-100 p-6 rounded-xl border border-blue-200 text-center flex flex-col justify-center col-span-2"><div class="text-4xl font-bold text-blue-700">{{ stats.total }}</div><div class="text-sm text-blue-800 font-bold uppercase mt-2">Total Siswa</div></div>
                        </div>
                    </div>
                </div>

                <div v-show="activeTab === 'data_siswa'">
                    <div class="bg-white p-6 rounded-xl shadow-sm border mb-6 flex justify-between items-center">
                        <div class="w-1/3"><label class="block text-sm font-bold text-gray-700 mb-2">Pilih Kelas Aktif</label><select v-model="selectedClass" class="w-full p-2 border rounded bg-gray-50 font-bold text-blue-900"><option v-for="c in kelasList" :value="c">{{ c }}</option></select></div>
                        <div class="flex gap-2">
                            <button @click="downloadTemplate" class="bg-green-600 text-white px-4 py-2 rounded shadow hover:bg-green-700 text-sm font-bold"><i class="fas fa-file-excel"></i> Template</button>
                            <label class="bg-blue-600 text-white px-4 py-2 rounded shadow hover:bg-blue-700 text-sm font-bold cursor-pointer"><i class="fas fa-upload"></i> Upload<input type="file" class="hidden" accept=".xlsx, .xls" @change="handleFileUpload"></label>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="bg-white rounded-xl shadow overflow-hidden border h-fit">
                            <div class="bg-slate-800 text-white p-3 flex justify-between items-center"><h3 class="font-bold text-sm">TERDAFTAR DI KELAS {{ selectedClass }}</h3><span class="bg-slate-600 text-xs px-2 py-1 rounded">{{ filteredStudents.length }} Siswa</span></div>
                            <div class="max-h-[600px] overflow-y-auto"><table class="w-full text-left text-sm"><tbody class="divide-y divide-gray-100"><tr v-for="(s, idx) in filteredStudents" :key="s.id" class="hover:bg-slate-50"><td class="p-3 w-8 text-center text-gray-400">{{ idx + 1 }}</td><td class="p-3 font-bold text-slate-700">{{ s.nama }}</td><td class="p-3 text-right w-12"><button @click="deleteStudent(s.id)" class="text-red-400 hover:text-red-600"><i class="fas fa-trash"></i></button></td></tr></tbody></table></div>
                        </div>
                        <div class="bg-white rounded-xl shadow overflow-hidden border h-fit">
                            <div class="bg-blue-900 text-white p-3"><h3 class="font-bold text-sm">INPUT MANUAL / COPY-PASTE</h3></div>
                            <div class="p-4 max-h-[500px] overflow-y-auto"><div v-for="(row, idx) in bulkInput" :key="idx" class="flex gap-2 mb-2 items-center"><span class="text-xs text-gray-400 w-6 text-right">{{ idx + 1 }}.</span><input v-model="bulkInput[idx]" @paste="handlePaste($event, idx)" class="w-full p-2 border rounded text-sm uppercase"><button v-if="bulkInput[idx]" @click="bulkInput[idx] = ''" class="text-gray-300 hover:text-red-500"><i class="fas fa-times"></i></button></div></div>
                            <div class="p-4 border-t bg-gray-50 flex justify-end gap-2"><button @click="clearBulk" class="text-gray-500 font-bold px-4">Reset</button><button @click="saveBulkStudents" class="bg-blue-600 text-white px-6 py-2 rounded font-bold shadow">SIMPAN SEMUA</button></div>
                        </div>
                    </div>
                </div>

                <div v-show="activeTab === 'input_absen'">
                    <div class="flex flex-col md:flex-row justify-between items-end mb-6 gap-4">
                        <div class="flex gap-4 w-full">
                            <div class="w-1/2"><label class="block text-sm font-bold text-gray-700 mb-1">Pilih Kelas</label><select v-model="selectedClass" class="w-full p-2 border rounded bg-white shadow-sm"><option v-for="c in kelasList" :value="c">{{ c }}</option></select></div>
                            <div class="w-1/2"><label class="block text-sm font-bold text-gray-700 mb-1">Tanggal Ujian</label><input type="date" v-model="attendanceDate" class="w-full p-2 border rounded bg-white shadow-sm"></div>
                        </div>
                        <button @click="saveAttendance" class="bg-green-600 text-white px-6 py-2.5 rounded shadow-lg font-bold hover:bg-green-700 whitespace-nowrap"><i class="fas fa-save mr-2"></i> SIMPAN KE ARSIP</button>
                    </div>
                    <div class="bg-white rounded-xl shadow overflow-hidden border">
                        <table class="w-full text-left"><thead class="bg-blue-100 text-blue-900 uppercase text-xs font-bold"><tr><th class="p-4 w-10">No</th><th class="p-4">Nama Siswa</th><th class="p-4 text-center w-20 bg-green-200">Hadir</th><th class="p-4 text-center w-20 bg-yellow-200">Sakit</th><th class="p-4 text-center w-20 bg-blue-200">Izin</th><th class="p-4 text-center w-20 bg-red-200">Alpha</th></tr></thead><tbody class="divide-y divide-gray-100"><tr v-for="(s, idx) in filteredStudents" :key="s.id" class="hover:bg-blue-50 transition"><td class="p-4 text-center font-mono text-gray-500">{{ idx + 1 }}</td><td class="p-4 font-bold text-gray-800">{{ s.nama }}</td><td class="p-4 text-center bg-green-50 cursor-pointer" @click="s.status = 'H'"><input type="radio" :name="'absen_'+s.id" value="H" v-model="s.status" class="w-5 h-5 accent-green-600 cursor-pointer"></td><td class="p-4 text-center bg-yellow-50 cursor-pointer" @click="s.status = 'S'"><input type="radio" :name="'absen_'+s.id" value="S" v-model="s.status" class="w-5 h-5 accent-yellow-600 cursor-pointer"></td><td class="p-4 text-center bg-blue-50 cursor-pointer" @click="s.status = 'I'"><input type="radio" :name="'absen_'+s.id" value="I" v-model="s.status" class="w-5 h-5 accent-blue-600 cursor-pointer"></td><td class="p-4 text-center bg-red-50 cursor-pointer" @click="s.status = 'A'"><input type="radio" :name="'absen_'+s.id" value="A" v-model="s.status" class="w-5 h-5 accent-red-600 cursor-pointer"></td></tr></tbody></table>
                    </div>
                </div>

                <div v-show="activeTab === 'arsip'">
                    <div class="bg-white p-6 rounded-xl shadow-sm border mb-6 flex flex-col md:flex-row justify-between items-center gap-4">
                        <div><h2 class="text-xl font-bold text-slate-800">Arsip Absensi</h2><p class="text-sm text-gray-500">Riwayat absensi tersimpan.</p></div>
                        <div class="flex gap-2 w-full md:w-auto"><select v-model="filterArchiveClass" class="p-2 border rounded text-sm w-full md:w-32"><option value="">Semua Kelas</option><option v-for="c in kelasList" :value="c">{{ c }}</option></select><input type="date" v-model="filterArchiveDate" class="p-2 border rounded text-sm w-full md:w-auto"></div>
                    </div>
                    <div v-if="filteredArchives.length === 0" class="text-center text-gray-400 py-10"><i class="fas fa-box-open fa-3x mb-4"></i><p>Tidak ada arsip ditemukan.</p></div>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <div v-for="arc in filteredArchives" :key="arc.id" class="bg-white p-4 rounded-lg shadow border hover:shadow-md transition relative group">
                            <div class="flex justify-between items-start mb-3"><span class="bg-indigo-100 text-indigo-800 text-xs font-bold px-2 py-1 rounded">Kelas {{ arc.kelas }}</span><span class="text-xs text-gray-500 font-bold">{{ formatDate(arc.tanggal) }}</span></div>
                            <div class="flex justify-between items-center text-sm mb-4"><span class="text-green-600 font-bold">Hadir: {{ countStatus(arc.records, 'H') }}</span><span class="text-red-500 font-bold">Absen: {{ arc.records.length - countStatus(arc.records, 'H') }}</span></div>
                            <div class="flex gap-2 pt-3 border-t"><button @click="viewArchive(arc)" class="flex-1 bg-blue-50 text-blue-600 text-xs font-bold py-2 rounded hover:bg-blue-100"><i class="fas fa-eye"></i> Lihat/Edit</button><button @click="downloadArchivePDF(arc)" class="bg-green-50 text-green-600 px-3 py-2 rounded text-xs font-bold hover:bg-green-100"><i class="fas fa-file-pdf"></i></button><button @click="deleteArchive(arc.id)" class="bg-red-50 text-red-600 px-3 py-2 rounded text-xs font-bold hover:bg-red-100"><i class="fas fa-trash"></i></button></div>
                        </div>
                    </div>
                </div>

                <div v-show="activeTab === 'susulan'">
                    <div class="bg-white p-6 rounded-xl shadow-sm border mb-6">
                        <h3 class="font-bold text-gray-800 mb-4 border-b pb-2">Filter Laporan</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Tanggal Data</label>
                                <input type="date" v-model="filterReportDate" class="w-full p-2 border-2 border-blue-100 rounded text-sm font-bold text-blue-900">
                            </div>
                            
                            <div>
                                <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Filter Kelas</label>
                                <select v-model="filterReportClass" class="w-full p-2 border-2 border-blue-100 rounded text-sm font-bold text-blue-900">
                                    <option value="SEMUA">Semua Kelas</option>
                                    <option v-for="c in kelasList" :value="c">{{ c }}</option>
                                </select>
                            </div>

                            <div class="flex items-end gap-2">
                                <div class="border-2 border-dashed border-gray-300 p-1 rounded cursor-pointer hover:bg-gray-50 w-10 h-10 flex items-center justify-center relative" title="Upload Logo">
                                    <input type="file" accept="image/*" @change="handleLogoUpload" class="absolute inset-0 opacity-0 cursor-pointer z-10">
                                    <img v-if="sekolah.logoPreview" :src="sekolah.logoPreview" class="max-h-full object-contain">
                                    <i v-else class="fas fa-image text-gray-400"></i>
                                </div>
                                <button @click="downloadPDFReport" class="flex-1 bg-red-600 text-white px-4 py-2.5 rounded font-bold shadow hover:bg-red-700 flex items-center justify-center gap-2 text-sm">
                                    <i class="fas fa-file-pdf"></i> UNDUH LAPORAN
                                </button>
                            </div>
                        </div>
                        
                        <div class="mt-4 text-xs text-gray-500 italic bg-blue-50 p-2 rounded">
                            <i class="fas fa-info-circle mr-1"></i> 
                            Menampilkan data siswa (S/I/A) dari <strong>Arsip</strong> tanggal {{ formatDate(filterReportDate) }}. 
                            Jika arsip tidak ada, mengambil data <strong>Live</strong> (jika tanggal = hari ini).
                        </div>
                    </div>

                    <div class="bg-red-50 border-l-4 border-red-500 p-4 mb-6 flex justify-between items-center">
                        <div><h3 class="font-bold text-red-800">Daftar Siswa Perlu Ujian Susulan</h3><p class="text-sm text-red-600">Sesuai filter tanggal & kelas.</p></div>
                        <div class="text-xl font-bold text-red-800 bg-red-200 px-4 py-1 rounded-full">{{ susulanList.length }} Siswa</div>
                    </div>

                    <div class="bg-white rounded-xl shadow overflow-hidden border">
                        <table class="w-full text-left">
                            <thead class="bg-slate-800 text-white"><tr><th class="p-4">Nama Siswa</th><th class="p-4">Kelas</th><th class="p-4 text-center">Status</th><th class="p-4">Keterangan Susulan</th><th class="p-4 text-center">Aksi</th></tr></thead>
                            <tbody class="divide-y divide-gray-100">
                                <tr v-for="s in susulanList" :key="s.uniqueKey" class="hover:bg-red-50">
                                    <td class="p-4 font-bold">{{ s.nama }}</td>
                                    <td class="p-4"><span class="bg-gray-200 px-2 py-1 rounded text-xs font-bold">{{ s.kelas }}</span></td>
                                    <td class="p-4 text-center"><span :class="{'bg-yellow-100 text-yellow-800': s.status==='S', 'bg-blue-100 text-blue-800': s.status==='I', 'bg-red-100 text-red-800': s.status==='A'}" class="px-3 py-1 rounded font-bold">{{ s.status }}</span></td>
                                    <td class="p-4"><input v-model="s.ket_susulan" class="w-full border-b-2 border-gray-300 focus:border-blue-600 outline-none bg-transparent py-1" placeholder="Jadwal Susulan..."></td>
                                    <td class="p-4 text-center"><button @click="removeSusulan(s)" class="text-red-500 hover:text-red-700 p-2 rounded hover:bg-red-100" title="Ubah jadi Hadir (Hapus dari list)"><i class="fas fa-trash-alt"></i></button></td>
                                </tr>
                                <tr v-if="susulanList.length === 0"><td colspan="5" class="p-8 text-center text-green-600 font-bold">Tidak ada siswa susulan untuk filter ini.</td></tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="mt-6 flex justify-end"><button @click="saveAllSusulan" :disabled="susulanList.length===0" class="bg-blue-600 text-white px-8 py-3 rounded-lg font-bold shadow-lg hover:bg-blue-700 transition disabled:bg-gray-400"><i class="fas fa-save mr-2"></i> SIMPAN PERUBAHAN</button></div>
                </div>

            </div>
        </div>

        <div v-if="viewArchiveModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
            <div class="bg-white w-full max-w-3xl h-[80vh] rounded-xl shadow-2xl flex flex-col overflow-hidden">
                <div class="p-4 border-b flex justify-between items-center bg-slate-50"><div><h3 class="font-bold text-lg">Edit Arsip: {{ viewArchiveModal.kelas }}</h3><p class="text-xs text-gray-500">{{ formatDate(viewArchiveModal.tanggal) }}</p></div><button @click="viewArchiveModal = null" class="text-gray-400 hover:text-red-500"><i class="fas fa-times fa-lg"></i></button></div>
                <div class="flex-1 overflow-y-auto p-6"><table class="w-full text-sm text-left border"><thead class="bg-gray-100"><tr><th class="p-2 border">Nama</th><th class="p-2 border text-center">Status</th><th class="p-2 border">Keterangan</th></tr></thead><tbody><tr v-for="(rec, idx) in viewArchiveModal.records" :key="idx"><td class="p-2 border font-bold">{{ rec.nama }}</td><td class="p-2 border text-center"><select v-model="rec.status" class="p-1 border rounded text-xs font-bold" :class="{'text-green-600': rec.status==='H', 'text-red-600': rec.status==='A'}"><option value="H">Hadir</option><option value="S">Sakit</option><option value="I">Izin</option><option value="A">Alpha</option></select></td><td class="p-2 border"><input v-model="rec.ket_susulan" class="w-full p-1 border-b outline-none text-xs" placeholder="-"></td></tr></tbody></table></div>
                <div class="p-4 border-t text-right"><button @click="updateArchiveData" class="bg-green-600 text-white px-6 py-2 rounded font-bold hover:bg-green-700">Simpan Perubahan</button></div>
            </div>
        </div>

    </div>

    <script type="module">
        import { createApp } from 'https://unpkg.com/vue@3/dist/vue.esm-browser.js';
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, doc, updateDoc, deleteDoc, onSnapshot, query, orderBy, where, writeBatch, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBivREr2y61OYTE0kLxRnkGtPCdLvHn_og",
            authDomain: "cbt-albanna.firebaseapp.com",
            projectId: "cbt-albanna",
            storageBucket: "cbt-albanna.firebasestorage.app",
            messagingSenderId: "740622197344",
            appId: "1:740622197344:web:6112adf59edfbe496ed905"
        };

        const appFirebase = initializeApp(firebaseConfig);
        const db = getFirestore(appFirebase);

        createApp({
            data() {
                return {
                    activeTab: 'dashboard', isLoading: true, selectedClass: '7A', attendanceDate: new Date().toISOString().split('T')[0],
                    newStudentName: '', allStudents: [], archives: [],
                    
                    // Filter Laporan Baru
                    filterReportDate: new Date().toISOString().split('T')[0],
                    filterReportClass: 'SEMUA',
                    
                    filterArchiveClass: '', filterArchiveDate: '', viewArchiveModal: null, chartInstance: null,
                    stats: { hadir: 0, absen: 0, total: 0 }, sekolah: { logoBase64: null, logoPreview: null }, bulkInput: new Array(30).fill('')
                }
            },
            computed: {
                kelasList() { return ['7A','7B','7C','7D','7E','7F','8A','8B','8C','8D','8E','8F','9A','9B','9C','9D','9E']; },
                filteredStudents() { return this.allStudents.filter(s => s.kelas === this.selectedClass).sort((a,b) => a.nama.localeCompare(b.nama)); },
                filteredArchives() { return this.archives.filter(arc => (this.filterArchiveClass ? arc.kelas === this.filterArchiveClass : true) && (this.filterArchiveDate ? arc.tanggal === this.filterArchiveDate : true)); },
                
                // --- LOGIKA SUSULAN BARU (GABUNGAN ARSIP) ---
                susulanList() {
                    let list = [];
                    
                    // 1. Cari Arsip sesuai tanggal filter
                    const matchingArchives = this.archives.filter(a => a.tanggal === this.filterReportDate);

                    if (matchingArchives.length > 0) {
                        // Jika ada arsip, gabungkan data dari semua kelas di arsip tersebut
                        matchingArchives.forEach(arc => {
                            if (this.filterReportClass === 'SEMUA' || arc.kelas === this.filterReportClass) {
                                const filtered = arc.records.filter(r => ['S','I','A'].includes(r.status)).map(r => ({
                                    ...r,
                                    kelas: arc.kelas,
                                    archiveId: arc.id, // Penting untuk update balik
                                    uniqueKey: arc.id + '_' + r.nama // Key unik untuk v-for
                                }));
                                list = list.concat(filtered);
                            }
                        });
                    } else {
                        // Jika tidak ada arsip, cek apakah tanggal == hari ini
                        const today = new Date().toISOString().split('T')[0];
                        if (this.filterReportDate === today) {
                            // Ambil dari Data Live
                            let liveData = this.allStudents.filter(s => ['S','I','A'].includes(s.status));
                            if (this.filterReportClass !== 'SEMUA') {
                                liveData = liveData.filter(s => s.kelas === this.filterReportClass);
                            }
                            list = liveData.map(s => ({ ...s, uniqueKey: s.id, isLive: true }));
                        }
                    }
                    
                    return list.sort((a,b) => (a.kelas === b.kelas) ? a.nama.localeCompare(b.nama) : a.kelas.localeCompare(b.kelas));
                },
                pageTitle() {
                    const titles = { 'dashboard': 'Dashboard Statistik', 'data_siswa': 'Manajemen Data Siswa', 'input_absen': 'Input Absensi Harian', 'susulan': 'Laporan & Jadwal Susulan', 'arsip': 'Arsip Absensi' };
                    return titles[this.activeTab];
                }
            },
            watch: {
                activeTab(val) { if(val === 'dashboard') setTimeout(this.renderChart, 100); },
                allStudents: { handler() { this.updateStats(); }, deep: true }
            },
            mounted() {
                const q = query(collection(db, "data_absensi"));
                // --- BAGIAN INI SUDAH DIPERBAIKI ---
                onSnapshot(q, (snap) => { 
                    this.allStudents = snap.docs.map(d => {
                        const data = d.data();
                        return { 
                            id: d.id, 
                            ...data 
                        };
                    });
                    
                    console.log("Data Siswa Berhasil Ditarik:", this.allStudents); // Cek Console sekarang!
                    
                    this.isLoading = false; 
                    this.updateStats(); 
                    if(this.activeTab==='dashboard') this.renderChart(); 
                }, (error) => {
                    console.error("Gagal mengambil data:", error);
                    this.isLoading = false;
                });
                // ------------------------------------

                const qArsip = query(collection(db, "history_absensi"), orderBy("timestamp", "desc"));
                onSnapshot(qArsip, (snap) => { this.archives = snap.docs.map(d => ({ id: d.id, ...d.data() })); });
            },
            methods: {
                async saveAttendance() {
                    this.isLoading = true; const batch = writeBatch(db); const currentSnapshot = [];
                    this.filteredStudents.forEach(s => {
                        const ref = doc(db, "data_absensi", s.id); batch.update(ref, { status: s.status });
                        currentSnapshot.push({ id: s.id, nama: s.nama, status: s.status, ket_susulan: s.ket_susulan || '' });
                    });
                    try {
                        await batch.commit();
                        const existingArchive = this.archives.find(a => a.kelas === this.selectedClass && a.tanggal === this.attendanceDate);
                        if (existingArchive) {
                            await updateDoc(doc(db, "history_absensi", existingArchive.id), { records: currentSnapshot, timestamp: new Date().toISOString() });
                            alert(`Arsip ${this.attendanceDate} diperbarui!`);
                        } else {
                            await addDoc(collection(db, "history_absensi"), { kelas: this.selectedClass, tanggal: this.attendanceDate, records: currentSnapshot, timestamp: new Date().toISOString() });
                            alert("Arsip Baru Disimpan!");
                        }
                    } catch(e) { alert("Gagal: " + e.message); } finally { this.isLoading = false; }
                },
                
                // --- UPDATE SUSULAN (Flexible: Live or Archive) ---
                async saveAllSusulan() {
                    if(this.susulanList.length === 0) return;
                    this.isLoading = true;
                    try {
                        // Group by Archive ID untuk batch update arsip
                        const updates = {}; // { archiveId: [records] }
                        const liveBatch = writeBatch(db);
                        let liveUpdatesCount = 0;

                        this.susulanList.forEach(item => {
                            if (item.isLive) {
                                // Update Data Live
                                const ref = doc(db, "data_absensi", item.id);
                                liveBatch.update(ref, { ket_susulan: item.ket_susulan });
                                liveUpdatesCount++;
                            } else if (item.archiveId) {
                                // Siapkan update arsip
                                if (!updates[item.archiveId]) {
                                    // Clone records dari arsip asli
                                    const arc = this.archives.find(a => a.id === item.archiveId);
                                    if(arc) updates[item.archiveId] = [...arc.records];
                                }
                                // Update record spesifik di dalam array
                                const recIndex = updates[item.archiveId].findIndex(r => r.nama === item.nama);
                                if (recIndex !== -1) {
                                    updates[item.archiveId][recIndex].ket_susulan = item.ket_susulan;
                                }
                            }
                        });

                        // Execute Live Updates
                        if (liveUpdatesCount > 0) await liveBatch.commit();

                        // Execute Archive Updates
                        for (const [arcId, newRecords] of Object.entries(updates)) {
                            await updateDoc(doc(db, "history_absensi", arcId), { records: newRecords });
                        }

                        alert("Perubahan Tersimpan!");
                    } catch(e) { alert("Gagal: " + e.message); } finally { this.isLoading = false; }
                },

                async updateSusulan(student) { /* Wrapper for single save if needed, but Save All is preferred */ this.saveAllSusulan(); },

                async removeSusulan(student) {
                    if(!confirm(`Ubah status ${student.nama} menjadi HADIR?`)) return;
                    
                    if (student.isLive) {
                        await updateDoc(doc(db, "data_absensi", student.id), { status: 'H', ket_susulan: '' });
                    } else if (student.archiveId) {
                        const arc = this.archives.find(a => a.id === student.archiveId);
                        if (arc) {
                            const newRecords = arc.records.map(r => r.nama === student.nama ? { ...r, status: 'H', ket_susulan: '' } : r);
                            await updateDoc(doc(db, "history_absensi", student.archiveId), { records: newRecords });
                        }
                    }
                },

                // --- PDF ---
                downloadPDFReport() {
                    if(this.susulanList.length === 0) return alert("Tidak ada data.");
                    const { jsPDF } = window.jspdf; const doc = new jsPDF();
                    
                    if (this.sekolah.logoBase64) doc.addImage(this.sekolah.logoBase64, 'PNG', 15, 10, 20, 20); 
                    doc.setFont("helvetica", "bold"); doc.setFontSize(16); doc.text("SMP ALBANNA", 40, 18);
                    doc.setFontSize(10); doc.setFont("helvetica", "normal"); doc.text(`Laporan Ketidakhadiran & Ujian Susulan (${this.formatDate(this.filterReportDate)})`, 40, 24);
                    doc.setLineWidth(0.5); doc.line(10, 35, 200, 35);

                    doc.autoTable({
                        startY: 40,
                        head: [['No', 'Nama', 'Kelas', 'Status', 'Keterangan']],
                        body: this.susulanList.map((s,i)=>[i+1, s.nama, s.kelas, s.status, s.ket_susulan])
                    });

                    // TANDA TANGAN (Kiri Kepsek, Kanan Panitia)
                    let finalY = doc.lastAutoTable.finalY + 20;
                    if (finalY > 250) { doc.addPage(); finalY = 20; }

                    doc.text("Mengetahui,", 40, finalY, {align:'center'});
                    doc.text("Kepala SMP Albanna", 40, finalY+5, {align:'center'});
                    doc.setFont("helvetica", "bold");
                    doc.text("Sariwati, S.Pt, M.Pd.", 40, finalY+30, {align:'center'});
                    
                    doc.setFont("helvetica", "normal");
                    doc.text("Ketua Panitia Ujian,", 170, finalY+5, {align:'center'});
                    doc.text("(..............................)", 170, finalY+30, {align:'center'});

                    doc.save(`Laporan_Susulan_${this.filterReportDate}.pdf`);
                },

                // Basic CRUD & Helper (Same as before)
                async addStudent() { if(!this.newStudentName.trim()) return alert("Kosong!"); try { await addDoc(collection(db, "data_absensi"), { nama: this.newStudentName.toUpperCase(), kelas: this.selectedClass, status: 'H', ket_susulan: '' }); this.newStudentName = ''; } catch(e){alert(e.message);} },
                async deleteStudent(id) { if(confirm("Hapus?")) await deleteDoc(doc(db, "data_absensi", id)); },
                handlePaste(e, idx) { e.preventDefault(); const txt = (e.clipboardData||window.clipboardData).getData('text'); const rows=txt.split(/\r?\n/).filter(r=>r.trim()!==''); rows.forEach((n,i)=>{ if(idx+i<this.bulkInput.length) this.bulkInput[idx+i]=n.trim().toUpperCase(); }); },
                downloadTemplate() { const ws=XLSX.utils.aoa_to_sheet([["Nama Siswa"]]); const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,"T"); XLSX.writeFile(wb,"Template.xlsx"); },
                handleFileUpload(ev) { const f=ev.target.files[0]; if(!f) return; const r=new FileReader(); r.onload=e=>{ const d=new Uint8Array(e.target.result); const wb=XLSX.read(d,{type:'array'}); const j=XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]],{header:1}); let c=0; for(let i=1;i<j.length;i++){ if(j[i][0] && c<this.bulkInput.length) { this.bulkInput[c]=String(j[i][0]).toUpperCase().trim(); c++; } } }; r.readAsArrayBuffer(f); },
                async saveBulkStudents() { const n=this.bulkInput.filter(x=>x.trim()!==''); if(n.length===0) return; this.isLoading=true; const b=writeBatch(db); n.forEach(x=>{ b.set(doc(collection(db,"data_absensi")), {nama:x, kelas:this.selectedClass, status:'H', ket_susulan:''}); }); await b.commit(); this.bulkInput.fill(''); this.isLoading=false; },
                clearBulk() { this.bulkInput.fill(''); },
                viewArchive(a) { this.viewArchiveModal=JSON.parse(JSON.stringify(a)); },
                async updateArchiveData() { if(!this.viewArchiveModal) return; try { await updateDoc(doc(db,"history_absensi",this.viewArchiveModal.id), {records:this.viewArchiveModal.records}); this.viewArchiveModal=null; } catch(e){alert(e.message);} },
                async deleteArchive(id) { if(confirm("Hapus?")) await deleteDoc(doc(db,"history_absensi",id)); },
                handleLogoUpload(ev) { const f=ev.target.files[0]; if(f) { const r=new FileReader(); r.onload=e=>{this.sekolah.logoBase64=e.target.result; this.sekolah.logoPreview=e.target.result;}; r.readAsDataURL(f); } },
                countStatus(r, s) { return r.filter(x=>x.status===s).length; },
                formatDate(iso) { return new Date(iso).toLocaleDateString('id-ID'); },
                updateStats() { this.stats.total=this.allStudents.length; this.stats.hadir=this.allStudents.filter(s=>s.status==='H').length; this.stats.absen=this.stats.total-this.stats.hadir; },
                renderChart() { const c=document.getElementById('attendanceChart'); if(c){ if(this.chartInstance) this.chartInstance.destroy(); this.chartInstance=new Chart(c,{type:'doughnut',data:{labels:['Hadir','Tidak'],datasets:[{data:[this.stats.hadir,this.stats.absen],backgroundColor:['#16a34a','#dc2626']}]}}); } }
            }
        }).mount('#app');
    </script>
</body>
</html>
